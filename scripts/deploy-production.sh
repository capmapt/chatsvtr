#!/bin/bash

# ChatSVTR Production Deployment Script
# ç”± Deploy Manager ä»£ç†è°ƒç”¨

set -e

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥ç¯å¢ƒå˜é‡
check_env() {
    log_info "æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."
    
    if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
        log_error "CLOUDFLARE_API_TOKEN æœªè®¾ç½®"
        exit 1
    fi
    
    if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
        log_error "CLOUDFLARE_ACCOUNT_ID æœªè®¾ç½®"
        exit 1
    fi
    
    log_success "ç¯å¢ƒå˜é‡æ£€æŸ¥å®Œæˆ"
}

# å›æ»šéƒ¨ç½²
rollback_deployment() {
    log_info "å¼€å§‹å›æ»šéƒ¨ç½²..."
    
    # è·å–æœ€è¿‘çš„éƒ¨ç½²ID
    log_info "è·å–éƒ¨ç½²å†å²..."
    LATEST_ID=$(wrangler pages deployment list --project-name=chatsvtr --limit=2 --format=json | jq -r '.[1].id' 2>/dev/null)
    
    if [ -z "$LATEST_ID" ] || [ "$LATEST_ID" = "null" ]; then
        log_error "æ— æ³•è·å–ä¸Šä¸€ä¸ªéƒ¨ç½²ID"
        exit 1
    fi
    
    log_info "å›æ»šåˆ°éƒ¨ç½²: $LATEST_ID"
    wrangler pages deployment rollback $LATEST_ID --project-name=chatsvtr
    
    log_success "å›æ»šå®Œæˆï¼"
    log_info "ç”Ÿäº§URL: https://chatsvtr.pages.dev"
}

# æ–°éƒ¨ç½²
new_deployment() {
    log_info "å¼€å§‹æ–°éƒ¨ç½²..."
    
    # æ£€æŸ¥GitçŠ¶æ€
    if [ -n "$(git status --porcelain)" ]; then
        log_warning "å·¥ä½œç›®å½•æœ‰æœªæäº¤çš„æ›´æ”¹"
        read -p "æ˜¯å¦ç»§ç»­éƒ¨ç½²? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "éƒ¨ç½²å·²å–æ¶ˆ"
            exit 0
        fi
    fi
    
    # è¿è¡Œæµ‹è¯•
    log_info "è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
    npm run lint:check || {
        log_error "ä»£ç é£æ ¼æ£€æŸ¥å¤±è´¥"
        exit 1
    }
    
    log_info "è¿è¡Œå•å…ƒæµ‹è¯•..."
    npm run test:unit || {
        log_error "å•å…ƒæµ‹è¯•å¤±è´¥"
        exit 1
    }
    
    # æ„å»ºé¡¹ç›®
    log_info "æ„å»ºå’Œä¼˜åŒ–é¡¹ç›®..."
    npm run optimize:all || {
        log_error "æ„å»ºå¤±è´¥"
        exit 1
    }
    
    # éƒ¨ç½²åˆ° Cloudflare Pages
    log_info "éƒ¨ç½²åˆ° Cloudflare Pages..."
    wrangler pages deploy . --project-name=chatsvtr --branch=main || {
        log_error "éƒ¨ç½²å¤±è´¥"
        exit 1
    }
    
    log_success "éƒ¨ç½²å®Œæˆï¼"
    log_info "ç”Ÿäº§URL: https://chatsvtr.pages.dev"
    
    # åˆ›å»ºéƒ¨ç½²æ‘˜è¦
    create_deployment_summary
}

# åˆ›å»ºéƒ¨ç½²æ‘˜è¦
create_deployment_summary() {
    local SUMMARY_FILE="deployment-summary.md"
    
    cat > $SUMMARY_FILE << EOF
# ğŸš€ ChatSVTR éƒ¨ç½²æ‘˜è¦

## éƒ¨ç½²ä¿¡æ¯
- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
- **åˆ†æ”¯**: $(git branch --show-current)
- **æäº¤**: $(git rev-parse --short HEAD)
- **æäº¤ä¿¡æ¯**: $(git log -1 --pretty=format:'%s')

## è´¨é‡æ£€æŸ¥
- âœ… ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡
- âœ… å•å…ƒæµ‹è¯•é€šè¿‡ 
- âœ… é¡¹ç›®æ„å»ºæˆåŠŸ
- âœ… èµ„æºä¼˜åŒ–å®Œæˆ

## éƒ¨ç½²ç»“æœ
- ğŸŒ **ç”Ÿäº§URL**: https://chatsvtr.pages.dev
- ğŸ“Š **é¡¹ç›®å**: chatsvtr
- ğŸ”§ **å¹³å°**: Cloudflare Pages

## ä¸‹æ­¥å»ºè®®
1. è¿è¡Œ E2E æµ‹è¯•éªŒè¯éƒ¨ç½²
2. æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½
3. ç›‘æ§é”™è¯¯å’Œæ€§èƒ½æŒ‡æ ‡

---
ğŸ¤– Generated by Deploy Manager Agent
EOF

    log_info "éƒ¨ç½²æ‘˜è¦å·²ä¿å­˜åˆ°: $SUMMARY_FILE"
    
    # å¦‚æœåœ¨ GitHub Actions ç¯å¢ƒä¸­ï¼Œè¿½åŠ åˆ° GITHUB_STEP_SUMMARY
    if [ -n "$GITHUB_STEP_SUMMARY" ]; then
        cat $SUMMARY_FILE >> $GITHUB_STEP_SUMMARY
    fi
}

# ä¸»å‡½æ•°
main() {
    log_info "ğŸš€ ChatSVTR Deploy Manager å¯åŠ¨"
    echo "=================================================="
    
    # æ£€æŸ¥ç¯å¢ƒ
    check_env
    
    # æ ¹æ®å‚æ•°å†³å®šæ“ä½œ
    if [ "$1" = "rollback" ]; then
        rollback_deployment
    else
        new_deployment
    fi
    
    echo "=================================================="
    log_success "Deploy Manager æ‰§è¡Œå®Œæˆï¼"
}

# è„šæœ¬å…¥å£
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi