/**
 * SVTRÁî®Êà∑Ë°å‰∏∫Ë∑üË∏™Á≥ªÁªü
 * ÁõëÊµãÈ°µÈù¢ËÆøÈóÆÊó∂Èïø„ÄÅÁî®Êà∑Êìç‰ΩúË°å‰∏∫„ÄÅ‰ºöËØùÊï∞ÊçÆ
 * ‰∏∫ÁÆ°ÁêÜ‰∏≠ÂøÉÊèê‰æõËØ¶ÁªÜÁöÑÁî®Êà∑Ë°å‰∏∫ÂàÜÊûê
 */

class SVTRUserBehaviorTracker {
  constructor() {
    this.sessionId = this.generateSessionId();
    this.userId = this.getCurrentUserId();
    this.pageStartTime = Date.now();
    this.isActive = true;
    
    // Ë°å‰∏∫Êï∞ÊçÆÁºìÂ≠ò
    this.behaviorCache = [];
    this.scrollData = { maxDepth: 0, milestones: [] };
    this.clickHeatmap = new Map();
    
    // ÈÖçÁΩÆÈÄâÈ°π
    this.config = {
      batchSize: 10,
      flushInterval: 30000, // 30Áßí
      trackScrollDepth: true,
      trackClickHeatmap: true,
      trackFormInteractions: true,
      trackPagePerformance: true
    };

    this.init();
  }

  /**
   * ÂàùÂßãÂåñË∑üË∏™Á≥ªÁªü
   */
  init() {
    this.setupPageTracking();
    this.setupUserInteractionTracking();
    this.setupPerformanceTracking();
    this.setupBehaviorDataFlush();
    this.setupVisibilityTracking();
    
    console.log('üîç SVTRÁî®Êà∑Ë°å‰∏∫Ë∑üË∏™Á≥ªÁªüÂ∑≤ÂêØÂä®', {
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: new Date().toISOString()
    });
  }

  /**
   * ÁîüÊàêÂîØ‰∏Ä‰ºöËØùID
   */
  generateSessionId() {
    return 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
  }

  /**
   * Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ID
   */
  getCurrentUserId() {
    try {
      const userStr = localStorage.getItem('svtr_user');
      if (userStr) {
        const user = JSON.parse(userStr);
        return user.id || 'anonymous';
      }
    } catch (error) {
      console.warn('Ëé∑ÂèñÁî®Êà∑IDÂ§±Ë¥•:', error);
    }
    return 'anonymous_' + Date.now();
  }

  /**
   * ËÆæÁΩÆÈ°µÈù¢Ë∑üË∏™
   */
  setupPageTracking() {
    // È°µÈù¢Âä†ËΩΩÂÆåÊàê‰∫ã‰ª∂
    window.addEventListener('load', () => {
      this.trackPageLoad();
    });

    // È°µÈù¢Âç∏ËΩΩ‰∫ã‰ª∂ - ËÆ∞ÂΩïÂÅúÁïôÊó∂Èó¥
    window.addEventListener('beforeunload', () => {
      this.trackPageUnload();
    });

    // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        this.trackPageHide();
      } else {
        this.trackPageShow();
      }
    });

    // ËÆ∞ÂΩïÈ°µÈù¢ËßÜÂõæ
    this.trackPageView();
  }

  /**
   * ËÆæÁΩÆÁî®Êà∑‰∫§‰∫íË∑üË∏™
   */
  setupUserInteractionTracking() {
    // ÁÇπÂáª‰∫ã‰ª∂Ë∑üË∏™
    if (this.config.trackClickHeatmap) {
      document.addEventListener('click', (e) => {
        this.trackClick(e);
      }, { passive: true });
    }

    // ÊªöÂä®Ê∑±Â∫¶Ë∑üË∏™
    if (this.config.trackScrollDepth) {
      let scrollTimer = null;
      window.addEventListener('scroll', () => {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
          this.trackScrollDepth();
        }, 100);
      }, { passive: true });
    }

    // Ë°®Âçï‰∫§‰∫íË∑üË∏™
    if (this.config.trackFormInteractions) {
      document.addEventListener('submit', (e) => {
        this.trackFormSubmission(e);
      });

      document.addEventListener('focusin', (e) => {
        if (e.target.matches('input, textarea, select')) {
          this.trackFormFieldFocus(e);
        }
      });
    }

    // ÈìæÊé•ÁÇπÂáªË∑üË∏™
    document.addEventListener('click', (e) => {
      if (e.target.matches('a, a *')) {
        const link = e.target.closest('a');
        if (link) {
          this.trackLinkClick(link);
        }
      }
    });
  }

  /**
   * ËÆæÁΩÆÊÄßËÉΩË∑üË∏™
   */
  setupPerformanceTracking() {
    if (!this.config.trackPagePerformance) return;

    // È°µÈù¢ÊÄßËÉΩÊåáÊ†á
    window.addEventListener('load', () => {
      setTimeout(() => {
        this.trackPagePerformance();
      }, 1000);
    });
  }

  /**
   * ËÆæÁΩÆÊï∞ÊçÆÊâπÈáèÂèëÈÄÅ
   */
  setupBehaviorDataFlush() {
    // ÂÆöÊó∂ÂèëÈÄÅÊï∞ÊçÆ
    setInterval(() => {
      this.flushBehaviorData();
    }, this.config.flushInterval);

    // È°µÈù¢Âç∏ËΩΩÊó∂ÂèëÈÄÅÂâ©‰ΩôÊï∞ÊçÆ
    window.addEventListener('beforeunload', () => {
      this.flushBehaviorData(true);
    });
  }

  /**
   * ËÆæÁΩÆÈ°µÈù¢ÂèØËßÅÊÄßË∑üË∏™
   */
  setupVisibilityTracking() {
    let activeTime = 0;
    let lastActiveTime = Date.now();

    const updateActiveTime = () => {
      if (this.isActive) {
        const now = Date.now();
        activeTime += now - lastActiveTime;
        lastActiveTime = now;
      }
    };

    // Èº†Ê†áÁßªÂä®Ë°®Á§∫Áî®Êà∑Ê¥ªË∑É
    let mouseTimer = null;
    document.addEventListener('mousemove', () => {
      this.isActive = true;
      clearTimeout(mouseTimer);
      mouseTimer = setTimeout(() => {
        updateActiveTime();
        this.isActive = false;
      }, 5000); // 5ÁßíÊó†Êìç‰ΩúËßÜ‰∏∫‰∏çÊ¥ªË∑É
    }, { passive: true });

    // ÂÆöÊúüÊõ¥Êñ∞Ê¥ªË∑ÉÊó∂Èó¥
    setInterval(updateActiveTime, 1000);

    // ‰øùÂ≠òÊ¥ªË∑ÉÊó∂Èó¥Âà∞‰ºöËØùÊï∞ÊçÆ
    this.getActiveTime = () => activeTime;
  }

  /**
   * Ë∑üË∏™È°µÈù¢ËßÜÂõæ
   */
  trackPageView() {
    const pageData = {
      type: 'page_view',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      page: {
        url: window.location.href,
        path: window.location.pathname,
        title: document.title,
        referrer: document.referrer || 'direct'
      },
      device: {
        userAgent: navigator.userAgent,
        screen: {
          width: screen.width,
          height: screen.height,
          availWidth: screen.availWidth,
          availHeight: screen.availHeight
        },
        viewport: {
          width: window.innerWidth,
          height: window.innerHeight
        }
      }
    };

    this.addToBehaviorCache(pageData);
  }

  /**
   * Ë∑üË∏™È°µÈù¢Âä†ËΩΩ
   */
  trackPageLoad() {
    const loadData = {
      type: 'page_load',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      page: {
        url: window.location.href,
        path: window.location.pathname
      },
      timing: {
        loadComplete: Date.now() - this.pageStartTime
      }
    };

    this.addToBehaviorCache(loadData);
  }

  /**
   * Ë∑üË∏™È°µÈù¢Âç∏ËΩΩ
   */
  trackPageUnload() {
    const duration = Date.now() - this.pageStartTime;
    const activeTime = this.getActiveTime();
    
    const unloadData = {
      type: 'page_unload',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      page: {
        url: window.location.href,
        path: window.location.pathname
      },
      timing: {
        totalDuration: duration,
        activeDuration: activeTime,
        engagementRate: (activeTime / duration * 100).toFixed(2)
      },
      scrollData: this.scrollData,
      clickCount: Array.from(this.clickHeatmap.values()).reduce((sum, count) => sum + count, 0)
    };

    this.addToBehaviorCache(unloadData);
    this.flushBehaviorData(true); // Âº∫Âà∂ÂèëÈÄÅÊï∞ÊçÆ
  }

  /**
   * Ë∑üË∏™ÁÇπÂáª‰∫ã‰ª∂
   */
  trackClick(event) {
    const target = event.target;
    const rect = target.getBoundingClientRect();
    const clickPosition = {
      x: Math.round(event.clientX),
      y: Math.round(event.clientY),
      relativeX: Math.round(event.clientX - rect.left),
      relativeY: Math.round(event.clientY - rect.top)
    };

    // ÁîüÊàêÁÉ≠ÂäõÂõæÊï∞ÊçÆ
    const heatmapKey = `${Math.floor(clickPosition.x / 50)}_${Math.floor(clickPosition.y / 50)}`;
    this.clickHeatmap.set(heatmapKey, (this.clickHeatmap.get(heatmapKey) || 0) + 1);

    const clickData = {
      type: 'click',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      target: {
        tagName: target.tagName.toLowerCase(),
        id: target.id || null,
        className: target.className || null,
        text: target.textContent?.trim().substring(0, 100) || null,
        href: target.href || null
      },
      position: clickPosition,
      page: {
        url: window.location.href,
        path: window.location.pathname
      }
    };

    this.addToBehaviorCache(clickData);
  }

  /**
   * Ë∑üË∏™ÊªöÂä®Ê∑±Â∫¶
   */
  trackScrollDepth() {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const windowHeight = window.innerHeight;
    const documentHeight = Math.max(
      document.body.scrollHeight,
      document.body.offsetHeight,
      document.documentElement.clientHeight,
      document.documentElement.scrollHeight,
      document.documentElement.offsetHeight
    );

    const scrollPercent = Math.round((scrollTop + windowHeight) / documentHeight * 100);
    
    if (scrollPercent > this.scrollData.maxDepth) {
      this.scrollData.maxDepth = scrollPercent;
      
      // ËÆ∞ÂΩïÈáçË¶ÅÁöÑÊªöÂä®ÈáåÁ®ãÁ¢ë
      const milestones = [25, 50, 75, 90, 100];
      for (const milestone of milestones) {
        if (scrollPercent >= milestone && !this.scrollData.milestones.includes(milestone)) {
          this.scrollData.milestones.push(milestone);
          
          const scrollMilestoneData = {
            type: 'scroll_milestone',
            sessionId: this.sessionId,
            userId: this.userId,
            timestamp: Date.now(),
            milestone: milestone,
            page: {
              url: window.location.href,
              path: window.location.pathname
            }
          };
          
          this.addToBehaviorCache(scrollMilestoneData);
        }
      }
    }
  }

  /**
   * Ë∑üË∏™Ë°®ÂçïÊèê‰∫§
   */
  trackFormSubmission(event) {
    const form = event.target;
    const formData = {
      type: 'form_submit',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      form: {
        id: form.id || null,
        className: form.className || null,
        action: form.action || null,
        method: form.method || 'get',
        fieldCount: form.querySelectorAll('input, textarea, select').length
      },
      page: {
        url: window.location.href,
        path: window.location.pathname
      }
    };

    this.addToBehaviorCache(formData);
  }

  /**
   * Ë∑üË∏™Ë°®ÂçïÂ≠óÊÆµËÅöÁÑ¶
   */
  trackFormFieldFocus(event) {
    const field = event.target;
    const fieldData = {
      type: 'form_field_focus',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      field: {
        tagName: field.tagName.toLowerCase(),
        type: field.type || null,
        id: field.id || null,
        name: field.name || null,
        placeholder: field.placeholder || null
      },
      page: {
        url: window.location.href,
        path: window.location.pathname
      }
    };

    this.addToBehaviorCache(fieldData);
  }

  /**
   * Ë∑üË∏™ÈìæÊé•ÁÇπÂáª
   */
  trackLinkClick(link) {
    const linkData = {
      type: 'link_click',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      link: {
        href: link.href,
        text: link.textContent?.trim().substring(0, 100) || null,
        target: link.target || null,
        isExternal: link.hostname !== window.location.hostname
      },
      page: {
        url: window.location.href,
        path: window.location.pathname
      }
    };

    this.addToBehaviorCache(linkData);
  }

  /**
   * Ë∑üË∏™È°µÈù¢ÊÄßËÉΩ
   */
  trackPagePerformance() {
    if (!window.performance || !window.performance.timing) {
      return;
    }

    const timing = window.performance.timing;
    const navigation = window.performance.navigation;

    const performanceData = {
      type: 'page_performance',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      performance: {
        navigationStart: timing.navigationStart,
        domainLookup: timing.domainLookupEnd - timing.domainLookupStart,
        connect: timing.connectEnd - timing.connectStart,
        request: timing.responseEnd - timing.requestStart,
        response: timing.responseEnd - timing.responseStart,
        domReady: timing.domContentLoadedEventEnd - timing.navigationStart,
        loadComplete: timing.loadEventEnd - timing.navigationStart,
        navigationType: navigation.type,
        redirectCount: navigation.redirectCount
      },
      page: {
        url: window.location.href,
        path: window.location.pathname
      }
    };

    this.addToBehaviorCache(performanceData);
  }

  /**
   * Ë∑üË∏™È°µÈù¢ÈöêËóè
   */
  trackPageHide() {
    const hideData = {
      type: 'page_hide',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      page: {
        url: window.location.href,
        path: window.location.pathname
      }
    };

    this.addToBehaviorCache(hideData);
  }

  /**
   * Ë∑üË∏™È°µÈù¢ÊòæÁ§∫
   */
  trackPageShow() {
    const showData = {
      type: 'page_show',
      sessionId: this.sessionId,
      userId: this.userId,
      timestamp: Date.now(),
      page: {
        url: window.location.href,
        path: window.location.pathname
      }
    };

    this.addToBehaviorCache(showData);
  }

  /**
   * Ê∑ªÂä†Êï∞ÊçÆÂà∞ÁºìÂ≠ò
   */
  addToBehaviorCache(data) {
    this.behaviorCache.push(data);
    
    // ÁºìÂ≠òËææÂà∞ÊâπÈáèÂ§ßÂ∞èÊó∂Ëá™Âä®ÂèëÈÄÅ
    if (this.behaviorCache.length >= this.config.batchSize) {
      this.flushBehaviorData();
    }
  }

  /**
   * ÂèëÈÄÅË°å‰∏∫Êï∞ÊçÆÂà∞ÊúçÂä°Âô®
   */
  async flushBehaviorData(force = false) {
    if (this.behaviorCache.length === 0) {
      return;
    }

    const dataToSend = [...this.behaviorCache];
    this.behaviorCache = []; // Ê∏ÖÁ©∫ÁºìÂ≠ò

    try {
      // Â¶ÇÊûúÊòØÂº∫Âà∂ÂèëÈÄÅÔºàÈ°µÈù¢Âç∏ËΩΩÔºâÔºå‰ΩøÁî®sendBeacon
      if (force && navigator.sendBeacon) {
        const blob = new Blob([JSON.stringify(dataToSend)], {
          type: 'application/json'
        });
        navigator.sendBeacon('/api/user-behavior', blob);
        console.log('üìä Áî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÂ∑≤ÈÄöËøáBeaconÂèëÈÄÅ:', dataToSend.length, 'Êù°');
        return;
      }

      // Ê≠£Â∏∏ÁöÑfetchËØ∑Ê±Ç
      const response = await fetch('/api/user-behavior', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataToSend)
      });

      if (response.ok) {
        console.log('üìä Áî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÂèëÈÄÅÊàêÂäü:', dataToSend.length, 'Êù°');
      } else {
        throw new Error('ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ');
      }

    } catch (error) {
      console.warn('üìä Áî®Êà∑Ë°å‰∏∫Êï∞ÊçÆÂèëÈÄÅÂ§±Ë¥•:', error);
      
      // ÂèëÈÄÅÂ§±Ë¥•Êó∂ÔºåÂ∞ÜÊï∞ÊçÆÂ≠òÂÇ®Âà∞Êú¨Âú∞ÁºìÂ≠ò
      this.saveToLocalStorage(dataToSend);
    }
  }

  /**
   * ‰øùÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
   */
  saveToLocalStorage(data) {
    try {
      const existingData = JSON.parse(localStorage.getItem('svtr_behavior_cache') || '[]');
      const combinedData = existingData.concat(data);
      
      // ÈôêÂà∂Êú¨Âú∞ÁºìÂ≠òÂ§ßÂ∞èÔºåÂè™‰øùÁïôÊúÄÊñ∞1000Êù°
      const limitedData = combinedData.slice(-1000);
      
      localStorage.setItem('svtr_behavior_cache', JSON.stringify(limitedData));
      console.log('üìä Ë°å‰∏∫Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞ÁºìÂ≠ò');
    } catch (error) {
      console.warn('Êú¨Âú∞ÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:', error);
    }
  }

  /**
   * ÂèëÈÄÅÊú¨Âú∞ÁºìÂ≠òÁöÑÊï∞ÊçÆ
   */
  async sendCachedData() {
    try {
      const cachedData = JSON.parse(localStorage.getItem('svtr_behavior_cache') || '[]');
      if (cachedData.length === 0) {
        return;
      }

      const response = await fetch('/api/user-behavior', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(cachedData)
      });

      if (response.ok) {
        localStorage.removeItem('svtr_behavior_cache');
        console.log('üìä Êú¨Âú∞ÁºìÂ≠òÊï∞ÊçÆÂèëÈÄÅÊàêÂäü:', cachedData.length, 'Êù°');
      }

    } catch (error) {
      console.warn('Êú¨Âú∞ÁºìÂ≠òÊï∞ÊçÆÂèëÈÄÅÂ§±Ë¥•:', error);
    }
  }

  /**
   * Ëé∑ÂèñÂΩìÂâç‰ºöËØùÁªüËÆ°
   */
  getSessionStats() {
    const duration = Date.now() - this.pageStartTime;
    const activeTime = this.getActiveTime();
    
    return {
      sessionId: this.sessionId,
      userId: this.userId,
      duration: duration,
      activeTime: activeTime,
      engagementRate: (activeTime / duration * 100).toFixed(2),
      pageViews: this.behaviorCache.filter(item => item.type === 'page_view').length,
      clicks: Array.from(this.clickHeatmap.values()).reduce((sum, count) => sum + count, 0),
      maxScrollDepth: this.scrollData.maxDepth,
      scrollMilestones: this.scrollData.milestones.length
    };
  }

  /**
   * Ëé∑ÂèñÁÇπÂáªÁÉ≠ÂäõÂõæÊï∞ÊçÆ
   */
  getClickHeatmapData() {
    const heatmapData = [];
    for (const [key, count] of this.clickHeatmap) {
      const [x, y] = key.split('_').map(Number);
      heatmapData.push({
        x: x * 50 + 25, // ÊÅ¢Â§çÂà∞ÂÆûÈôÖÂùêÊ†á
        y: y * 50 + 25,
        count: count
      });
    }
    return heatmapData;
  }
}

// ÂàõÂª∫ÂÖ®Â±ÄÂÆû‰æã
let svtrBehaviorTracker = null;

// DOMÂä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
  svtrBehaviorTracker = new SVTRUserBehaviorTracker();
  
  // Â∞ÜÂÆû‰æãÊö¥Èú≤ÁªôÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰æø‰∫éË∞ÉËØïÂíåÂÖ∂‰ªñÊ®°Âùó‰ΩøÁî®
  window.svtrBehaviorTracker = svtrBehaviorTracker;
  
  // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂ∞ùËØïÂèëÈÄÅÁºìÂ≠òÊï∞ÊçÆ
  window.addEventListener('load', () => {
    setTimeout(() => {
      svtrBehaviorTracker.sendCachedData();
    }, 2000);
  });
});

// ÂØºÂá∫Á±ª‰æõÂÖ∂‰ªñÊ®°Âùó‰ΩøÁî®
if (typeof module !== 'undefined' && module.exports) {
  module.exports = SVTRUserBehaviorTracker;
}