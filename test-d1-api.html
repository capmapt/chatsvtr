<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D1 APIæµ‹è¯• - SVTR</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #188df0;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #188df0;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #1570c4;
    }
    .results {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #188df0;
      max-height: 500px;
      overflow-y: auto;
    }
    .article-card {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }
    .article-card h3 {
      margin: 0 0 10px 0;
      color: #188df0;
    }
    .article-card .meta {
      color: #666;
      font-size: 13px;
      margin-top: 10px;
    }
    .meta span {
      margin-right: 15px;
    }
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .error {
      color: #d32f2f;
      padding: 10px;
      background: #ffebee;
      border-radius: 4px;
    }
    .success {
      color: #388e3c;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 4px;
    }
    .loading {
      color: #1976d2;
      padding: 10px;
    }
    input, select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª D1æ•°æ®åº“APIæµ‹è¯•å·¥å…·</h1>

  <!-- æ–°å¢: é€šç”¨æŸ¥è¯¢APIæµ‹è¯• -->
  <div class="section">
    <h2>ğŸ†• é€šç”¨D1æŸ¥è¯¢API</h2>
    <p>GET /api/d1/query</p>

    <div>
      <label>è¡¨å: </label>
      <select id="queryTable">
        <option value="knowledge_base_nodes">knowledge_base_nodes</option>
        <option value="companies">companies</option>
        <option value="investors">investors</option>
        <option value="published_articles">published_articles</option>
      </select>

      <label>æ•°é‡: </label>
      <input type="number" id="queryLimit" value="10" min="1" max="100" style="width: 60px;">

      <label>æ’åºå­—æ®µ: </label>
      <input type="text" id="queryOrderBy" placeholder="id" style="width: 120px;">

      <button onclick="testUniversalQuery()">æµ‹è¯•é€šç”¨æŸ¥è¯¢</button>
      <button onclick="testPopularArticles()">çƒ­é—¨æ–‡ç« è§†å›¾</button>
      <button onclick="testFundingRanking()">èèµ„æ’è¡Œæ¦œ</button>
    </div>

    <div id="queryResults" class="results"></div>
  </div>

  <!-- æµ‹è¯•1: æ–‡ç« åˆ—è¡¨ -->
  <div class="section">
    <h2>1. æµ‹è¯•æ–‡ç« åˆ—è¡¨API</h2>
    <p>GET /api/articles</p>

    <div>
      <label>åˆ†ç±»: </label>
      <select id="categoryFilter">
        <option value="">å…¨éƒ¨</option>
        <option value="AIåˆ›æŠ•è§‚å¯Ÿ">AIåˆ›æŠ•è§‚å¯Ÿ</option>
        <option value="æŠ€æœ¯æ·±åº¦">æŠ€æœ¯æ·±åº¦</option>
        <option value="è¡Œä¸šæŠ¥å‘Š">è¡Œä¸šæŠ¥å‘Š</option>
        <option value="ç»¼åˆåˆ†æ">ç»¼åˆåˆ†æ</option>
      </select>

      <label>æ¯é¡µ: </label>
      <input type="number" id="limitInput" value="10" min="1" max="100" style="width: 60px;">

      <label>æ’åº: </label>
      <select id="sortFilter">
        <option value="date">æœ€æ–°å‘å¸ƒ</option>
        <option value="views">æœ€å¤šæµè§ˆ</option>
        <option value="featured">ç²¾é€‰ä¼˜å…ˆ</option>
      </select>

      <button onclick="testArticleList()">æµ‹è¯•æ–‡ç« åˆ—è¡¨</button>
      <button onclick="testArticleListJSON()">æŸ¥çœ‹JSONå“åº”</button>
    </div>

    <div id="articleListResults" class="results"></div>
  </div>

  <!-- æµ‹è¯•2: æ–‡ç« è¯¦æƒ… -->
  <div class="section">
    <h2>2. æµ‹è¯•æ–‡ç« è¯¦æƒ…API</h2>
    <p>GET /api/articles/:slug</p>

    <div>
      <label>æ–‡ç« Slug: </label>
      <input type="text" id="slugInput" placeholder="ä¾‹å¦‚: aiåˆ›æŠ•è§‚å¯Ÿä¸¨2025-q3-StZ4wqMc" style="width: 300px;">
      <button onclick="testArticleDetail()">æµ‹è¯•æ–‡ç« è¯¦æƒ…</button>
      <button onclick="testArticleDetailJSON()">æŸ¥çœ‹JSONå“åº”</button>
    </div>

    <div id="articleDetailResults" class="results"></div>
  </div>

  <!-- æµ‹è¯•3: æ•°æ®åº“çŠ¶æ€ -->
  <div class="section">
    <h2>3. æ•°æ®åº“çŠ¶æ€æ£€æŸ¥</h2>
    <button onclick="checkDatabaseStatus()">æ£€æŸ¥æ•°æ®åº“è¿æ¥</button>
    <button onclick="checkTableCounts()">æŸ¥çœ‹æ•°æ®ç»Ÿè®¡</button>

    <div id="statusResults" class="results"></div>
  </div>

  <script>
    // åŸºç¡€URLï¼ˆæ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©ï¼‰
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000'
      : 'https://svtr.ai';

    /**
     * æµ‹è¯•æ–‡ç« åˆ—è¡¨ï¼ˆæ¸²æŸ“HTMLï¼‰
     */
    async function testArticleList() {
      const results = document.getElementById('articleListResults');
      results.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      const category = document.getElementById('categoryFilter').value;
      const limit = document.getElementById('limitInput').value;
      const sort = document.getElementById('sortFilter').value;

      const params = new URLSearchParams({
        ...(category && { category }),
        limit,
        sort
      });

      try {
        const response = await fetch(`${API_BASE}/api/articles?${params}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        }

        const { articles, pagination } = data.data;

        let html = `<div class="success">æˆåŠŸè·å– ${articles.length} ç¯‡æ–‡ç« ï¼ˆå…± ${pagination.total} ç¯‡ï¼‰</div>`;

        articles.forEach(article => {
          html += `
            <div class="article-card">
              <h3>${article.meta_title}</h3>
              <p>${article.content_summary || article.meta_description || 'æš‚æ— æ‘˜è¦'}</p>
              <div class="meta">
                <span>ğŸ“ ${article.category}</span>
                <span>ğŸ“… ${article.publish_date}</span>
                <span>ğŸ‘ ${article.view_count} é˜…è¯»</span>
                <span>ğŸ”— <code>${article.slug}</code></span>
              </div>
            </div>
          `;
        });

        html += `
          <div class="meta" style="margin-top: 15px;">
            åˆ†é¡µ: ç¬¬ ${pagination.currentPage} / ${pagination.totalPages} é¡µ
            ${pagination.hasMore ? '<span>ï¼ˆè¿˜æœ‰æ›´å¤šï¼‰</span>' : '<span>ï¼ˆå·²å…¨éƒ¨åŠ è½½ï¼‰</span>'}
          </div>
        `;

        results.innerHTML = html;

        // è‡ªåŠ¨å¡«å……ç¬¬ä¸€ç¯‡æ–‡ç« çš„slugåˆ°è¯¦æƒ…æµ‹è¯•
        if (articles.length > 0) {
          document.getElementById('slugInput').value = articles[0].slug;
        }

      } catch (error) {
        results.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
      }
    }

    /**
     * æµ‹è¯•æ–‡ç« åˆ—è¡¨ï¼ˆæŸ¥çœ‹JSONï¼‰
     */
    async function testArticleListJSON() {
      const results = document.getElementById('articleListResults');
      results.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      const category = document.getElementById('categoryFilter').value;
      const limit = document.getElementById('limitInput').value;
      const sort = document.getElementById('sortFilter').value;

      const params = new URLSearchParams({
        ...(category && { category }),
        limit,
        sort
      });

      try {
        const response = await fetch(`${API_BASE}/api/articles?${params}`);
        const data = await response.json();

        results.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

      } catch (error) {
        results.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
      }
    }

    /**
     * æµ‹è¯•æ–‡ç« è¯¦æƒ…ï¼ˆæ¸²æŸ“HTMLï¼‰
     */
    async function testArticleDetail() {
      const results = document.getElementById('articleDetailResults');
      const slug = document.getElementById('slugInput').value.trim();

      if (!slug) {
        results.innerHTML = '<div class="error">è¯·è¾“å…¥æ–‡ç« slug</div>';
        return;
      }

      results.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/articles/${slug}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'æ–‡ç« æœªæ‰¾åˆ°');
        }

        const { article, related } = data.data;

        let html = `
          <div class="success">æˆåŠŸè·å–æ–‡ç« è¯¦æƒ…</div>
          <div class="article-card">
            <h3>${article.meta_title || article.title}</h3>
            <div class="meta">
              <span>ğŸ“ ${article.category}</span>
              <span>ğŸ“… ${article.publish_date}</span>
              <span>ğŸ‘ ${article.view_count} é˜…è¯»</span>
              <span>â¤ï¸ ${article.like_count} ç‚¹èµ</span>
              <span>ğŸ“Š RAGåˆ†æ•°: ${article.rag_score.toFixed(2)}</span>
            </div>
            <h4>æ ‡ç­¾:</h4>
            <p>${article.tags.map(tag => `<span style="background:#e3f2fd;padding:4px 8px;margin:0 4px;border-radius:4px;">${tag}</span>`).join('')}</p>
            <h4>å†…å®¹é¢„è§ˆ:</h4>
            <div style="max-height:300px;overflow-y:auto;padding:10px;background:#fafafa;border:1px solid #eee;">
              ${article.full_content.substring(0, 1000)}...
            </div>
          </div>
        `;

        if (related.length > 0) {
          html += `<h4>ç›¸å…³æ–‡ç«  (${related.length}):</h4>`;
          related.forEach(rel => {
            html += `
              <div style="padding:8px;background:#f9f9f9;margin:5px 0;border-radius:4px;">
                <strong>${rel.meta_title}</strong>
                <span style="color:#666;margin-left:10px;">${rel.publish_date}</span>
              </div>
            `;
          });
        }

        results.innerHTML = html;

      } catch (error) {
        results.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
      }
    }

    /**
     * æµ‹è¯•æ–‡ç« è¯¦æƒ…ï¼ˆæŸ¥çœ‹JSONï¼‰
     */
    async function testArticleDetailJSON() {
      const results = document.getElementById('articleDetailResults');
      const slug = document.getElementById('slugInput').value.trim();

      if (!slug) {
        results.innerHTML = '<div class="error">è¯·è¾“å…¥æ–‡ç« slug</div>';
        return;
      }

      results.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/articles/${slug}`);
        const data = await response.json();

        results.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

      } catch (error) {
        results.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
      }
    }

    /**
     * æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
     */
    async function checkDatabaseStatus() {
      const results = document.getElementById('statusResults');
      results.innerHTML = '<div class="loading">æ£€æŸ¥ä¸­...</div>';

      try {
        // å°è¯•è°ƒç”¨API
        const response = await fetch(`${API_BASE}/api/articles?limit=1`);
        const data = await response.json();

        if (data.success) {
          results.innerHTML = `
            <div class="success">âœ… D1æ•°æ®åº“è¿æ¥æ­£å¸¸</div>
            <p>APIåŸºç¡€URL: <code>${API_BASE}</code></p>
            <p>å“åº”æ—¶é—´: <span id="responseTime"></span></p>
          `;
        } else {
          throw new Error('APIè¿”å›å¤±è´¥');
        }

      } catch (error) {
        results.innerHTML = `
          <div class="error">
            âŒ æ•°æ®åº“è¿æ¥å¤±è´¥<br>
            ${error.message}<br><br>
            å¯èƒ½åŸå› :<br>
            1. D1æ•°æ®åº“å°šæœªåˆ›å»º<br>
            2. Schemaå°šæœªæ‰§è¡Œ<br>
            3. wrangler.tomlé…ç½®æœªæ›´æ–°<br>
            4. Workersæœªéƒ¨ç½²<br>
          </div>
        `;
      }
    }

    /**
     * æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
     */
    async function checkTableCounts() {
      const results = document.getElementById('statusResults');
      results.innerHTML = '<div class="loading">ç»Ÿè®¡ä¸­...</div>';

      // æ³¨æ„ï¼šè¿™éœ€è¦ä¸“é—¨çš„ç»Ÿè®¡API endpoint
      // ç›®å‰ä½œä¸ºç¤ºä¾‹æ˜¾ç¤ºé¢„æœŸæ•°æ®
      results.innerHTML = `
        <div class="success">é¢„æœŸæ•°æ®ç»Ÿè®¡</div>
        <table style="width:100%;border-collapse:collapse;margin-top:10px;">
          <tr style="background:#f5f5f5;">
            <th style="padding:8px;border:1px solid #ddd;text-align:left;">è¡¨å</th>
            <th style="padding:8px;border:1px solid #ddd;text-align:right;">é¢„æœŸè®°å½•æ•°</th>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #ddd;">knowledge_base_nodes</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:right;">263</td>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #ddd;">knowledge_base_content</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:right;">263</td>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #ddd;">published_articles</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:right;">180-200</td>
          </tr>
          <tr>
            <td style="padding:8px;border:1px solid #ddd;">knowledge_base_relations</td>
            <td style="padding:8px;border:1px solid #ddd;text-align:right;">~100</td>
          </tr>
        </table>
        <p style="margin-top:15px;color:#666;">
          ğŸ’¡ è¦æŸ¥çœ‹å®é™…æ•°æ®ï¼Œè¯·ä½¿ç”¨ Wrangler CLI:<br>
          <code>npx wrangler d1 execute svtr-production --remote --command="SELECT COUNT(*) FROM knowledge_base_nodes"</code>
        </p>
      `;
    }

    /**
     * æµ‹è¯•é€šç”¨æŸ¥è¯¢API
     */
    async function testUniversalQuery() {
      const results = document.getElementById('queryResults');
      results.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      const table = document.getElementById('queryTable').value;
      const limit = document.getElementById('queryLimit').value;
      const orderBy = document.getElementById('queryOrderBy').value;

      const params = new URLSearchParams({
        table,
        limit,
        ...(orderBy && { order_by: orderBy })
      });

      try {
        const response = await fetch(`${API_BASE}/api/d1/query?${params}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        }

        let html = `<div class="success">æˆåŠŸè·å– ${data.data.length} æ¡è®°å½•</div>`;

        if (data.data.length > 0) {
          // æ˜¾ç¤ºè¡¨æ ¼
          const fields = Object.keys(data.data[0]).slice(0, 8); // å‰8ä¸ªå­—æ®µ
          html += `
            <table style="width:100%;border-collapse:collapse;margin-top:10px;">
              <thead>
                <tr style="background:#f5f5f5;">
                  ${fields.map(f => `<th style="padding:8px;border:1px solid #ddd;text-align:left;">${f}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${data.data.map(row => `
                  <tr>
                    ${fields.map(f => `<td style="padding:8px;border:1px solid #ddd;">${row[f] || '-'}</td>`).join('')}
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }

        if (data.pagination) {
          html += `
            <div class="meta" style="margin-top:15px;">
              åˆ†é¡µ: offset=${data.pagination.offset}, limit=${data.pagination.limit}, hasMore=${data.pagination.hasMore}
            </div>
          `;
        }

        results.innerHTML = html;

      } catch (error) {
        results.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
      }
    }

    /**
     * æµ‹è¯•çƒ­é—¨æ–‡ç« è§†å›¾
     */
    async function testPopularArticles() {
      const results = document.getElementById('queryResults');
      results.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/d1/query?view=popular_articles&limit=5`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        }

        let html = `<div class="success">çƒ­é—¨æ–‡ç« è§†å›¾: ${data.data.length} æ¡è®°å½•</div>`;

        data.data.forEach(article => {
          html += `
            <div class="article-card">
              <h3>${article.meta_title || article.title}</h3>
              <p>${article.content_summary || 'æš‚æ— æ‘˜è¦'}</p>
              <div class="meta">
                <span>ğŸ‘ ${article.view_count} é˜…è¯»</span>
                <span>ğŸ“… ${article.publish_date}</span>
              </div>
            </div>
          `;
        });

        results.innerHTML = html;

      } catch (error) {
        results.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
      }
    }

    /**
     * æµ‹è¯•èèµ„æ’è¡Œæ¦œè§†å›¾
     */
    async function testFundingRanking() {
      const results = document.getElementById('queryResults');
      results.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/d1/query?view=funding_ranking&metric=valuation&limit=10`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
        }

        let html = `<div class="success">èèµ„æ’è¡Œæ¦œ: ${data.data.length} æ¡è®°å½•</div>`;

        if (data.data.length === 0) {
          html += `<p>âš ï¸ companiesè¡¨æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œæ•°æ®åŒæ­¥è„šæœ¬</p>`;
        } else {
          data.data.forEach((company, i) => {
            html += `
              <div style="padding:10px;background:#f9f9f9;margin:5px 0;border-radius:4px;">
                <strong>${i + 1}. ${company.company_name}</strong>
                <span style="margin-left:10px;">ä¼°å€¼: $${(company.latest_valuation_usd / 1000000).toFixed(0)}M</span>
                <span style="margin-left:10px;">é˜¶æ®µ: ${company.latest_stage}</span>
              </div>
            `;
          });
        }

        results.innerHTML = html;

      } catch (error) {
        results.innerHTML = `<div class="error">é”™è¯¯: ${error.message}</div>`;
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
    window.addEventListener('DOMContentLoaded', () => {
      console.log('D1 APIæµ‹è¯•å·¥å…·å·²åŠ è½½');
      console.log('APIåŸºç¡€URL:', API_BASE);
    });
  </script>
</body>
</html>
