# D1 vs é£ä¹¦ï¼šæ•°æ®å­˜å‚¨æ¶æ„å®Œæ•´å¯¹æ¯”

## æ ¸å¿ƒé—®é¢˜ï¼šèƒ½å¦æ”¾å¼ƒé£ä¹¦ï¼Œç›´æ¥ç”¨D1ä½œä¸ºä¸»æ•°æ®æºï¼Ÿ

### ç­”æ¡ˆï¼šæŠ€æœ¯ä¸Š100%å¯è¡Œï¼Œä½†éœ€æƒè¡¡åˆ©å¼Š

---

## ä¸€ã€ä¸¤ç§æ¶æ„æ–¹æ¡ˆè¯¦ç»†å¯¹æ¯”

### æ–¹æ¡ˆAï¼šé£ä¹¦ä¸ºä¸»ï¼ŒD1ä¸ºç¼“å­˜ï¼ˆå½“å‰æ¨èï¼‰

```
æ•°æ®æµå‘ï¼š
å†…å®¹åˆ›ä½œï¼ˆé£ä¹¦åä½œç¼–è¾‘ï¼‰
    â†“ æ¯æ—¥åŒæ­¥
D1æ•°æ®åº“ï¼ˆè¯»ä¼˜åŒ–çš„å‰¯æœ¬ï¼‰
    â†“ APIæŸ¥è¯¢
å‰ç«¯ç½‘ç«™ï¼ˆå¿«é€Ÿå±•ç¤ºï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… **åä½œç¼–è¾‘ä½“éªŒå¥½**ï¼šé£ä¹¦æ–‡æ¡£æ”¯æŒå¤šäººå®æ—¶åä½œã€è¯„è®ºã€@æé†’
- âœ… **å¯Œæ–‡æœ¬ç¼–è¾‘å¼ºå¤§**ï¼šè¡¨æ ¼ã€å›¾ç‰‡ã€è§†é¢‘ã€åµŒå…¥å¼å†…å®¹
- âœ… **æƒé™ç®¡ç†å®Œå–„**ï¼šé£ä¹¦ä¼ä¸šçº§æƒé™ä½“ç³»
- âœ… **ç‰ˆæœ¬å†å²å®Œæ•´**ï¼šè‡ªåŠ¨ä¿å­˜æ¯æ¬¡ä¿®æ”¹è®°å½•
- âœ… **ç§»åŠ¨ç«¯ä½“éªŒå¥½**ï¼šé£ä¹¦Appéšæ—¶éšåœ°ç¼–è¾‘
- âœ… **æ•°æ®å¤‡ä»½å®‰å…¨**ï¼šé£ä¹¦äº‘ç«¯å¤šé‡å¤‡ä»½
- âœ… **å›¢é˜Ÿåä½œæˆæœ¬ä½**ï¼šæ— éœ€åŸ¹è®­ï¼Œå›¢é˜Ÿå·²ç†Ÿæ‚‰é£ä¹¦

**åŠ£åŠ¿**ï¼š
- âš ï¸ ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆé£ä¹¦APIç¨³å®šæ€§ï¼‰
- âš ï¸ åŒæ­¥å»¶è¿Ÿï¼ˆæœ€å¤š24å°æ—¶ï¼Œå¯é…ç½®ï¼‰
- âš ï¸ APIè°ƒç”¨é™åˆ¶ï¼ˆ8000æ¬¡/å°æ—¶ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- æœ‰å†…å®¹åˆ›ä½œå›¢é˜Ÿï¼ˆ2äººä»¥ä¸Šï¼‰
- éœ€è¦åä½œç¼–è¾‘å’Œå®¡æ‰¹æµç¨‹
- å†…å®¹æ›´æ–°é¢‘ç‡ï¼šæ¯å¤©/æ¯å‘¨
- å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼ˆå¯æ¥å—æ•°å°æ—¶å»¶è¿Ÿï¼‰

---

### æ–¹æ¡ˆBï¼šD1ä¸ºä¸»ï¼Œå®Œå…¨è„±ç¦»é£ä¹¦

```
æ•°æ®æµå‘ï¼š
è‡ªå»ºCMSåå°ï¼ˆWebç•Œé¢ï¼‰
    â†“ ç›´æ¥å†™å…¥
D1æ•°æ®åº“ï¼ˆä¸»æ•°æ®æºï¼‰
    â†“ APIæŸ¥è¯¢
å‰ç«¯ç½‘ç«™ï¼ˆå®æ—¶å±•ç¤ºï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… **å®Œå…¨è‡ªä¸»å¯æ§**ï¼šä¸ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡
- âœ… **å®æ—¶æ€§å¼º**ï¼šå†…å®¹å‘å¸ƒç«‹å³ç”Ÿæ•ˆ
- âœ… **æ— APIé™åˆ¶**ï¼šD1å…è´¹é¢åº¦è¿œè¶…éœ€æ±‚
- âœ… **æ¶æ„ç®€å•**ï¼šå‡å°‘ä¸­é—´åŒæ­¥ç¯èŠ‚
- âœ… **æˆæœ¬æ›´ä½**ï¼šæ— éœ€é£ä¹¦ä¼ä¸šç‰ˆè®¢é˜…

**åŠ£åŠ¿**ï¼š
- âŒ **éœ€è¦è‡ªå»ºCMS**ï¼šå¼€å‘æˆæœ¬3-4å‘¨
- âŒ **åä½œä½“éªŒå·®**ï¼šéœ€è‡ªå·±å®ç°å¤šäººç¼–è¾‘ã€é”å®šæœºåˆ¶
- âŒ **ç§»åŠ¨ç«¯å›°éš¾**ï¼šéœ€å¼€å‘ç§»åŠ¨ç«¯ç¼–è¾‘ç•Œé¢
- âŒ **ç‰ˆæœ¬ç®¡ç†å¤æ‚**ï¼šéœ€è‡ªå·±å®ç°å†å²ç‰ˆæœ¬
- âŒ **å¯Œæ–‡æœ¬ç¼–è¾‘å™¨**ï¼šéœ€é›†æˆç¬¬ä¸‰æ–¹ï¼ˆTinyMCEã€Quillç­‰ï¼‰
- âŒ **å›¢é˜Ÿå­¦ä¹ æˆæœ¬**ï¼šéœ€è¦åŸ¹è®­æ–°ç³»ç»Ÿ

**é€‚ç”¨åœºæ™¯**ï¼š
- å•äººæˆ–å°å›¢é˜Ÿï¼ˆ<3äººï¼‰
- æŠ€æœ¯èƒŒæ™¯å¼ºï¼Œæ„¿æ„ç»´æŠ¤CMS
- å¯¹å®æ—¶æ€§è¦æ±‚æé«˜
- é¢„ç®—å……è¶³ï¼ˆå¼€å‘æˆæœ¬ï¼‰

---

### æ–¹æ¡ˆCï¼šæ··åˆæ¶æ„ï¼ˆçµæ´»æ–¹æ¡ˆï¼‰

```
æ•°æ®æµå‘ï¼š
å†…å®¹ç¤¾åŒºæ–‡ç« ï¼ˆé£ä¹¦åä½œï¼‰
    â†“ åŒæ­¥
æ•°æ®æ¦œå•ï¼ˆç›´æ¥å†™D1ï¼‰
    â†“ ç»Ÿä¸€API
D1æ•°æ®åº“
    â†“
å‰ç«¯ç½‘ç«™
```

**ä¼˜åŠ¿**ï¼š
- âœ… **å„å–æ‰€é•¿**ï¼šæ–‡ç« ç”¨é£ä¹¦åä½œï¼Œæ•°æ®ç”¨D1ç®¡ç†
- âœ… **çµæ´»æ€§é«˜**ï¼šå¯æ ¹æ®å†…å®¹ç±»å‹é€‰æ‹©å·¥å…·
- âœ… **æˆæœ¬å¯æ§**ï¼šåªä¸ºåä½œå†…å®¹ä»˜è´¹é£ä¹¦

**é€‚ç”¨åœºæ™¯**ï¼š
- SVTRå½“å‰æƒ…å†µï¼ˆæ¨èï¼ï¼‰
- æœ‰PGCå†…å®¹åˆ›ä½œå›¢é˜Ÿ
- åŒæ—¶æœ‰å¤§é‡ç»“æ„åŒ–æ•°æ®

---

## äºŒã€D1ç›´æ¥å­˜å‚¨æ•°æ®çš„å®Œæ•´å®ç°

### 2.1 è‡ªå»ºCMSåå°æ¶æ„

å¦‚æœé€‰æ‹©æ–¹æ¡ˆBï¼ˆD1ä¸ºä¸»ï¼‰ï¼Œéœ€è¦æ„å»ºä»¥ä¸‹ç³»ç»Ÿï¼š

#### åå°ç®¡ç†ç•Œé¢ï¼š`/admin/` ç›®å½•ç»“æ„
```
admin/
â”œâ”€â”€ index.html                 # ç®¡ç†åå°é¦–é¡µ
â”œâ”€â”€ articles/
â”‚   â”œâ”€â”€ list.html             # æ–‡ç« åˆ—è¡¨
â”‚   â”œâ”€â”€ edit.html             # æ–‡ç« ç¼–è¾‘å™¨
â”‚   â””â”€â”€ preview.html          # é¢„è§ˆç•Œé¢
â”œâ”€â”€ companies/
â”‚   â”œâ”€â”€ list.html             # å…¬å¸æ•°æ®ç®¡ç†
â”‚   â””â”€â”€ import.html           # æ‰¹é‡å¯¼å…¥
â””â”€â”€ assets/
    â”œâ”€â”€ js/
    â”‚   â”œâ”€â”€ rich-editor.js    # å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
    â”‚   â””â”€â”€ data-grid.js      # æ•°æ®è¡¨æ ¼
    â””â”€â”€ css/
        â””â”€â”€ admin.css         # åå°æ ·å¼
```

#### æ ¸å¿ƒåŠŸèƒ½å®ç°

##### 1. å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆ
```html
<!-- admin/articles/edit.html -->
<!DOCTYPE html>
<html>
<head>
  <title>æ–‡ç« ç¼–è¾‘å™¨ - SVTRåå°</title>
  <!-- Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>
<body>
  <div id="editor-container" style="height: 500px;"></div>

  <button onclick="saveArticle()">ä¿å­˜æ–‡ç« </button>
  <button onclick="publishArticle()">å‘å¸ƒ</button>

  <script>
    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    const quill = new Quill('#editor-container', {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          ['link', 'image', 'code-block'],
          [{ 'header': [1, 2, 3, false] }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }]
        ]
      }
    });

    // ä¿å­˜åˆ°D1
    async function saveArticle() {
      const content = quill.root.innerHTML;
      const title = document.getElementById('title').value;

      const response = await fetch('/api/admin/articles', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getAdminToken()}`
        },
        body: JSON.stringify({
          title,
          content,
          status: 'draft'
        })
      });

      const result = await response.json();
      alert(`æ–‡ç« å·²ä¿å­˜ï¼ŒID: ${result.articleId}`);
    }

    async function publishArticle() {
      // ä¿å­˜å¹¶å‘å¸ƒ
      await saveArticle();
      await updateStatus('published');
    }
  </script>
</body>
</html>
```

##### 2. åå°APIå®ç°
```typescript
// functions/api/admin/articles.ts
export async function onRequestPost(context) {
  const { request, env } = context;

  // éªŒè¯ç®¡ç†å‘˜æƒé™
  const admin = await validateAdminAuth(request, env);
  if (!admin) {
    return new Response('Unauthorized', { status: 401 });
  }

  const { title, content, status, category, tags } = await request.json();

  // ç”Ÿæˆnode_token
  const nodeToken = `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

  // å†™å…¥D1æ•°æ®åº“
  const result = await env.DB.prepare(`
    INSERT INTO knowledge_base_nodes (
      node_token, title, obj_type, content_summary,
      doc_type, search_keywords, is_public
    ) VALUES (?, ?, ?, ?, ?, ?, ?)
  `).bind(
    nodeToken,
    title,
    'docx',
    content.substring(0, 200),
    'article',
    JSON.stringify(extractKeywords(content)),
    status === 'published'
  ).run();

  // å†™å…¥å®Œæ•´å†…å®¹
  await env.DB.prepare(`
    INSERT INTO knowledge_base_content (
      node_token, full_content, content_format
    ) VALUES (?, ?, ?)
  `).bind(nodeToken, content, 'html').run();

  // å¦‚æœæ˜¯å‘å¸ƒçŠ¶æ€ï¼Œç”ŸæˆURL
  if (status === 'published') {
    const slug = generateSlug(title, nodeToken);
    await env.DB.prepare(`
      INSERT INTO published_articles (
        node_token, slug, published_url, status, category, tags
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      nodeToken,
      slug,
      `/pages/articles/${slug}.html`,
      'published',
      category,
      JSON.stringify(tags)
    ).run();
  }

  return Response.json({
    success: true,
    articleId: nodeToken,
    message: 'æ–‡ç« ä¿å­˜æˆåŠŸ'
  });
}
```

##### 3. æ•°æ®æ‰¹é‡å¯¼å…¥
```typescript
// functions/api/admin/companies/import.ts
export async function onRequestPost(context) {
  const { request, env } = context;

  // éªŒè¯ç®¡ç†å‘˜æƒé™
  const admin = await validateAdminAuth(request, env);
  if (!admin) {
    return new Response('Unauthorized', { status: 401 });
  }

  // æ¥æ”¶CSV/Excelæ•°æ®
  const formData = await request.formData();
  const file = formData.get('file');

  // è§£ææ–‡ä»¶ï¼ˆå‡è®¾CSVï¼‰
  const csvData = await file.text();
  const rows = parseCSV(csvData);

  // æ‰¹é‡æ’å…¥D1
  const statements = rows.map(row => {
    return env.DB.prepare(`
      INSERT INTO companies (
        company_name, website, founded_year,
        latest_stage, latest_amount_usd
      ) VALUES (?, ?, ?, ?, ?)
    `).bind(
      row.company_name,
      row.website,
      parseInt(row.founded_year),
      row.latest_stage,
      parseFloat(row.latest_amount_usd)
    );
  });

  await env.DB.batch(statements);

  return Response.json({
    success: true,
    imported: rows.length
  });
}
```

---

## ä¸‰ã€å‰ç«¯å¦‚ä½•è°ƒç”¨D1æŒ‡å®šæ•°æ®

### 3.1 RESTful APIè®¾è®¡

#### APIç«¯ç‚¹è§„åˆ’
```
GET  /api/articles                    # è·å–æ–‡ç« åˆ—è¡¨
GET  /api/articles/:slug              # è·å–æŒ‡å®šæ–‡ç« 
POST /api/articles                    # åˆ›å»ºæ–‡ç« ï¼ˆéœ€è®¤è¯ï¼‰
PUT  /api/articles/:slug              # æ›´æ–°æ–‡ç« ï¼ˆéœ€è®¤è¯ï¼‰

GET  /api/companies                   # è·å–å…¬å¸åˆ—è¡¨
GET  /api/companies/:id               # è·å–æŒ‡å®šå…¬å¸
GET  /api/companies/search?q=xAI     # æœç´¢å…¬å¸

GET  /api/rankings/funding-top100     # èèµ„æ’è¡Œæ¦œ
GET  /api/rankings/unicorns          # ç‹¬è§’å…½æ¦œå•
GET  /api/rankings/investors-active  # æ´»è·ƒæŠ•èµ„äºº
```

### 3.2 å‰ç«¯è°ƒç”¨ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šè·å–æ–‡ç« åˆ—è¡¨
```javascript
// pages/content-community.html
async function loadArticles(category = null, limit = 20, offset = 0) {
  const params = new URLSearchParams({
    limit,
    offset,
    ...(category && { category })
  });

  const response = await fetch(`/api/articles?${params}`);
  const data = await response.json();

  // dataç»“æ„ï¼š
  // {
  //   success: true,
  //   data: {
  //     articles: [...],
  //     total: 263,
  //     hasMore: true
  //   }
  // }

  renderArticleList(data.data.articles);
}

function renderArticleList(articles) {
  const container = document.getElementById('articles-list');

  container.innerHTML = articles.map(article => `
    <article class="article-card">
      <h3><a href="${article.published_url}">${article.meta_title}</a></h3>
      <p>${article.content_summary}</p>
      <div class="meta">
        <span class="category">${article.category}</span>
        <span class="date">${article.publish_date}</span>
        <span class="views">${article.view_count} é˜…è¯»</span>
      </div>
    </article>
  `).join('');
}

// é¡µé¢åŠ è½½æ—¶è°ƒç”¨
document.addEventListener('DOMContentLoaded', () => {
  loadArticles('AIåˆ›æŠ•è§‚å¯Ÿ');
});
```

#### ç¤ºä¾‹2ï¼šè·å–æŒ‡å®šæ–‡ç« è¯¦æƒ…
```javascript
// pages/articles/[slug].html åŠ¨æ€ç”Ÿæˆ
async function loadArticleDetail(slug) {
  const response = await fetch(`/api/articles/${slug}`);
  const { data } = await response.json();

  // dataç»“æ„ï¼š
  // {
  //   article: {
  //     title: "AIåˆ›æŠ•è§‚å¯Ÿä¸¨2025 Q3",
  //     full_content: "...",
  //     category: "AIåˆ›æŠ•è§‚å¯Ÿ",
  //     tags: ["AI", "èèµ„", "2025"],
  //     view_count: 1523,
  //     publish_date: "2025-10-20"
  //   },
  //   related: [...]
  // }

  document.title = data.article.title;
  document.getElementById('article-title').textContent = data.article.title;
  document.getElementById('article-content').innerHTML = data.article.full_content;

  renderRelatedArticles(data.related);
}
```

#### ç¤ºä¾‹3ï¼šæ•°æ®æ¦œå•æŸ¥è¯¢
```javascript
// pages/rankings/funding-top100.html
async function loadFundingRanking(filters = {}) {
  const params = new URLSearchParams({
    sector: filters.sector || '',
    stage: filters.stage || '',
    min_amount: filters.minAmount || 0,
    limit: filters.limit || 100
  });

  const response = await fetch(`/api/rankings/funding-top100?${params}`);
  const { data } = await response.json();

  // dataç»“æ„ï¼š
  // {
  //   rankings: [
  //     {
  //       company_name: "xAI",
  //       latest_amount_usd: 10000000000,
  //       latest_stage: "Series C",
  //       primary_category: "å¤§è¯­è¨€æ¨¡å‹",
  //       investors: "Sequoia, a16z, ..."
  //     },
  //     ...
  //   ],
  //   total: 5000
  // }

  renderRankingChart(data.rankings);
  renderRankingTable(data.rankings);
}

function renderRankingChart(rankings) {
  // ä½¿ç”¨EChartså¯è§†åŒ–
  const chart = echarts.init(document.getElementById('chart-container'));

  chart.setOption({
    title: { text: 'AIèèµ„Top100' },
    xAxis: {
      type: 'category',
      data: rankings.slice(0, 20).map(r => r.company_name)
    },
    yAxis: {
      type: 'value',
      name: 'èèµ„é¢ï¼ˆäº¿ç¾å…ƒï¼‰'
    },
    series: [{
      type: 'bar',
      data: rankings.slice(0, 20).map(r => r.latest_amount_usd / 100000000)
    }]
  });
}
```

#### ç¤ºä¾‹4ï¼šæ™ºèƒ½æœç´¢
```javascript
// assets/js/search.js
async function searchContent(query, type = 'all') {
  const response = await fetch('/api/knowledge/search', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ query, type })
  });

  const { data } = await response.json();

  // dataç»“æ„ï¼š
  // {
  //   text_search: [...],      // æ–‡æœ¬åŒ¹é…ç»“æœ
  //   semantic_search: [...]   // è¯­ä¹‰ç›¸ä¼¼ç»“æœï¼ˆVectorizeï¼‰
  // }

  renderSearchResults(data);
}

function renderSearchResults(data) {
  const combinedResults = [
    ...data.semantic_search.map(r => ({ ...r, source: 'AIæ¨è' })),
    ...data.text_search.map(r => ({ ...r, source: 'ç²¾ç¡®åŒ¹é…' }))
  ];

  // å»é‡å¹¶æ’åº
  const uniqueResults = deduplicateByNodeToken(combinedResults);

  displayResults(uniqueResults);
}
```

---

## å››ã€å¦‚ä½•æŸ¥çœ‹å’Œç®¡ç†D1æ•°æ®

### 4.1 Wrangler CLIï¼ˆå‘½ä»¤è¡Œç®¡ç†ï¼‰

#### æŸ¥çœ‹æ‰€æœ‰è¡¨
```bash
# åˆ—å‡ºæ‰€æœ‰è¡¨
npx wrangler d1 execute svtr-production --remote \
  --command="SELECT name FROM sqlite_master WHERE type='table'"

# è¾“å‡ºç¤ºä¾‹ï¼š
# name
# ----
# knowledge_base_nodes
# knowledge_base_content
# companies
# investors
# published_articles
```

#### æŸ¥çœ‹è¡¨ç»“æ„
```bash
# æŸ¥çœ‹è¡¨çš„Schema
npx wrangler d1 execute svtr-production --remote \
  --command="PRAGMA table_info(knowledge_base_nodes)"

# è¾“å‡ºç¤ºä¾‹ï¼š
# cid | name       | type    | notnull | dflt_value | pk
# ----|------------|---------|---------|------------|---
# 0   | id         | INTEGER | 0       | NULL       | 1
# 1   | node_token | TEXT    | 1       | NULL       | 0
# 2   | title      | TEXT    | 1       | NULL       | 0
# ...
```

#### æŸ¥è¯¢æ•°æ®
```bash
# æŸ¥çœ‹æ‰€æœ‰æ–‡ç« 
npx wrangler d1 execute svtr-production --remote \
  --command="SELECT title, category, publish_date FROM published_articles LIMIT 10"

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
npx wrangler d1 execute svtr-production --remote \
  --command="SELECT COUNT(*) as total_nodes, obj_type FROM knowledge_base_nodes GROUP BY obj_type"

# æœç´¢ç‰¹å®šå†…å®¹
npx wrangler d1 execute svtr-production --remote \
  --command="SELECT title FROM knowledge_base_nodes WHERE title LIKE '%AIåˆ›æŠ•%'"
```

#### æ’å…¥æ•°æ®
```bash
# æ‰‹åŠ¨æ’å…¥ä¸€ç¯‡æ–‡ç« 
npx wrangler d1 execute svtr-production --remote \
  --command="INSERT INTO knowledge_base_nodes (node_token, title, obj_type, is_public) VALUES ('node_test_001', 'æµ‹è¯•æ–‡ç« ', 'docx', 1)"

# æ‰¹é‡æ“ä½œç”¨æ–‡ä»¶
npx wrangler d1 execute svtr-production --remote \
  --file=./scripts/insert-sample-data.sql
```

#### å¤‡ä»½å’Œæ¢å¤
```bash
# å¯¼å‡ºæ•´ä¸ªæ•°æ®åº“
npx wrangler d1 export svtr-production --remote \
  --output=./backups/d1-backup-$(date +%Y%m%d).sql

# æ¢å¤æ•°æ®åº“
npx wrangler d1 execute svtr-production --remote \
  --file=./backups/d1-backup-20251021.sql
```

---

### 4.2 Webç®¡ç†ç•Œé¢ï¼ˆè‡ªå»ºï¼‰

ç”±äºD1æ²¡æœ‰å®˜æ–¹çš„å¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼ˆç±»ä¼¼phpMyAdminï¼‰ï¼Œæ‚¨éœ€è¦è‡ªå»ºï¼š

#### æ–¹æ¡ˆ1ï¼šè‡ªå»ºç®€æ˜“ç®¡ç†ç•Œé¢

```html
<!-- admin/database/explorer.html -->
<!DOCTYPE html>
<html>
<head>
  <title>D1æ•°æ®åº“ç®¡ç†å™¨ - SVTR</title>
  <style>
    .query-editor { width: 100%; height: 200px; font-family: monospace; }
    .results-table { width: 100%; border-collapse: collapse; }
    .results-table th, .results-table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
  </style>
</head>
<body>
  <h1>D1æ•°æ®åº“ç®¡ç†å™¨</h1>

  <!-- å¿«æ·æŸ¥è¯¢æŒ‰é’® -->
  <div class="shortcuts">
    <button onclick="runQuery('SELECT * FROM knowledge_base_nodes LIMIT 20')">
      æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹
    </button>
    <button onclick="runQuery('SELECT * FROM published_articles ORDER BY publish_date DESC LIMIT 20')">
      æœ€æ–°æ–‡ç« 
    </button>
    <button onclick="runQuery('SELECT COUNT(*) as total, obj_type FROM knowledge_base_nodes GROUP BY obj_type')">
      ç»Ÿè®¡ä¿¡æ¯
    </button>
  </div>

  <!-- SQLç¼–è¾‘å™¨ -->
  <h2>è‡ªå®šä¹‰æŸ¥è¯¢</h2>
  <textarea id="sql-editor" class="query-editor" placeholder="è¾“å…¥SQLæŸ¥è¯¢...">
SELECT * FROM knowledge_base_nodes WHERE is_public = 1 LIMIT 10
  </textarea>
  <button onclick="runCustomQuery()">æ‰§è¡ŒæŸ¥è¯¢</button>

  <!-- ç»“æœå±•ç¤º -->
  <h2>æŸ¥è¯¢ç»“æœ</h2>
  <div id="results"></div>

  <script>
    async function runQuery(sql) {
      const response = await fetch('/api/admin/database/query', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
        },
        body: JSON.stringify({ sql })
      });

      const { data } = await response.json();
      displayResults(data);
    }

    function runCustomQuery() {
      const sql = document.getElementById('sql-editor').value;
      runQuery(sql);
    }

    function displayResults(data) {
      if (!data || data.length === 0) {
        document.getElementById('results').innerHTML = '<p>æ— ç»“æœ</p>';
        return;
      }

      // ç”Ÿæˆè¡¨æ ¼
      const columns = Object.keys(data[0]);
      const table = `
        <table class="results-table">
          <thead>
            <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
          </thead>
          <tbody>
            ${data.map(row => `
              <tr>${columns.map(col => `<td>${row[col]}</td>`).join('')}</tr>
            `).join('')}
          </tbody>
        </table>
        <p>å…± ${data.length} æ¡ç»“æœ</p>
      `;

      document.getElementById('results').innerHTML = table;
    }
  </script>
</body>
</html>
```

#### å¯¹åº”çš„APIå®ç°
```typescript
// functions/api/admin/database/query.ts
export async function onRequestPost(context) {
  const { request, env } = context;

  // ä¸¥æ ¼éªŒè¯ç®¡ç†å‘˜æƒé™
  const admin = await validateAdminAuth(request, env);
  if (!admin || admin.role !== 'super_admin') {
    return new Response('Forbidden', { status: 403 });
  }

  const { sql } = await request.json();

  // å®‰å…¨æ£€æŸ¥ï¼šåªå…è®¸SELECTæŸ¥è¯¢ï¼ˆé˜²æ­¢è¯¯åˆ ï¼‰
  if (!sql.trim().toUpperCase().startsWith('SELECT')) {
    return Response.json({
      success: false,
      error: 'ä»…å…è®¸SELECTæŸ¥è¯¢ï¼Œå¦‚éœ€ä¿®æ”¹æ•°æ®è¯·ä½¿ç”¨ä¸“ç”¨æ¥å£'
    }, { status: 400 });
  }

  try {
    const results = await env.DB.prepare(sql).all();

    return Response.json({
      success: true,
      data: results.results,
      count: results.results.length
    });
  } catch (error) {
    return Response.json({
      success: false,
      error: error.message
    }, { status: 500 });
  }
}
```

---

### 4.3 ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·

#### æ–¹æ¡ˆ2ï¼šé›†æˆCloudflare Dashboard

Cloudflareå®˜æ–¹æ­£åœ¨å¼€å‘D1çš„Webæ§åˆ¶å°ï¼Œé¢„è®¡2025å¹´Q1å‘å¸ƒã€‚å±Šæ—¶å¯ä»¥åœ¨Cloudflare Dashboardä¸­ï¼š
- ğŸ“Š å¯è§†åŒ–æŸ¥çœ‹è¡¨ç»“æ„
- ğŸ” æ‰§è¡ŒSQLæŸ¥è¯¢
- ğŸ“¥ å¯¼å…¥/å¯¼å‡ºæ•°æ®
- ğŸ“ˆ æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡

ç›®å‰Betaç‰ˆæœ¬å¯åœ¨ `https://dash.cloudflare.com/` â†’ D1 â†’ é€‰æ‹©æ•°æ®åº“ â†’ "Console" æ ‡ç­¾é¡µè®¿é—®ã€‚

#### æ–¹æ¡ˆ3ï¼šä½¿ç”¨SQLiteå®¢æˆ·ç«¯ï¼ˆæœ¬åœ°å¼€å‘ï¼‰

```bash
# 1. å¯¼å‡ºD1æ•°æ®åˆ°æœ¬åœ°SQLiteæ–‡ä»¶
npx wrangler d1 export svtr-production --remote --output=./local-d1.db

# 2. ä½¿ç”¨SQLiteå®¢æˆ·ç«¯æ‰“å¼€
# Macç”¨æˆ·ï¼š
brew install sqlite
sqlite3 local-d1.db

# Windowsç”¨æˆ·ï¼š
# ä¸‹è½½ https://sqlitebrowser.org/
# æˆ–ä½¿ç”¨ DB Browser for SQLiteï¼ˆå›¾å½¢ç•Œé¢ï¼‰

# 3. åœ¨SQLiteä¸­æŸ¥è¯¢
sqlite> .tables
sqlite> SELECT * FROM knowledge_base_nodes LIMIT 5;
sqlite> .schema knowledge_base_nodes
```

æ¨èçš„SQLiteå›¾å½¢åŒ–å·¥å…·ï¼š
- **DB Browser for SQLite**ï¼ˆå…è´¹ï¼Œè·¨å¹³å°ï¼‰ï¼šhttps://sqlitebrowser.org/
- **TablePlus**ï¼ˆä»˜è´¹ï¼ŒUIç²¾ç¾ï¼‰ï¼šhttps://tableplus.com/
- **DBeaver**ï¼ˆå…è´¹ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼‰ï¼šhttps://dbeaver.io/

---

## äº”ã€D1æ•°æ®ç®¡ç†æœ€ä½³å®è·µ

### 5.1 æ•°æ®æŸ¥è¯¢é€ŸæŸ¥è¡¨

```sql
-- 1. æŸ¥çœ‹æ•°æ®åº“æ¦‚è§ˆ
SELECT
  (SELECT COUNT(*) FROM knowledge_base_nodes) as total_nodes,
  (SELECT COUNT(*) FROM published_articles) as total_articles,
  (SELECT COUNT(*) FROM companies) as total_companies,
  (SELECT COUNT(*) FROM investors) as total_investors;

-- 2. æŸ¥çœ‹æœ€è¿‘æ›´æ–°çš„å†…å®¹
SELECT title, updated_at, obj_type
FROM knowledge_base_nodes
ORDER BY updated_at DESC
LIMIT 20;

-- 3. æŸ¥çœ‹çƒ­é—¨æ–‡ç« 
SELECT a.meta_title, a.view_count, a.publish_date
FROM published_articles a
WHERE a.status = 'published'
ORDER BY a.view_count DESC
LIMIT 10;

-- 4. æœç´¢ç‰¹å®šå…³é”®è¯
SELECT title, content_summary
FROM knowledge_base_nodes
WHERE title LIKE '%AIåˆ›æŠ•%'
   OR content_summary LIKE '%AIåˆ›æŠ•%'
LIMIT 10;

-- 5. æŒ‰ç±»å‹ç»Ÿè®¡
SELECT
  obj_type,
  COUNT(*) as count,
  AVG(rag_score) as avg_quality
FROM knowledge_base_nodes
GROUP BY obj_type;

-- 6. æŸ¥çœ‹æ•°æ®è´¨é‡
SELECT
  CASE
    WHEN rag_score >= 80 THEN 'Excellent'
    WHEN rag_score >= 60 THEN 'Good'
    WHEN rag_score >= 40 THEN 'Fair'
    ELSE 'Poor'
  END as quality,
  COUNT(*) as count
FROM knowledge_base_nodes
GROUP BY quality;
```

### 5.2 å®šæœŸç»´æŠ¤ä»»åŠ¡

```bash
# æ¯å‘¨æ‰§è¡Œçš„ç»´æŠ¤è„šæœ¬
# scripts/d1-maintenance.sh

#!/bin/bash

# 1. å¤‡ä»½æ•°æ®åº“
echo "ğŸ“¦ å¼€å§‹å¤‡ä»½D1æ•°æ®åº“..."
npx wrangler d1 export svtr-production --remote \
  --output=./backups/d1-weekly-$(date +%Y%m%d).sql

# 2. æ¸…ç†è¿‡æœŸæ•°æ®
echo "ğŸ§¹ æ¸…ç†è¿‡æœŸç¼“å­˜..."
npx wrangler d1 execute svtr-production --remote \
  --command="DELETE FROM rankings_cache WHERE expires_at < datetime('now')"

# 3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
echo "ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯..."
npx wrangler d1 execute svtr-production --remote \
  --file=./scripts/update-statistics.sql

# 4. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
echo "ğŸ” æ£€æŸ¥æ•°æ®å®Œæ•´æ€§..."
npx wrangler d1 execute svtr-production --remote \
  --command="SELECT COUNT(*) as orphaned_content FROM knowledge_base_content c LEFT JOIN knowledge_base_nodes n ON c.node_token = n.node_token WHERE n.id IS NULL"

echo "âœ… ç»´æŠ¤ä»»åŠ¡å®Œæˆï¼"
```

---

## å…­ã€æ€»ç»“ä¸å»ºè®®

### é—®é¢˜1ç­”æ¡ˆï¼šèƒ½å¦ç›´æ¥ç”¨D1ï¼Œä¸ä¾èµ–é£ä¹¦ï¼Ÿ

**æŠ€æœ¯ä¸Šï¼šâœ… 100%å¯è¡Œ**

ä½†éœ€è¦ï¼š
- è‡ªå»ºCMSåå°ï¼ˆ3-4å‘¨å¼€å‘ï¼‰
- è‡ªå·±å®ç°åä½œç¼–è¾‘åŠŸèƒ½
- ç»´æŠ¤ç‰ˆæœ¬å†å²å’Œæƒé™ç³»ç»Ÿ

**ä¸šåŠ¡ä¸Šï¼šâš ï¸ å–å†³äºå›¢é˜Ÿè§„æ¨¡å’ŒæŠ€æœ¯èƒ½åŠ›**

æ¨èæ–¹æ¡ˆï¼š
- **1-2äººå›¢é˜Ÿ**ï¼šå¯ä»¥å°è¯•çº¯D1æ–¹æ¡ˆ
- **3+äººå›¢é˜Ÿ**ï¼šä¿ç•™é£ä¹¦åä½œï¼ŒD1ä½œä¸ºå‘å¸ƒæ¸ é“
- **æ··åˆæ–¹æ¡ˆ**ï¼šæ–‡ç« ç”¨é£ä¹¦ï¼Œæ•°æ®ç”¨D1ï¼ˆSVTRæ¨èï¼‰

---

### é—®é¢˜2ç­”æ¡ˆï¼šå‰ç«¯å¦‚ä½•è°ƒç”¨D1æŒ‡å®šæ•°æ®ï¼Ÿ

**ç­”æ¡ˆï¼šé€šè¿‡RESTful API**

æµç¨‹ï¼š
```
å‰ç«¯JavaScript
    â†“ fetch('/api/articles/xxx')
Cloudflare Workers Function
    â†“ env.DB.prepare(sql).bind().all()
D1æ•°æ®åº“
    â†“ è¿”å›JSON
å‰ç«¯æ¸²æŸ“
```

å…³é”®ç‚¹ï¼š
- âœ… æ‰€æœ‰æ•°æ®è®¿é—®éƒ½é€šè¿‡API
- âœ… æ”¯æŒå¤æ‚æŸ¥è¯¢ï¼ˆç­›é€‰ã€æ’åºã€åˆ†é¡µï¼‰
- âœ… è‡ªåŠ¨JSONåºåˆ—åŒ–
- âœ… å¯æ·»åŠ ç¼“å­˜å±‚ï¼ˆKVï¼‰æé€Ÿ

---

### é—®é¢˜3ç­”æ¡ˆï¼šå¦‚ä½•æŸ¥çœ‹D1æ•°æ®ï¼Ÿ

**ç­”æ¡ˆï¼šä¸‰ç§æ–¹å¼**

1. **Wrangler CLI**ï¼ˆæ¨èï¼Œæœ€çµæ´»ï¼‰
   ```bash
   npx wrangler d1 execute svtr-production --remote \
     --command="SELECT * FROM knowledge_base_nodes LIMIT 10"
   ```

2. **è‡ªå»ºWebç®¡ç†ç•Œé¢**ï¼ˆæ¨èï¼Œæœ€ç›´è§‚ï¼‰
   - åˆ›å»º `admin/database/explorer.html`
   - å®ç°æŸ¥è¯¢API
   - ç±»ä¼¼phpMyAdminä½“éªŒ

3. **å¯¼å‡ºåˆ°æœ¬åœ°SQLite**ï¼ˆæ¨èï¼Œå¯ç¦»çº¿ï¼‰
   ```bash
   npx wrangler d1 export svtr-production --remote --output=local.db
   # ç”¨DB Browser for SQLiteæ‰“å¼€
   ```

---

### æœ€ç»ˆå»ºè®®ï¼šæ··åˆæ¶æ„ï¼ˆæ–¹æ¡ˆCï¼‰

```
SVTRçŸ¥è¯†åº“å†…å®¹
    â”œâ”€â”€ PGCæ–‡ç« ï¼ˆé£ä¹¦åä½œç¼–è¾‘ï¼‰
    â”‚       â†“ æ¯æ—¥åŒæ­¥
    â”œâ”€â”€ æ•°æ®æ¦œå•ï¼ˆç›´æ¥å†™D1ï¼‰
    â”‚       â†“ æ‰¹é‡å¯¼å…¥/APIå†™å…¥
    â””â”€â”€ D1æ•°æ®åº“ï¼ˆç»Ÿä¸€å­˜å‚¨ï¼‰
            â†“ RESTful API
        å‰ç«¯ç½‘ç«™ï¼ˆç»Ÿä¸€å±•ç¤ºï¼‰
```

**ç†ç”±**ï¼š
- âœ… ä¿ç•™é£ä¹¦åä½œä¼˜åŠ¿ï¼ˆæ–‡ç« åˆ›ä½œï¼‰
- âœ… å‘æŒ¥D1æŸ¥è¯¢ä¼˜åŠ¿ï¼ˆæ•°æ®æ¦œå•ï¼‰
- âœ… é™ä½å¼€å‘æˆæœ¬ï¼ˆæ— éœ€é€ è½®å­ï¼‰
- âœ… çµæ´»æ€§é«˜ï¼ˆå¯éšæ—¶è°ƒæ•´ï¼‰

---

**æ‚¨è§‰å¾—è¿™ä¸ªæ··åˆæ–¹æ¡ˆå¦‚ä½•ï¼Ÿè¿˜æ˜¯å€¾å‘äºå®Œå…¨è‡ªå»ºCMSï¼Ÿ**
