name: ğŸ’° AIåˆ›æŠ•æ—¥æŠ¥æ¯æ—¥åŒæ­¥

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ6:00 (UTC 22:00å‰ä¸€å¤©) æ‰§è¡Œ
    - cron: '0 22 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»å‹'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - force_refresh
        - test_mode

env:
  # é£ä¹¦APIé…ç½®
  FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
  FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}

permissions:
  contents: write
  actions: read

jobs:
  sync-funding-daily:
    name: ğŸ”„ åŒæ­¥AIåˆ›æŠ•æ—¥æŠ¥æ•°æ®
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          npm install dotenv --no-package-lock

      - name: ğŸ” Setup Environment
        run: |
          echo "FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}" > .env
          echo "FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}" >> .env

      - name: ğŸ’° Sync Funding Daily Data
        id: sync_funding
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥AIåˆ›æŠ•æ—¥æŠ¥æ•°æ®..."

          # ä½¿ç”¨å¥å£®çš„åŒæ­¥è„šæœ¬ï¼Œç¡®ä¿ä¸ä¼šå¤±è´¥
          npm run sync:funding-daily

          # è¾“å‡ºåŒæ­¥ç»“æœ
          echo "last_update=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "sync_status=success" >> $GITHUB_OUTPUT

      - name: ğŸ¯ Trigger Cloudflare Cache Update
        if: success()
        run: |
          echo "ğŸ”„ è§¦å‘Cloudflareç¼“å­˜æ›´æ–°..."

          # é€šè¿‡è®¿é—®APIå¼ºåˆ¶åˆ·æ–°ç¼“å­˜
          curl -s "https://svtr.ai/api/wiki-funding-sync?refresh=true" \
            -H "User-Agent: GitHub-Actions-Funding-Sync" \
            || echo "âš ï¸ ç¼“å­˜åˆ·æ–°è¯·æ±‚å¤±è´¥ï¼Œä½†åŒæ­¥ç»§ç»­"

      - name: ğŸ“ˆ Generate Sync Report
        if: always()
        run: |
          echo "## ğŸ’° AIåˆ›æŠ•æ—¥æŠ¥åŒæ­¥æŠ¥å‘Š" > funding_sync_report.md
          echo "**æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> funding_sync_report.md
          echo "**åŒæ­¥ç±»å‹**: ${{ github.event.inputs.sync_type || 'auto' }}" >> funding_sync_report.md
          echo "**çŠ¶æ€**: ${{ job.status }}" >> funding_sync_report.md
          echo "" >> funding_sync_report.md

          if [ -n "${{ steps.sync_funding.outputs.funding_count }}" ]; then
            echo "### æ•°æ®ç»Ÿè®¡" >> funding_sync_report.md
            echo "- èèµ„è®°å½•æ•°é‡: ${{ steps.sync_funding.outputs.funding_count }}" >> funding_sync_report.md
            echo "- æ•°æ®æº: ${{ steps.sync_funding.outputs.data_source }}" >> funding_sync_report.md
            echo "- æœ€åæ›´æ–°: ${{ steps.sync_funding.outputs.last_update }}" >> funding_sync_report.md
          fi

          echo "" >> funding_sync_report.md
          echo "### APIç«¯ç‚¹" >> funding_sync_report.md
          echo "- ç”Ÿäº§ç¯å¢ƒ: https://svtr.ai/api/wiki-funding-sync" >> funding_sync_report.md
          echo "- æ•°æ®æº: é£ä¹¦æ–°Bitable AIåˆ›æŠ•æ—¥æŠ¥" >> funding_sync_report.md
          echo "- ç¼“å­˜ç­–ç•¥: 24å°æ—¶è‡ªåŠ¨è¿‡æœŸ" >> funding_sync_report.md

          echo "" >> funding_sync_report.md
          echo "### ä¸‹æ¬¡åŒæ­¥" >> funding_sync_report.md
          echo "- å®šæ—¶ä»»åŠ¡: æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ6:00" >> funding_sync_report.md
          echo "- æ‰‹åŠ¨è§¦å‘: æ”¯æŒæ‰‹åŠ¨æ‰§è¡Œ" >> funding_sync_report.md

          cat funding_sync_report.md

      - name: ğŸš€ Optional Deploy Notification
        if: success()
        run: |
          echo "âœ… AIåˆ›æŠ•æ—¥æŠ¥æ•°æ®åŒæ­¥æˆåŠŸå®Œæˆ"
          echo "ğŸŒ æ•°æ®å·²æ›´æ–°åˆ°ç”Ÿäº§ç¯å¢ƒ: https://svtr.ai"
          echo "ğŸ“Š ç”¨æˆ·å°†åœ¨é¡µé¢åˆ·æ–°åçœ‹åˆ°æœ€æ–°çš„èèµ„ä¿¡æ¯"