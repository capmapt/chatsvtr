# SVTR.AIé£ä¹¦çŸ¥è¯†åº“è‡ªåŠ¨åŒæ­¥å·¥ä½œæµ
# ç¾è¥¿æ—¶é—´æ¯å¤©æ™šä¸Š12:00è‡ªåŠ¨åŒæ­¥

name: SVTRçŸ¥è¯†åº“è‡ªåŠ¨åŒæ­¥
on:
  schedule:
    # ç¾è¥¿æ—¶é—´12:00 AM = UTC 8:00 AM (è€ƒè™‘PSTæ—¶åŒº)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»å‹'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - full
          - test
  repository_dispatch:
    types:
      - feishu-update

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: éªŒè¯åŒæ­¥è„šæœ¬å’Œç¯å¢ƒ
        run: |
          echo "ğŸ” éªŒè¯åŒæ­¥ç¯å¢ƒ..."
          
          # æ£€æŸ¥è„šæœ¬æ–‡ä»¶å­˜åœ¨
          if [ ! -f "scripts/improved-feishu-sync.js" ]; then
            echo "âŒ åŒæ­¥è„šæœ¬ä¸å­˜åœ¨: scripts/improved-feishu-sync.js"
            exit 1
          fi
          
          # æ£€æŸ¥ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p assets/data/rag/
          
          # éªŒè¯Node.jså’Œnpmå·¥ä½œæ­£å¸¸
          node --version
          npm --version
          
          # æµ‹è¯•è„šæœ¬è¯­æ³•
          node -c scripts/improved-feishu-sync.js || {
            echo "âŒ åŒæ­¥è„šæœ¬è¯­æ³•é”™è¯¯"
            exit 1
          }
          
          echo "âœ… ç¯å¢ƒéªŒè¯å®Œæˆ"
        
      - name: æ¯æ—¥è‡ªåŠ¨åŒæ­¥ (ç¾è¥¿æ—¶é—´12:00 AM)
        if: github.event_name == 'schedule'
        run: |
          echo "ğŸš€ å¼€å§‹é£ä¹¦çŸ¥è¯†åº“åŒæ­¥..."
          node scripts/improved-feishu-sync.js svtrai2025 || {
            echo "âŒ é£ä¹¦åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo "ğŸ” æ£€æŸ¥é£ä¹¦APIè¿æ¥å’Œæƒé™è®¾ç½®"
            exit 1
          }
          echo "âœ… é£ä¹¦åŒæ­¥è„šæœ¬æ‰§è¡Œå®Œæˆ"
        env:
          FEISHU_APP_ID: cli_a8e2014cbe7d9013
          FEISHU_APP_SECRET: tysHBj6njxwafO92dwO1DdttVvqvesf0
          
      - name: æ‰‹åŠ¨è§¦å‘åŒæ­¥
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ github.event.inputs.sync_type }}" = "full" ]; then
            echo "æ‰§è¡Œå…¨é‡åŒæ­¥..."
            node scripts/improved-feishu-sync.js svtrai2025
          elif [ "${{ github.event.inputs.sync_type }}" = "test" ]; then
            echo "æ‰§è¡Œæµ‹è¯•åŒæ­¥..."
            node scripts/enhanced-rag-sync.js
          else
            echo "æ‰§è¡Œæ¯æ—¥åŒæ­¥..."
            node scripts/improved-feishu-sync.js svtrai2025
          fi
        env:
          FEISHU_APP_ID: cli_a8e2014cbe7d9013
          FEISHU_APP_SECRET: tysHBj6njxwafO92dwO1DdttVvqvesf0
          
      - name: Webhookè§¦å‘åŒæ­¥
        if: github.event_name == 'repository_dispatch'
        run: node scripts/improved-feishu-sync.js svtrai2025
        env:
          FEISHU_APP_ID: cli_a8e2014cbe7d9013
          FEISHU_APP_SECRET: tysHBj6njxwafO92dwO1DdttVvqvesf0
          
      - name: æ£€æŸ¥åŒæ­¥ç»“æœ
        run: |
          echo "ğŸ” æ£€æŸ¥åŒæ­¥ç»“æœ..."
          if [ -f "assets/data/rag/improved-feishu-knowledge-base.json" ]; then
            echo "âœ… çŸ¥è¯†åº“æ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(wc -c < assets/data/rag/improved-feishu-knowledge-base.json) å­—èŠ‚"
            echo "ğŸ“ æ–‡æ¡£æ•°é‡: $(jq '.summary.totalDocuments' assets/data/rag/improved-feishu-knowledge-base.json)"
            echo "ğŸ“… æœ€åæ›´æ–°: $(jq -r '.summary.lastUpdated' assets/data/rag/improved-feishu-knowledge-base.json)"
          else
            echo "âŒ çŸ¥è¯†åº“æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "SVTR Auto Sync"
          
          # åŒæ­¥è¿œç¨‹æœ€æ–°æ›´æ”¹é¿å…å†²çª
          echo "ğŸ”„ åŒæ­¥è¿œç¨‹æ›´æ”¹..."
          git fetch origin main
          git rebase origin/main || echo "âš ï¸ æ— éœ€rebaseæˆ–rebaseå¤±è´¥"
          
          # æ·»åŠ æ›´æ”¹æ–‡ä»¶
          git add assets/data/rag/ || echo "âš ï¸ æ²¡æœ‰RAGæ•°æ®æ–‡ä»¶éœ€è¦æ·»åŠ "
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“ æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œå‡†å¤‡æäº¤..."
            COMMIT_TIME=$(TZ='America/Los_Angeles' date '+%Y-%m-%d %I:%M %p PST')
            
            # åˆ›å»ºæäº¤
            git commit -m "auto: åŒæ­¥SVTRé£ä¹¦çŸ¥è¯†åº“ - $COMMIT_TIME

            ğŸ¤– è‡ªåŠ¨åŒæ­¥æŠ¥å‘Š:
            - åŒæ­¥æ—¶é—´: $COMMIT_TIME (ç¾è¥¿æ—¶é—´)
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            - å·¥ä½œæµ: GitHub Actions
            
            ğŸ“Š Generated with SVTR.AI AutoSync" || {
              echo "âŒ æäº¤å¤±è´¥"
              exit 1
            }
            
            # æ¨é€æ›´æ”¹ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•
            echo "ğŸ“¤ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
            for i in {1..3}; do
              if git push; then
                echo "âœ… æˆåŠŸæäº¤æ•°æ®æ›´æ–° (å°è¯• $i/3)"
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå°è¯• $i/3"
                if [ $i -eq 3 ]; then
                  echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡"
                  exit 128
                fi
                git fetch origin main
                git rebase origin/main || {
                  echo "âŒ Rebaseå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³å†²çª"
                  exit 128
                }
              fi
            done
          fi
          
      - name: åŒæ­¥çŠ¶æ€é€šçŸ¥
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "ğŸ‰ SVTRé£ä¹¦çŸ¥è¯†åº“åŒæ­¥æˆåŠŸå®Œæˆï¼"
            echo "â° ä¸‹æ¬¡åŒæ­¥æ—¶é—´: ç¾è¥¿æ—¶é—´æ˜å¤©æ™šä¸Š12:00"
          else
            echo "âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
            echo "ğŸ”§ è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨ä¿®å¤"
          fi