name: ğŸ” èèµ„æ•°æ®è´¨é‡æ£€æŸ¥

on:
  schedule:
    # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ (åŒ—äº¬æ—¶é—´: 2:00, 8:00, 14:00, 20:00)
    - cron: '0 */6 * * *'

  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

  # æ•°æ®æºæ›´æ–°åè‡ªåŠ¨æ£€æŸ¥
  repository_dispatch:
    types: [data_updated]

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” æ‰§è¡Œæ•°æ®è´¨é‡æ£€æŸ¥
        id: check
        run: |
          node scripts/check-funding-data-quality.js
          echo "check_result=$?" >> $GITHUB_OUTPUT

      - name: ğŸ“Š æ£€æŸ¥ç»“æœæ‘˜è¦
        if: always()
        run: |
          if [ "${{ steps.check.outputs.check_result }}" == "0" ]; then
            echo "âœ… æ•°æ®è´¨é‡æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æ•°æ®è´¨é‡æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš¨ åˆ›å»ºIssue (å¤±è´¥æ—¶)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date().toISOString();
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ AIåˆ›æŠ•æ—¥æŠ¥æ•°æ®è´¨é‡æ£€æŸ¥å¤±è´¥',
              labels: ['data-quality', 'automated', 'bug'],
              body: `## ğŸš¨ æ•°æ®è´¨é‡æ£€æŸ¥å¤±è´¥

            **æ£€æŸ¥æ—¶é—´**: ${now}
            **å·¥ä½œæµ**: [æŸ¥çœ‹æ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ## ğŸ“‹ å¯èƒ½åŸå› 

            1. **ç¼“å­˜æœªåˆ·æ–°**: APIè¿”å›æ—§ç¼“å­˜æ•°æ®
            2. **å­—æ®µæ˜ å°„å˜æ›´**: é£ä¹¦æ•°æ®æºå­—æ®µç»“æ„æ”¹å˜
            3. **æå–é€»è¾‘å¤±æ•ˆ**: æ­£åˆ™è¡¨è¾¾å¼æ— æ³•åŒ¹é…æ–°æ ¼å¼
            4. **æ•°æ®æºå¼‚å¸¸**: é£ä¹¦APIè¿”å›ç©ºæ•°æ®æˆ–é”™è¯¯

            ## ğŸ”§ æ’æŸ¥æ­¥éª¤

            ### 1. æ£€æŸ¥é£ä¹¦åŸå§‹æ•°æ®
            \`\`\`bash
            curl "https://svtr.ai/api/wiki-funding-sync?force=true&refresh=true" | jq '.source'
            \`\`\`

            åº”è¯¥è¿”å› \`"real-time"\`ï¼Œå¦‚æœæ˜¯ \`"cache"\` è¯´æ˜ç¼“å­˜åˆ·æ–°å¤±è´¥ã€‚

            ### 2. æœ¬åœ°è¿è¡Œæ£€æŸ¥è„šæœ¬
            \`\`\`bash
            node scripts/check-funding-data-quality.js
            \`\`\`

            ### 3. æ‰‹åŠ¨æ¸…é™¤KVç¼“å­˜
            1. è®¿é—® [Cloudflare Dashboard](https://dash.cloudflare.com/)
            2. Workers & Pages â†’ KV â†’ SVTR_CACHE
            3. åˆ é™¤ key: \`wiki-funding-real-data-v3\`

            ### 4. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
            - [æ•°æ®æ›´æ–°æŒ‡å—](./docs/FUNDING_DAILY_DATA_UPDATE_GUIDE.md)
            - [å¥åº·ç›‘æ§æŒ‡å—](./docs/FUNDING_DAILY_HEALTH_GUIDE.md)

            ---

            ğŸ¤– æ­¤Issueç”±GitHub Actionsè‡ªåŠ¨åˆ›å»º
            `
            });

      - name: ğŸ“¢ é€šçŸ¥æˆåŠŸ (å¯é€‰)
        if: success()
        run: |
          echo "âœ… æ•°æ®è´¨é‡æ£€æŸ¥é€šè¿‡ï¼Œæ— éœ€å¹²é¢„"
