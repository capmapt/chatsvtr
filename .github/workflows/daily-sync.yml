name: Daily RAG Data Sync

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´18:00 (åŒ—äº¬æ—¶é—´02:00) è‡ªåŠ¨åŒæ­¥
    - cron: '0 18 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sync_type:
        description: 'Sync type (smart/complete/enhanced)'
        required: false
        default: 'smart'

jobs:
  sync-rag-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Configure environment
      run: |
        echo "FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}" >> $GITHUB_ENV
        echo "FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}" >> $GITHUB_ENV
        echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
        
    - name: Run smart sync strategy
      run: |
        echo "ğŸš€ å¼€å§‹æ¯æ—¥æ™ºèƒ½åŒæ­¥..."
        npm run sync
        
    - name: Check sync results
      run: |
        echo "ğŸ“Š åŒæ­¥ç»“æœæ£€æŸ¥:"
        if [ -f "assets/data/rag/enhanced-feishu-full-content.json" ]; then
          echo "âœ… RAGæ•°æ®æ–‡ä»¶å­˜åœ¨"
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h assets/data/rag/enhanced-feishu-full-content.json)"
          echo "ğŸ• æœ€åä¿®æ”¹: $(stat -c %y assets/data/rag/enhanced-feishu-full-content.json)"
        else
          echo "âŒ RAGæ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -n "$(git status --porcelain)" ]; then
          git add assets/data/rag/
          git commit -m "ğŸ”„ æ¯æ—¥è‡ªåŠ¨åŒæ­¥RAGæ•°æ® - $(date +'%Y-%m-%d %H:%M UTC')"
          git push
          echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
        else
          echo "â„¹ï¸ æ— æ•°æ®å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi
        
    - name: Deploy to Cloudflare (if data changed)
      if: success()
      run: |
        echo "ğŸš€ æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°éƒ¨ç½²..."
        if [ -n "$(git log --oneline -1 | grep 'æ¯æ—¥è‡ªåŠ¨åŒæ­¥')" ]; then
          echo "ğŸ“Š æ•°æ®å·²æ›´æ–°ï¼Œè§¦å‘é‡æ–°éƒ¨ç½²"
          npx wrangler pages deploy --commit-dirty=true
          echo "âœ… å·²éƒ¨ç½²æœ€æ–°æ•°æ®åˆ°ç”Ÿäº§ç¯å¢ƒ"
        else
          echo "â„¹ï¸ æ•°æ®æ— å˜æ›´ï¼Œè·³è¿‡éƒ¨ç½²"
        fi
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Send notification (optional)
      if: failure()
      run: |
        echo "âŒ æ¯æ—¥åŒæ­¥å¤±è´¥ï¼Œéœ€è¦äººå·¥æ£€æŸ¥"
        # å¯ä»¥æ·»åŠ Slack/Discordé€šçŸ¥
        
    - name: Summary
      run: |
        echo "ğŸ“‹ æ¯æ—¥åŒæ­¥ä»»åŠ¡å®Œæˆ"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date)"
        echo "ğŸ”„ ä¸‹æ¬¡åŒæ­¥: æ˜å¤©UTC 18:00 (åŒ—äº¬æ—¶é—´02:00)"