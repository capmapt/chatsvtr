name: ğŸ“Š Daily Trading Picks Sync

on:
  schedule:
    # æ¯å¤©UTC 18:00 (åŒ—äº¬æ—¶é—´å‡Œæ™¨02:00)æ‰§è¡Œ
    - cron: '0 18 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»å‹'
        required: true
        default: 'smart'
        type: choice
        options:
        - smart
        - complete
        - trading_only

env:
  # é£ä¹¦APIé…ç½®
  FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
  FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}

permissions:
  contents: write
  actions: read
  pull-requests: write
  issues: write

jobs:
  sync-trading-data:
    name: ğŸ”„ åŒæ­¥äº¤æ˜“ç²¾é€‰æ•°æ®
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          npm install --save dotenv

      - name: ğŸ” Setup Environment
        run: |
          echo "FEISHU_APP_ID=${{ secrets.FEISHU_APP_ID }}" > .env
          echo "FEISHU_APP_SECRET=${{ secrets.FEISHU_APP_SECRET }}" >> .env

      - name: ğŸ“Š Sync Trading Picks Data
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥äº¤æ˜“ç²¾é€‰æ•°æ®..."
          
          # æ ¹æ®è¾“å…¥é€‰æ‹©åŒæ­¥ç±»å‹
          SYNC_TYPE="${{ github.event.inputs.sync_type || 'smart' }}"
          
          case $SYNC_TYPE in
            "complete")
              echo "æ‰§è¡Œå®Œæ•´åŒæ­¥..."
              npm run sync:complete
              ;;
            "trading_only")
              echo "åªåŒæ­¥äº¤æ˜“ç²¾é€‰æ•°æ®..."
              node scripts/sync-trading-picks-only.js
              ;;
            *)
              echo "æ‰§è¡Œæ™ºèƒ½åŒæ­¥..."
              npm run sync || node scripts/sync-trading-picks-only.js
              ;;
          esac

      - name: ğŸ”„ Convert Data for Web
        run: |
          echo "ğŸ”„ è½¬æ¢æ•°æ®æ ¼å¼..."
          node scripts/convert-trading-picks-for-web.js
      - name: ğŸ“ Check for Changes
        id: check_changes
        run: |
          echo "ğŸ” æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git add .
          
          echo "ğŸ“‹ GitçŠ¶æ€ï¼š"
          git status --porcelain
          
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ æ²¡æœ‰æ•°æ®æ›´æ–°"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ æ£€æµ‹åˆ°æ•°æ®æ›´æ–°"
            echo "ğŸ“‹ æš‚å­˜çš„å˜æ›´ï¼š"
            git diff --staged --name-only
          fi

      - name: ğŸ’¾ Commit and Push Changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "ğŸ”§ é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          echo "ğŸ“ å‡†å¤‡æäº¤..."
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          echo "ğŸ’¾ æ‰§è¡Œæäº¤..."
          git commit -m "chore: ğŸ“Š æ¯æ—¥äº¤æ˜“ç²¾é€‰æ•°æ®åŒæ­¥ - $TIMESTAMP" \
                     -m "" \
                     -m "ğŸ¤– Generated with [Claude Code](https://claude.ai/code)" \
                     -m "" \
                     -m "Co-Authored-By: Claude <noreply@anthropic.com>"
          
          echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git push origin main || {
            echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ›¿ä»£æ–¹æ³•..."
            git remote set-url origin https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git
            git push origin main
          }
          
          echo "âœ… æ¨é€å®Œæˆ"

      - name: ğŸ“ˆ Generate Sync Report
        if: always()
        run: |
          echo "## ğŸ“Š æ¯æ—¥åŒæ­¥æŠ¥å‘Š" >> sync_report.md
          echo "**æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> sync_report.md
          echo "**åŒæ­¥ç±»å‹**: ${{ github.event.inputs.sync_type || 'smart' }}" >> sync_report.md
          echo "**æ•°æ®æ›´æ–°**: ${{ steps.check_changes.outputs.changes || 'unknown' }}" >> sync_report.md
          echo "**çŠ¶æ€**: ${{ job.status }}" >> sync_report.md
          echo "" >> sync_report.md
          echo "### æ•°æ®ç»Ÿè®¡" >> sync_report.md
          
          # æ£€æŸ¥æ•°æ®æ–‡ä»¶
          if [ -f "assets/data/trading-picks.json" ]; then
            COMPANY_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('assets/data/trading-picks.json')).meta.totalCompanies)")
            echo "- å…¬å¸æ•°é‡: $COMPANY_COUNT" >> sync_report.md
          fi
          
          if [ -f "assets/data/rag/enhanced-feishu-full-content.json" ]; then
            NODE_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('assets/data/rag/enhanced-feishu-full-content.json')).summary.totalNodes)")
            echo "- æ€»èŠ‚ç‚¹æ•°: $NODE_COUNT" >> sync_report.md
          fi
          
          cat sync_report.md

      - name: ğŸš€ Deploy to Cloudflare (if changed)
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "ğŸš€ æ•°æ®æ›´æ–°ï¼Œè§¦å‘Cloudflareéƒ¨ç½²..."
          # æ³¨æ„: è¿™é‡Œéœ€è¦é…ç½®Cloudflareéƒ¨ç½²å¯†é’¥
          # npx wrangler pages deploy . --project-name=chatsvtr
          echo "âœ… éƒ¨ç½²å®Œæˆï¼ˆå¦‚æœé…ç½®äº†Cloudflareå¯†é’¥ï¼‰"