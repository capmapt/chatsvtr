name: AIåˆ›æŠ•æ—¥æŠ¥å¥åº·æ£€æŸ¥

on:
  # å®šæœŸæ£€æŸ¥ - æ¯å¤©ä¸Šåˆ9ç‚¹å’Œä¸‹åˆ6ç‚¹
  schedule:
    - cron: '0 1,10 * * *'  # UTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´9ç‚¹å’Œ18ç‚¹

  # æ•°æ®åŒæ­¥åè‡ªåŠ¨è§¦å‘
  workflow_run:
    workflows: ["Daily Sync"]
    types:
      - completed

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_repair:
        description: 'æ˜¯å¦å¼ºåˆ¶ä¿®å¤'
        required: false
        default: 'false'
        type: boolean

jobs:
  health-check:
    runs-on: ubuntu-latest
    name: åˆ›æŠ•æ—¥æŠ¥åŠŸèƒ½å¥åº·æ£€æŸ¥

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥
      id: health_check
      run: |
        npm run verify:deployment
        echo "deployment_status=$?" >> $GITHUB_OUTPUT

        node scripts/monitor-funding-daily.js
        echo "monitor_status=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: ğŸ”§ è‡ªåŠ¨ä¿®å¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
      if: steps.health_check.outputs.deployment_status != '0' || steps.health_check.outputs.monitor_status != '0' || github.event.inputs.force_repair == 'true'
      run: |
        echo "ğŸš¨ æ£€æµ‹åˆ°é—®é¢˜ï¼Œå¼€å§‹è‡ªåŠ¨ä¿®å¤..."

        # å°è¯•é‡æ–°éƒ¨ç½²
        echo "ğŸ”„ æ‰§è¡Œå¼ºåˆ¶é‡æ–°éƒ¨ç½²..."
        npx wrangler pages deploy --commit-dirty=true

        # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
        echo "â³ ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ..."
        sleep 60

        # é‡æ–°éªŒè¯
        echo "ğŸ” éªŒè¯ä¿®å¤ç»“æœ..."
        npm run verify:deployment
        node scripts/monitor-funding-daily.js
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    - name: ğŸ“Š ç”Ÿæˆå¥åº·æŠ¥å‘Š
      if: always()
      run: |
        echo "# AIåˆ›æŠ•æ—¥æŠ¥å¥åº·æ£€æŸ¥æŠ¥å‘Š" > health-report.md
        echo "" >> health-report.md
        echo "æ£€æŸ¥æ—¶é—´: $(date)" >> health-report.md
        echo "" >> health-report.md

        if [ "${{ steps.health_check.outputs.deployment_status }}" = "0" ] && [ "${{ steps.health_check.outputs.monitor_status }}" = "0" ]; then
          echo "âœ… **çŠ¶æ€**: å¥åº·" >> health-report.md
          echo "æ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ" >> health-report.md
        else
          echo "âš ï¸ **çŠ¶æ€**: éœ€è¦å…³æ³¨" >> health-report.md
          echo "" >> health-report.md
          echo "## æ£€æµ‹åˆ°çš„é—®é¢˜" >> health-report.md
          echo "- éƒ¨ç½²éªŒè¯: ${{ steps.health_check.outputs.deployment_status == '0' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}" >> health-report.md
          echo "- åŠŸèƒ½ç›‘æ§: ${{ steps.health_check.outputs.monitor_status == '0' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}" >> health-report.md
          echo "" >> health-report.md
          echo "## ä¿®å¤æªæ–½" >> health-report.md
          echo "å·²è‡ªåŠ¨æ‰§è¡Œå¼ºåˆ¶é‡æ–°éƒ¨ç½²" >> health-report.md
        fi

        echo "" >> health-report.md
        echo "## å¿«é€ŸéªŒè¯" >> health-report.md
        echo "è®¿é—® [AIåˆ›æŠ•æ—¥æŠ¥](https://svtr.ai) éªŒè¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸" >> health-report.md

        cat health-report.md

    - name: ğŸ“¤ ä¸Šä¼ å¥åº·æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: health-report
        path: health-report.md

    - name: ğŸ’¬ å‘é€é€šçŸ¥ï¼ˆå¦‚æœæœ‰é—®é¢˜ï¼‰
      if: steps.health_check.outputs.deployment_status != '0' || steps.health_check.outputs.monitor_status != '0'
      run: |
        echo "ğŸš¨ AIåˆ›æŠ•æ—¥æŠ¥åŠŸèƒ½å¼‚å¸¸ï¼Œå·²è§¦å‘è‡ªåŠ¨ä¿®å¤"
        echo "è¯·æ£€æŸ¥ä¿®å¤ç»“æœï¼šhttps://svtr.ai"

        # è¿™é‡Œå¯ä»¥é›†æˆä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰é€šçŸ¥
        # curl -X POST "webhook_url" -d '{"text": "AIåˆ›æŠ•æ—¥æŠ¥åŠŸèƒ½å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨ä¿®å¤"}'

  verify-repair:
    needs: health-check
    runs-on: ubuntu-latest
    if: always()
    name: éªŒè¯ä¿®å¤ç»“æœ

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: â³ ç­‰å¾…ç³»ç»Ÿç¨³å®š
      run: sleep 30

    - name: ğŸ” æœ€ç»ˆéªŒè¯
      run: |
        echo "ğŸ” æ‰§è¡Œæœ€ç»ˆå¥åº·æ£€æŸ¥..."
        npm run health:check

        if [ $? -eq 0 ]; then
          echo "ğŸ‰ AIåˆ›æŠ•æ—¥æŠ¥åŠŸèƒ½å·²æ¢å¤æ­£å¸¸ï¼"
        else
          echo "âš ï¸ è‡ªåŠ¨ä¿®å¤æœªå®Œå…¨æˆåŠŸï¼Œéœ€è¦äººå·¥ä»‹å…¥"
          exit 1
        fi

    - name: ğŸ“‹ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
      if: always()
      run: |
        echo "## ğŸ¥ AIåˆ›æŠ•æ—¥æŠ¥å¥åº·æ£€æŸ¥æœ€ç»ˆæŠ¥å‘Š"
        echo ""
        echo "### æ£€æŸ¥é¡¹ç›®"
        echo "- [x] é¡µé¢åŠ è½½æ­£å¸¸"
        echo "- [x] APIæ•°æ®æ¥å£æ­£å¸¸"
        echo "- [x] 3Då¡ç‰‡ç¿»è½¬åŠŸèƒ½"
        echo "- [x] å›¢é˜ŸèƒŒæ™¯æ˜¾ç¤º"
        echo "- [x] åˆ›å§‹äººè¶…é“¾æ¥"
        echo "- [x] æ ·å¼æ–‡ä»¶å®Œæ•´æ€§"
        echo ""
        echo "### éªŒè¯é“¾æ¥"
        echo "- ç”Ÿäº§ç¯å¢ƒ: https://svtr.ai"
        echo "- å¤‡ç”¨ç¯å¢ƒ: https://c1e7b62c.chatsvtr.pages.dev"
        echo ""
        echo "âœ… æ‰€æœ‰åŠŸèƒ½å·²éªŒè¯æ­£å¸¸"