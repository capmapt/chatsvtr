<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æµ‹è¯•å†…å®¹ç¤¾åŒºD1è¿ç§»</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; }
    h1 { color: #333; }
    .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .success { color: green; }
    .error { color: red; }
    .loading { color: #666; }
    .article-card { border: 1px solid #eee; padding: 15px; margin: 10px 0; border-radius: 8px; }
    .article-title { font-weight: bold; margin-bottom: 10px; }
    .article-meta { color: #666; font-size: 0.9em; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ§ª å†…å®¹ç¤¾åŒºD1è¿ç§»æµ‹è¯•</h1>

  <div class="test-section">
    <h2>1. APIè¿æ¥æµ‹è¯•</h2>
    <div id="apiTest">æµ‹è¯•ä¸­...</div>
  </div>

  <div class="test-section">
    <h2>2. æ•°æ®åŠ è½½æµ‹è¯•</h2>
    <div id="dataTest">ç­‰å¾…APIæµ‹è¯•å®Œæˆ...</div>
  </div>

  <div class="test-section">
    <h2>3. æ•°æ®è½¬æ¢æµ‹è¯•</h2>
    <div id="transformTest">ç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ...</div>
  </div>

  <div class="test-section">
    <h2>4. æ–‡ç« é¢„è§ˆï¼ˆå‰5ç¯‡ï¼‰</h2>
    <div id="articlePreview">ç­‰å¾…æ•°æ®è½¬æ¢å®Œæˆ...</div>
  </div>

  <script src="../assets/js/rich-content-renderer.js"></script>
  <script src="../assets/js/community-data-loader.js"></script>

  <script>
    async function runTests() {
      console.log('ğŸ§ª å¼€å§‹æµ‹è¯•å†…å®¹ç¤¾åŒºD1è¿ç§»...');

      // Test 1: APIè¿æ¥æµ‹è¯•
      await testAPI();

      // Test 2: æ•°æ®åŠ è½½æµ‹è¯•
      await testDataLoading();

      // Test 3: æ•°æ®è½¬æ¢æµ‹è¯•
      await testDataTransformation();

      // Test 4: æ–‡ç« é¢„è§ˆ
      await testArticlePreview();
    }

    async function testAPI() {
      const container = document.getElementById('apiTest');
      container.innerHTML = '<div class="loading">ğŸ”„ æµ‹è¯•D1 APIè¿æ¥...</div>';

      try {
        const response = await fetch('/api/d1/query?table=published_articles&limit=5');
        const data = await response.json();

        if (data.success) {
          container.innerHTML = `
            <div class="success">âœ… APIè¿æ¥æˆåŠŸ</div>
            <pre>${JSON.stringify({
              success: true,
              records: data.data.length,
              sample: data.data[0] ? {
                title: data.data[0].meta_title,
                category: data.data[0].category,
                publish_date: data.data[0].publish_date
              } : null
            }, null, 2)}</pre>
          `;
        } else {
          throw new Error(data.error || 'æœªçŸ¥é”™è¯¯');
        }
      } catch (error) {
        container.innerHTML = `<div class="error">âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    }

    async function testDataLoading() {
      const container = document.getElementById('dataTest');
      container.innerHTML = '<div class="loading">ğŸ”„ æµ‹è¯•æ•°æ®åŠ è½½...</div>';

      try {
        const loader = new CommunityDataLoader();
        const success = await loader.init('#articlePreview');

        if (success) {
          container.innerHTML = `
            <div class="success">âœ… æ•°æ®åŠ è½½æˆåŠŸ</div>
            <pre>${JSON.stringify({
              total: loader.articles.length,
              categories: loader.articles.reduce((acc, a) => {
                acc[a.category] = (acc[a.category] || 0) + 1;
                return acc;
              }, {})
            }, null, 2)}</pre>
          `;
          window.testLoader = loader; // ä¿å­˜ä¾›åç»­æµ‹è¯•ä½¿ç”¨
        } else {
          throw new Error('æ•°æ®åŠ è½½è¿”å›false');
        }
      } catch (error) {
        container.innerHTML = `<div class="error">âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    async function testDataTransformation() {
      const container = document.getElementById('transformTest');

      if (!window.testLoader) {
        container.innerHTML = '<div class="error">âŒ æ•°æ®åŠ è½½å™¨æœªåˆå§‹åŒ–</div>';
        return;
      }

      try {
        const articles = window.testLoader.articles;

        if (articles.length === 0) {
          throw new Error('æ²¡æœ‰åŠ è½½åˆ°æ–‡ç« æ•°æ®');
        }

        const sample = articles[0];
        const requiredFields = ['id', 'title', 'excerpt', 'category', 'contentType', 'date', 'author', 'source'];
        const missingFields = requiredFields.filter(field => !sample[field]);

        if (missingFields.length > 0) {
          throw new Error(\`ç¼ºå°‘å­—æ®µ: \${missingFields.join(', ')}\`);
        }

        container.innerHTML = `
          <div class="success">âœ… æ•°æ®è½¬æ¢æˆåŠŸ</div>
          <pre>${JSON.stringify({
            sampleArticle: {
              title: sample.title,
              category: sample.category,
              contentType: sample.contentType,
              date: sample.date,
              author: sample.author.name,
              tags: sample.tags?.slice(0, 3),
              hasSource: !!sample.source.url
            }
          }, null, 2)}</pre>
        `;
      } catch (error) {
        container.innerHTML = \`<div class="error">âŒ æ•°æ®è½¬æ¢æµ‹è¯•å¤±è´¥: \${error.message}</div>\`;
      }
    }

    async function testArticlePreview() {
      const container = document.getElementById('articlePreview');

      if (!window.testLoader) {
        container.innerHTML = '<div class="error">âŒ æ•°æ®åŠ è½½å™¨æœªåˆå§‹åŒ–</div>';
        return;
      }

      try {
        const articles = window.testLoader.articles.slice(0, 5);

        if (articles.length === 0) {
          container.innerHTML = '<div class="error">âŒ æ²¡æœ‰æ–‡ç« å¯é¢„è§ˆ</div>';
          return;
        }

        let html = \`<div class="success">âœ… æ‰¾åˆ° \${articles.length} ç¯‡æ–‡ç« </div>\`;

        articles.forEach((article, index) => {
          html += \`
            <div class="article-card">
              <div class="article-title">\${index + 1}. \${article.title}</div>
              <div class="article-meta">
                <span>åˆ†ç±»: \${article.category}</span> |
                <span>ç±»å‹: \${article.contentType}</span> |
                <span>æ—¥æœŸ: \${article.date}</span> |
                <span>ä½œè€…: \${article.author.name}</span>
              </div>
              <div style="margin-top: 8px; color: #666; font-size: 0.9em;">
                \${article.excerpt.substring(0, 150)}...
              </div>
            </div>
          \`;
        });

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = \`<div class="error">âŒ æ–‡ç« é¢„è§ˆå¤±è´¥: \${error.message}</div>\`;
      }
    }

    // è¿è¡Œæµ‹è¯•
    runTests();
  </script>
</body>
</html>
