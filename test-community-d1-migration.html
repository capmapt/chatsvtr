<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>测试内容社区D1迁移</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; }
    h1 { color: #333; }
    .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .success { color: green; }
    .error { color: red; }
    .loading { color: #666; }
    .article-card { border: 1px solid #eee; padding: 15px; margin: 10px 0; border-radius: 8px; }
    .article-title { font-weight: bold; margin-bottom: 10px; }
    .article-meta { color: #666; font-size: 0.9em; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>🧪 内容社区D1迁移测试</h1>

  <div class="test-section">
    <h2>1. API连接测试</h2>
    <div id="apiTest">测试中...</div>
  </div>

  <div class="test-section">
    <h2>2. 数据加载测试</h2>
    <div id="dataTest">等待API测试完成...</div>
  </div>

  <div class="test-section">
    <h2>3. 数据转换测试</h2>
    <div id="transformTest">等待数据加载完成...</div>
  </div>

  <div class="test-section">
    <h2>4. 文章预览（前5篇）</h2>
    <div id="articlePreview">等待数据转换完成...</div>
  </div>

  <script src="../assets/js/rich-content-renderer.js"></script>
  <script src="../assets/js/community-data-loader.js"></script>

  <script>
    async function runTests() {
      console.log('🧪 开始测试内容社区D1迁移...');

      // Test 1: API连接测试
      await testAPI();

      // Test 2: 数据加载测试
      await testDataLoading();

      // Test 3: 数据转换测试
      await testDataTransformation();

      // Test 4: 文章预览
      await testArticlePreview();
    }

    async function testAPI() {
      const container = document.getElementById('apiTest');
      container.innerHTML = '<div class="loading">🔄 测试D1 API连接...</div>';

      try {
        const response = await fetch('/api/d1/query?table=published_articles&limit=5');
        const data = await response.json();

        if (data.success) {
          container.innerHTML = `
            <div class="success">✅ API连接成功</div>
            <pre>${JSON.stringify({
              success: true,
              records: data.data.length,
              sample: data.data[0] ? {
                title: data.data[0].meta_title,
                category: data.data[0].category,
                publish_date: data.data[0].publish_date
              } : null
            }, null, 2)}</pre>
          `;
        } else {
          throw new Error(data.error || '未知错误');
        }
      } catch (error) {
        container.innerHTML = `<div class="error">❌ API测试失败: ${error.message}</div>`;
      }
    }

    async function testDataLoading() {
      const container = document.getElementById('dataTest');
      container.innerHTML = '<div class="loading">🔄 测试数据加载...</div>';

      try {
        const loader = new CommunityDataLoader();
        const success = await loader.init('#articlePreview');

        if (success) {
          container.innerHTML = `
            <div class="success">✅ 数据加载成功</div>
            <pre>${JSON.stringify({
              total: loader.articles.length,
              categories: loader.articles.reduce((acc, a) => {
                acc[a.category] = (acc[a.category] || 0) + 1;
                return acc;
              }, {})
            }, null, 2)}</pre>
          `;
          window.testLoader = loader; // 保存供后续测试使用
        } else {
          throw new Error('数据加载返回false');
        }
      } catch (error) {
        container.innerHTML = `<div class="error">❌ 数据加载失败: ${error.message}</div>`;
      }
    }

    async function testDataTransformation() {
      const container = document.getElementById('transformTest');

      if (!window.testLoader) {
        container.innerHTML = '<div class="error">❌ 数据加载器未初始化</div>';
        return;
      }

      try {
        const articles = window.testLoader.articles;

        if (articles.length === 0) {
          throw new Error('没有加载到文章数据');
        }

        const sample = articles[0];
        const requiredFields = ['id', 'title', 'excerpt', 'category', 'contentType', 'date', 'author', 'source'];
        const missingFields = requiredFields.filter(field => !sample[field]);

        if (missingFields.length > 0) {
          throw new Error(\`缺少字段: \${missingFields.join(', ')}\`);
        }

        container.innerHTML = `
          <div class="success">✅ 数据转换成功</div>
          <pre>${JSON.stringify({
            sampleArticle: {
              title: sample.title,
              category: sample.category,
              contentType: sample.contentType,
              date: sample.date,
              author: sample.author.name,
              tags: sample.tags?.slice(0, 3),
              hasSource: !!sample.source.url
            }
          }, null, 2)}</pre>
        `;
      } catch (error) {
        container.innerHTML = \`<div class="error">❌ 数据转换测试失败: \${error.message}</div>\`;
      }
    }

    async function testArticlePreview() {
      const container = document.getElementById('articlePreview');

      if (!window.testLoader) {
        container.innerHTML = '<div class="error">❌ 数据加载器未初始化</div>';
        return;
      }

      try {
        const articles = window.testLoader.articles.slice(0, 5);

        if (articles.length === 0) {
          container.innerHTML = '<div class="error">❌ 没有文章可预览</div>';
          return;
        }

        let html = \`<div class="success">✅ 找到 \${articles.length} 篇文章</div>\`;

        articles.forEach((article, index) => {
          html += \`
            <div class="article-card">
              <div class="article-title">\${index + 1}. \${article.title}</div>
              <div class="article-meta">
                <span>分类: \${article.category}</span> |
                <span>类型: \${article.contentType}</span> |
                <span>日期: \${article.date}</span> |
                <span>作者: \${article.author.name}</span>
              </div>
              <div style="margin-top: 8px; color: #666; font-size: 0.9em;">
                \${article.excerpt.substring(0, 150)}...
              </div>
            </div>
          \`;
        });

        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = \`<div class="error">❌ 文章预览失败: \${error.message}</div>\`;
      }
    }

    // 运行测试
    runTests();
  </script>
</body>
</html>
