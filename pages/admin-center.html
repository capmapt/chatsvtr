<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVTR 管理中心</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        
        /* 侧边栏 */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .nav-menu {
            padding: 20px 0;
        }
        
        .nav-section {
            margin-bottom: 30px;
        }
        
        .nav-section-title {
            padding: 0 20px 10px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.6;
            font-weight: 600;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .nav-item.active {
            background: rgba(255,255,255,0.2);
            border-right: 3px solid white;
        }
        
        .nav-item-icon {
            font-size: 1.2rem;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        
        .nav-item-text {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* 子菜单样式 */
        .nav-item[style*="padding-left: 32px"] {
            background: rgba(255,255,255,0.05);
            border-left: 2px solid rgba(255,255,255,0.2);
            font-size: 0.85rem;
        }
        
        .nav-item[style*="padding-left: 32px"]:hover {
            background: rgba(255,255,255,0.15);
            border-left-color: rgba(255,255,255,0.4);
        }
        
        .nav-item[style*="padding-left: 32px"].active {
            background: rgba(255,255,255,0.25);
            border-left-color: white;
        }

        /* 订阅状态样式 */
        .subscription-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .subscription-badge.subscribed {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .subscription-badge.not-subscribed {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
            border: 1px solid rgba(107, 114, 128, 0.2);
        }
        
        /* 地理位置样式 */
        .location-icon {
            font-size: 1rem;
        }
        
        .location-text {
            font-size: 0.9rem;
            color: #374151;
        }
        
        /* 主内容区 */
        .main-content {
            margin-left: 260px;
            flex: 1;
            background: #f5f7fa;
        }
        
        .content-header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
        }
        
        .content-subtitle {
            font-size: 1rem;
            color: #666;
            margin-top: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .content-body {
            padding: 30px;
        }
        
        /* 仪表板卡片 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e1e5e9;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-icon {
            font-size: 2rem;
            margin-right: 15px;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .card-description {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
        }
        
        .card-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 0.85rem;
        }
        
        .trend-up {
            color: #10a37f;
        }
        
        .trend-down {
            color: #d73502;
        }
        
        /* 内容模块 */
        .content-module {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e1e5e9;
            overflow: hidden;
            display: none;
        }
        
        .content-module.active {
            display: block;
        }
        
        .module-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .module-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .module-subtitle {
            font-size: 0.9rem;
            color: #666;
        }
        
        .module-content {
            padding: 25px;
        }
        
        /* 表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        
        /* 可排序表头样式 */
        .sortable-header {
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .sortable-header:hover {
            background-color: #e9ecef;
        }
        
        .sortable-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid #999;
            opacity: 0.5;
        }
        
        .sortable-header.sort-asc::after {
            border-bottom: 6px solid #007bff;
            border-top: none;
            opacity: 1;
        }
        
        .sortable-header.sort-desc::after {
            border-top: 6px solid #007bff;
            border-bottom: none;
            opacity: 1;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* 订阅管理专用样式 */
        .email-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .email-cell small {
            color: #666;
            font-size: 0.75rem;
        }

        .preferences-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .preference-tag {
            background: #e3f2fd;
            color: #1565c0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .language-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .language-badge.zh {
            background: #ffebee;
            color: #c62828;
        }

        .language-badge.en {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .date-cell {
            font-family: monospace;
            font-size: 0.85rem;
        }

        .ip-cell {
            font-family: monospace;
            font-size: 0.8rem;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
        }

        .btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-info {
            background: #e3f2fd;
            color: #1565c0;
        }

        .btn-info:hover {
            background: #bbdefb;
        }

        .btn-danger {
            background: #ffebee;
            color: #c62828;
        }

        .btn-danger:hover {
            background: #ffcdd2;
        }

        .module-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .toolbar-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-actions {
            display: flex;
            gap: 10px;
        }

        .table-info {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #666;
            text-align: center;
        }
        
        /* 状态标签 */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .status-inactive {
            background: #ffebee;
            color: #d32f2f;
        }
        
        /* 移动端响应式 */
        .mobile-menu-btn {
            display: none;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .content-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .content-body {
                padding: 20px;
            }
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* 加载状态 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e1e5e9;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- 侧边栏 -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>🚀 SVTR</h1>
                <p>管理中心</p>
            </div>
            
            <div class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">概览</div>
                    <a class="nav-item active" onclick="showModule('dashboard')">
                        <span class="nav-item-icon">📊</span>
                        <span class="nav-item-text">仪表板</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">内容管理</div>
                    <a class="nav-item" onclick="showModule('content')">
                        <span class="nav-item-icon">✍️</span>
                        <span class="nav-item-text">内容创作</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">平台管理</div>
                    <a class="nav-item" onclick="showModule('users')">
                        <span class="nav-item-icon">👥</span>
                        <span class="nav-item-text">用户管理</span>
                    </a>
                    <a class="nav-item" onclick="showModule('subscription')">
                        <span class="nav-item-icon">📧</span>
                        <span class="nav-item-text">订阅管理</span>
                    </a>
                    <a class="nav-item" onclick="showModule('projects')">
                        <span class="nav-item-icon">💼</span>
                        <span class="nav-item-text">项目管理</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">数据分析</div>
                    <a class="nav-item" onclick="showModule('analytics')">
                        <span class="nav-item-icon">📈</span>
                        <span class="nav-item-text">数据分析</span>
                    </a>
                    <a class="nav-item" onclick="showModule('reports')">
                        <span class="nav-item-icon">📋</span>
                        <span class="nav-item-text">报告生成</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">系统</div>
                    <a class="nav-item" onclick="showModule('settings')">
                        <span class="nav-item-icon">⚙️</span>
                        <span class="nav-item-text">系统设置</span>
                    </a>
                    <a class="nav-item" onclick="showModule('logs')">
                        <span class="nav-item-icon">📝</span>
                        <span class="nav-item-text">操作日志</span>
                    </a>
                </div>
            </div>
        </nav>
        
        <!-- 主内容区 -->
        <main class="main-content">
            <header class="content-header">
                <div>
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                    <h1 class="content-title" id="pageTitle">仪表板</h1>
                    <p class="content-subtitle" id="pageSubtitle">SVTR 平台运营概览</p>
                </div>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="refreshData()">🔄 刷新</button>
                    <button class="btn-primary" onclick="showQuickActions()">⚡ 快捷操作</button>
                </div>
            </header>
            
            <div class="content-body">
                <!-- 仪表板模块 -->
                <div id="dashboard-module" class="content-module active">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="card-icon">👥</span>
                                <span class="card-title">注册用户</span>
                            </div>
                            <div class="card-value" id="totalUsers">-</div>
                            <div class="card-description">平台注册用户总数</div>
                            <div class="card-trend trend-up">
                                <span>↗ +12%</span>
                                <span>本月增长</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="card-icon">📧</span>
                                <span class="card-title">订阅用户</span>
                            </div>
                            <div class="card-value" id="subscribers">-</div>
                            <div class="card-description">AI周报订阅用户数</div>
                            <div class="card-trend trend-up">
                                <span>↗ +24%</span>
                                <span>本周增长</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="card-icon">💼</span>
                                <span class="card-title">总项目数</span>
                            </div>
                            <div class="card-value" id="totalProjects">-</div>
                            <div class="card-description">平台所有项目总数</div>
                            <div class="card-trend trend-up">
                                <span>↗ +8%</span>
                                <span>本月新增</span>
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <span class="card-icon">💰</span>
                                <span class="card-title">投资总额</span>
                            </div>
                            <div class="card-value" id="totalInvestment">-</div>
                            <div class="card-description">平台促成投资金额</div>
                            <div class="card-trend trend-up">
                                <span>↗ +18%</span>
                                <span>本季度增长</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="card-icon">📊</span>
                            <span class="card-title">最近活动</span>
                        </div>
                        <div id="recentActivities">
                            <div class="loading-spinner"></div>
                            <span style="margin-left: 10px;">加载最近活动...</span>
                        </div>
                    </div>
                </div>
                
                <!-- 内容创作模块 -->
                <div id="content-module" class="content-module">
                    <div class="module-header">
                        <div class="module-title">内容创作管理</div>
                        <div class="module-subtitle">管理AI周报、投资洞察等内容创作</div>
                    </div>
                    <div class="module-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">✍️</div>
                            <h3>内容创作功能</h3>
                            <p>正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 订阅管理模块 -->
                <div id="subscription-module" class="content-module">
                    <div class="module-header">
                        <div class="module-title">订阅管理</div>
                        <div class="module-subtitle">管理AI周报订阅者和相关数据</div>
                    </div>
                    <div class="module-content">
                        <!-- 订阅者统计卡片 -->
                        <div class="dashboard-grid" style="margin-bottom: 30px;">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">📧</span>
                                    <span class="card-title">总订阅者</span>
                                </div>
                                <div class="card-value" id="subscription-total-subscribers">-</div>
                                <div class="card-description">AI周报订阅用户</div>
                                <div class="card-trend trend-up">
                                    <span>↗ +24%</span>
                                    <span>本月增长</span>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">🇨🇳</span>
                                    <span class="card-title">中文用户</span>
                                </div>
                                <div class="card-value" id="subscription-zh-users">-</div>
                                <div class="card-description">中文订阅用户</div>
                                <div class="card-trend">
                                    <span id="subscription-zh-percentage">0%</span>
                                    <span>占比</span>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">🇺🇸</span>
                                    <span class="card-title">英文用户</span>
                                </div>
                                <div class="card-value" id="subscription-en-users">-</div>
                                <div class="card-description">英文订阅用户</div>
                                <div class="card-trend">
                                    <span id="subscription-en-percentage">0%</span>
                                    <span>占比</span>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">📈</span>
                                    <span class="card-title">今日新增</span>
                                </div>
                                <div class="card-value" id="subscription-today-new">-</div>
                                <div class="card-description">今日新增订阅</div>
                                <div class="card-trend trend-up">
                                    <span>+新增</span>
                                    <span>持续增长</span>
                                </div>
                            </div>
                        </div>

                        <!-- 订阅者管理操作区 -->
                        <div class="module-toolbar">
                            <div class="toolbar-filters">
                                <select id="subscriptionLanguageFilter" onchange="filterSubscriptions()" class="form-input" style="width: auto;">
                                    <option value="">所有语言</option>
                                    <option value="zh-CN">中文</option>
                                    <option value="en-US">英文</option>
                                </select>
                                <input type="text" id="subscriptionSearchInput" placeholder="搜索邮箱..." onkeyup="filterSubscriptions()" class="form-input" style="width: 200px;">
                                <input type="date" id="subscriptionDateFilter" onchange="filterSubscriptions()" class="form-input" style="width: auto;">
                            </div>
                            <div class="toolbar-actions">
                                <button class="btn-secondary" onclick="exportSubscriptions()">📥 导出数据</button>
                                <button class="btn-primary" onclick="refreshSubscriptions()">🔄 刷新</button>
                            </div>
                        </div>
                        
                        <!-- 订阅者列表 -->
                        <div id="subscriptionsTableContainer">
                            <div class="loading-spinner"></div>
                            <span style="margin-left: 10px;">加载订阅数据...</span>
                        </div>
                    </div>
                </div>
                
                <!-- 项目管理模块 -->
                <div id="projects-module" class="content-module">
                    <div class="module-header">
                        <div>
                            <div class="module-title">投资项目管理</div>
                            <div class="module-subtitle">管理平台上的所有投资项目和申请</div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn-secondary" onclick="loadProjectsData()" style="padding: 8px 16px; font-size: 14px;">
                                🔄 刷新数据
                            </button>
                            <small id="lastUpdateTime" style="color: #666; font-size: 12px;"></small>
                        </div>
                    </div>
                    <div class="module-content">
                        <!-- 项目统计卡片 -->
                        <div class="dashboard-grid" style="margin-bottom: 30px;">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">📊</span>
                                    <span class="card-title">总项目数</span>
                                </div>
                                <div class="card-value" id="totalProjectsCount">-</div>
                                <div class="card-description">平台所有项目</div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">✅</span>
                                    <span class="card-title">活跃项目</span>
                                </div>
                                <div class="card-value" id="activeProjectsCount">-</div>
                                <div class="card-description">正在进行的项目</div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">⏳</span>
                                    <span class="card-title">待审核</span>
                                </div>
                                <div class="card-value" id="pendingProjectsCount">-</div>
                                <div class="card-description">等待审核的项目</div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">💰</span>
                                    <span class="card-title">总融资额</span>
                                </div>
                                <div class="card-value" id="totalFundingAmount">-</div>
                                <div class="card-description">累计融资金额</div>
                            </div>
                        </div>
                        
                        <!-- 操作栏 -->
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="projectStatusFilter" onchange="filterProjects()" class="form-input" style="width: auto;">
                                    <option value="">所有状态</option>
                                    <option value="active">活跃</option>
                                    <option value="pending">待审核</option>
                                    <option value="completed">已完成</option>
                                    <option value="paused">暂停</option>
                                    <option value="rejected">已拒绝</option>
                                </select>
                                <select id="projectCategoryFilter" onchange="filterProjects()" class="form-input" style="width: auto;">
                                    <option value="">所有类别</option>
                                    <option value="AI">AI</option>
                                    <option value="Fintech">金融科技</option>
                                    <option value="Healthcare">医疗健康</option>
                                    <option value="E-commerce">电子商务</option>
                                    <option value="Enterprise">企业服务</option>
                                    <option value="Consumer">消费者</option>
                                    <option value="Other">其他</option>
                                </select>
                                <input type="text" id="projectSearchInput" placeholder="搜索项目名称..." onkeyup="filterProjects()" class="form-input" style="width: 200px;">
                            </div>
                            <button class="btn-primary" onclick="showCreateProjectModal()">➕ 创建项目</button>
                        </div>
                        
                        <!-- 项目列表 -->
                        <div id="projectsTableContainer">
                            <div class="loading-spinner"></div>
                            <span style="margin-left: 10px;">加载项目数据...</span>
                        </div>
                    </div>
                </div>
                
                <!-- 用户管理模块 -->
                <div id="users-module" class="content-module">
                    <div class="module-header">
                        <div class="module-title">用户管理</div>
                        <div class="module-subtitle">管理创业者、投资人等平台用户</div>
                    </div>
                    <div class="module-content">
                        <!-- 用户统计卡片 -->
                        <div class="dashboard-grid" style="margin-bottom: 30px;">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">👥</span>
                                    <span class="card-title">总用户数</span>
                                </div>
                                <div class="card-value" id="totalUsersCount">-</div>
                                <div class="card-description">注册用户总数</div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">✅</span>
                                    <span class="card-title">活跃用户</span>
                                </div>
                                <div class="card-value" id="activeUsersCount">-</div>
                                <div class="card-description">当前活跃用户</div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">📈</span>
                                    <span class="card-title">今日注册</span>
                                </div>
                                <div class="card-value" id="todayRegistrations">-</div>
                                <div class="card-description">今日新增用户</div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-icon">📧</span>
                                    <span class="card-title">邮箱用户</span>
                                </div>
                                <div class="card-value" id="emailUsersCount">-</div>
                                <div class="card-description">邮箱注册用户</div>
                            </div>
                        </div>
                        
                        <!-- 用户管理操作区 -->
                        <div class="module-toolbar">
                            <div class="toolbar-filters">
                                <select id="userProviderFilter" onchange="filterUsers()" class="form-input" style="width: auto;">
                                    <option value="">所有来源</option>
                                    <option value="email">邮箱登录</option>
                                    <option value="google">Google</option>
                                    <option value="github">GitHub</option>
                                </select>
                                <select id="userSubscriptionFilter" onchange="filterUsers()" class="form-input" style="width: auto;">
                                    <option value="">订阅状态</option>
                                    <option value="true">已订阅</option>
                                    <option value="false">未订阅</option>
                                </select>
                                <select id="userLocationFilter" onchange="filterUsers()" class="form-input" style="width: auto;">
                                    <option value="">所有地区</option>
                                    <option value="中国">中国</option>
                                    <option value="全球">全球</option>
                                    <option value="美国">美国</option>
                                    <option value="本地环境">本地环境</option>
                                    <option value="其他地区">其他地区</option>
                                </select>
                                <select id="userStatusFilter" onchange="filterUsers()" class="form-input" style="width: auto;">
                                    <option value="">所有状态</option>
                                    <option value="true">活跃</option>
                                    <option value="false">禁用</option>
                                </select>
                                <input type="text" id="userSearchInput" placeholder="搜索用户..." onkeyup="filterUsers()" class="form-input" style="width: 150px;">
                                <input type="date" id="userDateFilter" onchange="filterUsers()" class="form-input" style="width: auto;">
                            </div>
                            <div class="toolbar-actions">
                                <button class="btn-secondary" onclick="exportUsers()">📥 导出用户</button>
                                <button class="btn-primary" onclick="refreshUsers()">🔄 刷新</button>
                            </div>
                        </div>
                        
                        <!-- 用户列表 -->
                        <div id="usersTableContainer">
                            <div class="loading-spinner"></div>
                            <span style="margin-left: 10px;">加载用户数据...</span>
                        </div>
                    </div>
                </div>
                
                <!-- 数据分析模块 -->
                <div id="analytics-module" class="content-module">
                    <div class="module-header">
                        <div class="module-title">数据分析</div>
                        <div class="module-subtitle">查看平台运营数据和投资统计</div>
                    </div>
                    <div class="module-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">📈</div>
                            <h3>数据分析功能</h3>
                            <p>正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 报告生成模块 -->
                <div id="reports-module" class="content-module">
                    <div class="module-header">
                        <div class="module-title">报告生成</div>
                        <div class="module-subtitle">生成运营报告和投资分析报告</div>
                    </div>
                    <div class="module-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <h3>报告生成功能</h3>
                            <p>正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 系统设置模块 -->
                <div id="settings-module" class="content-module">
                    <div class="module-header">
                        <div class="module-title">系统设置</div>
                        <div class="module-subtitle">配置平台参数和系统设置</div>
                    </div>
                    <div class="module-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">⚙️</div>
                            <h3>系统设置功能</h3>
                            <p>正在开发中，敬请期待...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 操作日志模块 -->
                <div id="logs-module" class="content-module">
                    <div class="module-header">
                        <div class="module-title">操作日志</div>
                        <div class="module-subtitle">查看系统和用户操作记录</div>
                        <div class="module-actions">
                            <button onclick="refreshUserBehaviorData()" class="btn btn-primary">
                                🔄 刷新数据
                            </button>
                            <button onclick="exportUserBehaviorData()" class="btn btn-secondary">
                                📊 导出报告
                            </button>
                        </div>
                    </div>
                    
                    <div class="module-content">
                        <!-- 统计概览 -->
                        <div class="stats-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div class="stat-card">
                                <div class="stat-icon">👥</div>
                                <div class="stat-content">
                                    <div class="stat-label">今日活跃用户</div>
                                    <div class="stat-value" id="todayActiveUsers">-</div>
                                    <div class="stat-change">+12% vs 昨日</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">📄</div>
                                <div class="stat-content">
                                    <div class="stat-label">今日页面浏览</div>
                                    <div class="stat-value" id="todayPageViews">-</div>
                                    <div class="stat-change">+8% vs 昨日</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">⏱️</div>
                                <div class="stat-content">
                                    <div class="stat-label">平均停留时间</div>
                                    <div class="stat-value" id="avgSessionTime">-</div>
                                    <div class="stat-change">+15% vs 昨日</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">🎯</div>
                                <div class="stat-content">
                                    <div class="stat-label">用户参与度</div>
                                    <div class="stat-value" id="engagementRate">-</div>
                                    <div class="stat-change">+3% vs 昨日</div>
                                </div>
                            </div>
                        </div>

                        <!-- 过滤和搜索 -->
                        <div class="logs-filters" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div class="filter-group">
                                    <label class="form-label">用户类型</label>
                                    <select id="userTypeFilter" class="form-input" onchange="filterUserBehaviorLogs()">
                                        <option value="">全部用户</option>
                                        <option value="member">注册会员</option>
                                        <option value="anonymous">匿名用户</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">行为类型</label>
                                    <select id="behaviorTypeFilter" class="form-input" onchange="filterUserBehaviorLogs()">
                                        <option value="">全部行为</option>
                                        <option value="page_view">页面访问</option>
                                        <option value="click">点击事件</option>
                                        <option value="form_submit">表单提交</option>
                                        <option value="scroll_milestone">滚动行为</option>
                                        <option value="link_click">链接点击</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">时间范围</label>
                                    <select id="timeRangeFilter" class="form-input" onchange="filterUserBehaviorLogs()">
                                        <option value="today">今天</option>
                                        <option value="yesterday">昨天</option>
                                        <option value="week">本周</option>
                                        <option value="month">本月</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">搜索用户</label>
                                    <input type="text" id="userSearchInput" class="form-input" placeholder="输入用户ID或邮箱..." onkeyup="filterUserBehaviorLogs()">
                                </div>
                            </div>
                            
                            <!-- 自定义时间范围 -->
                            <div id="customTimeRange" style="display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div class="filter-group">
                                    <label class="form-label">开始日期</label>
                                    <input type="date" id="startDate" class="form-input" onchange="filterUserBehaviorLogs()">
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">结束日期</label>
                                    <input type="date" id="endDate" class="form-input" onchange="filterUserBehaviorLogs()">
                                </div>
                            </div>
                        </div>

                        <!-- 标签页导航 -->
                        <div class="logs-tabs" style="display: flex; background: #fff; border-radius: 10px 10px 0 0; border-bottom: 1px solid #eee; margin-bottom: 0;">
                            <button class="logs-tab active" data-tab="realtime" onclick="switchLogsTab('realtime')">
                                🔴 实时活动
                            </button>
                            <button class="logs-tab" data-tab="sessions" onclick="switchLogsTab('sessions')">
                                👥 用户会话
                            </button>
                            <button class="logs-tab" data-tab="pages" onclick="switchLogsTab('pages')">
                                📄 页面分析
                            </button>
                            <button class="logs-tab" data-tab="heatmap" onclick="switchLogsTab('heatmap')">
                                🔥 热力图
                            </button>
                        </div>

                        <!-- 标签页内容 -->
                        <div class="logs-tab-content" style="background: #fff; border-radius: 0 0 10px 10px; padding: 20px;">
                            <!-- 实时活动标签页 -->
                            <div id="realtime-tab" class="logs-tab-panel active">
                                <div class="realtime-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <div>
                                        <h4 style="margin: 0;">实时用户活动</h4>
                                        <p style="margin: 5px 0 0; color: #666;">实时监控用户行为和页面访问</p>
                                    </div>
                                    <div class="realtime-indicator" style="display: flex; align-items: center; color: #28a745;">
                                        <span class="pulse" style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; margin-right: 8px; animation: pulse 1s infinite;"></span>
                                        <span id="realtimeCount">0</span> 位用户在线
                                    </div>
                                </div>
                                
                                <div id="realtimeActivities" class="realtime-activities">
                                    <div class="loading-state" style="text-align: center; padding: 40px; color: #666;">
                                        <div class="loading-spinner" style="margin: 0 auto 15px; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                        <p>正在加载实时数据...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 用户会话标签页 -->
                            <div id="sessions-tab" class="logs-tab-panel">
                                <div class="sessions-header" style="margin-bottom: 20px;">
                                    <h4 style="margin: 0;">用户会话分析</h4>
                                    <p style="margin: 5px 0 0; color: #666;">查看用户会话详情、停留时间和行为路径</p>
                                </div>
                                
                                <div id="sessionsTable" class="sessions-table">
                                    <div class="loading-state" style="text-align: center; padding: 40px; color: #666;">
                                        <div class="loading-spinner" style="margin: 0 auto 15px; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                        <p>正在加载会话数据...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 页面分析标签页 -->
                            <div id="pages-tab" class="logs-tab-panel">
                                <div class="pages-header" style="margin-bottom: 20px;">
                                    <h4 style="margin: 0;">页面访问分析</h4>
                                    <p style="margin: 5px 0 0; color: #666;">分析页面访问量、停留时间和跳出率</p>
                                </div>
                                
                                <div id="pagesAnalysis" class="pages-analysis">
                                    <div class="loading-state" style="text-align: center; padding: 40px; color: #666;">
                                        <div class="loading-spinner" style="margin: 0 auto 15px; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                        <p>正在加载页面数据...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 热力图标签页 -->
                            <div id="heatmap-tab" class="logs-tab-panel">
                                <div class="heatmap-header" style="margin-bottom: 20px;">
                                    <h4 style="margin: 0;">用户点击热力图</h4>
                                    <p style="margin: 5px 0 0; color: #666;">可视化用户点击行为和交互热点</p>
                                </div>
                                
                                <div class="heatmap-controls" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                    <label class="form-label">选择页面:</label>
                                    <select id="heatmapPageSelect" class="form-input" style="width: 300px;" onchange="loadHeatmapData()">
                                        <option value="">选择要分析的页面...</option>
                                        <option value="/">首页</option>
                                        <option value="/pages/ai100.html">AI100</option>
                                        <option value="/pages/investment-camp.html">投资营</option>
                                        <option value="/pages/content-community.html">内容社区</option>
                                    </select>
                                </div>
                                
                                <div id="heatmapVisualization" class="heatmap-visualization">
                                    <div class="empty-state" style="text-align: center; padding: 60px; color: #666;">
                                        <div style="font-size: 48px; margin-bottom: 15px;">🔥</div>
                                        <h4>选择页面查看热力图</h4>
                                        <p>选择上方的页面来查看用户点击热力图分析</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 全局状态
        let currentModule = 'dashboard';
        let dashboardData = {};
        let projectsData = [];
        let filteredProjectsData = [];

        // 页面加载初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setInterval(loadDashboardData, 5 * 60 * 1000); // 每5分钟刷新
        });

        // 加载仪表板数据
        async function loadDashboardData() {
            try {
                console.log('[仪表板] 开始加载数据...');
                
                // 1. 获取用户统计数据
                try {
                    const userStatsResponse = await fetch('/api/users?action=stats');
                    if (userStatsResponse.ok) {
                        const userStats = await userStatsResponse.json();
                        document.getElementById('totalUsers').textContent = userStats.totalUsers || 0;
                        console.log('[仪表板] 用户数据加载成功:', userStats.totalUsers);
                    } else {
                        console.warn('[仪表板] 用户统计API失败:', userStatsResponse.status);
                        document.getElementById('totalUsers').textContent = '0';
                    }
                } catch (userError) {
                    console.error('[仪表板] 获取用户数据失败:', userError);
                    document.getElementById('totalUsers').textContent = '0';
                }

                // 2. 获取订阅数据
                try {
                    const subscriptionResponse = await fetch('/api/subscribe?action=stats');
                    if (subscriptionResponse.ok) {
                        const subscriptionData = await subscriptionResponse.json();
                        document.getElementById('subscribers').textContent = subscriptionData.totalSubscribers || 0;
                        console.log('[仪表板] 订阅数据加载成功:', subscriptionData.totalSubscribers);
                    } else {
                        console.warn('[仪表板] 订阅统计API失败:', subscriptionResponse.status);
                        document.getElementById('subscribers').textContent = '0';
                    }
                } catch (subscriptionError) {
                    console.error('[仪表板] 获取订阅数据失败:', subscriptionError);
                    document.getElementById('subscribers').textContent = '0';
                }

                // 3. 获取项目统计数据
                try {
                    const projectStatsResponse = await fetch('/api/projects?action=stats');
                    if (projectStatsResponse.ok) {
                        const projectStats = await projectStatsResponse.json();
                        document.getElementById('totalProjects').textContent = projectStats.totalProjects || 0;
                        console.log('[仪表板] 项目数据加载成功:', projectStats.totalProjects);
                    } else {
                        console.warn('[仪表板] 项目统计API失败:', projectStatsResponse.status);
                        document.getElementById('totalProjects').textContent = '0';
                    }
                } catch (projectError) {
                    console.error('[仪表板] 获取项目数据失败:', projectError);
                    document.getElementById('totalProjects').textContent = '0';
                }

                // 保留投资总额的模拟数据
                document.getElementById('totalInvestment').textContent = '$42.8M';

                // 模拟最近活动
                setTimeout(() => {
                    const activitiesHtml = `
                        <div style="space-y: 15px;">
                            <div style="padding: 10px 0; border-bottom: 1px solid #e1e5e9;">
                                <strong>新项目提交:</strong> AI医疗诊断平台 - TechHealth
                                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">2小时前</div>
                            </div>
                            <div style="padding: 10px 0; border-bottom: 1px solid #e1e5e9;">
                                <strong>用户注册:</strong> 5名新用户加入平台
                                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">4小时前</div>
                            </div>
                            <div style="padding: 10px 0; border-bottom: 1px solid #e1e5e9;">
                                <strong>投资完成:</strong> 智能物流项目获得A轮投资
                                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">昨天</div>
                            </div>
                            <div style="padding: 10px 0;">
                                <strong>内容发布:</strong> AI周报第42期已发送
                                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">2天前</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('recentActivities').innerHTML = activitiesHtml;
                }, 1500);

            } catch (error) {
                console.error('加载仪表板数据失败:', error);
            }
        }

        // 显示模块
        function showModule(moduleId) {
            // 隐藏所有模块
            document.querySelectorAll('.content-module').forEach(module => {
                module.classList.remove('active');
            });

            // 移除所有导航项的active状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // 显示目标模块
            const targetModule = document.getElementById(moduleId + '-module');
            if (targetModule) {
                targetModule.classList.add('active');
            }

            // 设置导航项active状态
            event.target.closest('.nav-item').classList.add('active');

            // 更新页面标题
            const titles = {
                dashboard: { title: '仪表板', subtitle: 'SVTR 平台运营概览' },
                content: { title: '内容创作', subtitle: '管理AI周报和投资洞察内容' },
                subscription: { title: '订阅管理', subtitle: '管理AI周报订阅用户和邮件列表' },
                projects: { title: '项目管理', subtitle: '管理投资项目和申请' },
                users: { title: '用户管理', subtitle: '管理平台用户和权限' },
                analytics: { title: '数据分析', subtitle: '平台运营数据和投资统计' },
                reports: { title: '报告生成', subtitle: '生成运营和投资分析报告' },
                settings: { title: '系统设置', subtitle: '配置平台参数和系统设置' },
                logs: { title: '操作日志', subtitle: '查看系统和用户操作记录' }
            };

            const titleData = titles[moduleId] || titles.dashboard;
            document.getElementById('pageTitle').textContent = titleData.title;
            document.getElementById('pageSubtitle').textContent = titleData.subtitle;

            currentModule = moduleId;

            // 加载模块特定数据
            if (moduleId === 'projects') {
                loadProjectsData();
            } else if (moduleId === 'subscription') {
                console.log('[模块切换] 正在切换到订阅管理模块');
                loadSubscriptionsData();
            } else if (moduleId === 'users') {
                loadUsersData();
            }

            // 关闭移动端侧边栏
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        }

        // 切换侧边栏 (移动端)
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        // 刷新数据
        function refreshData() {
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<span class="loading-spinner"></span> 刷新中...';
            refreshBtn.disabled = true;

            loadDashboardData().finally(() => {
                setTimeout(() => {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }, 1000);
            });
        }

        // 快捷操作
        function showQuickActions() {
            alert('快捷操作功能正在开发中...\n\n计划包括:\n• 快速创建项目\n• 发送通知\n• 生成报告\n• 数据导出');
        }

        // 点击侧边栏外部关闭 (移动端)
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('mobile-open') && 
                !sidebar.contains(event.target) && 
                !mobileMenuBtn.contains(event.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });

        // 窗口大小改变时重置侧边栏状态
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        });

        // 订阅管理相关函数
        let subscriptionsData = [];
        let filteredSubscriptionsData = [];

        async function loadSubscriptionsData() {
            try {
                console.log('[订阅管理] 开始加载订阅数据...');
                
                // 获取订阅统计
                const statsResponse = await fetch('/api/subscribe?action=stats');
                console.log('[订阅管理] 统计API响应状态:', statsResponse.status);
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    console.log('[订阅管理] 统计数据:', stats);
                    updateSubscriptionStats(stats);
                } else {
                    console.error('[订阅管理] 统计API失败:', statsResponse.status, statsResponse.statusText);
                }
                
                // 获取订阅者列表
                const listResponse = await fetch('/api/subscribe?action=list');
                console.log('[订阅管理] 列表API响应状态:', listResponse.status);
                
                if (listResponse.ok) {
                    const subscribers = await listResponse.json();
                    console.log('[订阅管理] 订阅者列表:', subscribers);
                    subscriptionsData = Array.isArray(subscribers) ? subscribers : [];
                    filteredSubscriptionsData = [...subscriptionsData];
                    console.log('[订阅管理] 准备渲染表格，数据数量:', filteredSubscriptionsData.length);
                    renderSubscriptionsTable();
                } else {
                    console.error('[订阅管理] 列表API失败:', listResponse.status, listResponse.statusText);
                }
                
            } catch (error) {
                console.error('[订阅管理] 加载数据失败:', error);
                document.getElementById('subscriptionsTableContainer').innerHTML = `
                    <div class="error-message">
                        <div style="color: #dc3545; text-align: center; padding: 20px;">
                            <div>❌ 加载订阅数据失败</div>
                            <div style="font-size: 14px; margin-top: 5px;">错误: ${error.message}</div>
                            <button class="btn-primary" onclick="loadSubscriptionsData()" style="margin-top: 10px;">重试</button>
                        </div>
                    </div>
                `;
            }
        }

        function updateSubscriptionStats(stats) {
            // 更新统计卡片数据
            document.getElementById('subscription-total-subscribers').textContent = stats.totalSubscribers || 0;
            document.getElementById('subscription-today-new').textContent = stats.todaySubscribers || 0;
            
            const zhUsers = stats.languageDistribution?.['zh-CN'] || 0;
            const enUsers = stats.languageDistribution?.['en-US'] || 0;
            const total = stats.totalSubscribers || 1;
            
            document.getElementById('subscription-zh-users').textContent = zhUsers;
            document.getElementById('subscription-en-users').textContent = enUsers;
            document.getElementById('subscription-zh-percentage').textContent = `${Math.round(zhUsers / total * 100)}%`;
            document.getElementById('subscription-en-percentage').textContent = `${Math.round(enUsers / total * 100)}%`;
            
            console.log('[订阅统计] 数据已更新:', {
                total: stats.totalSubscribers,
                today: stats.todaySubscribers,
                zh: zhUsers,
                en: enUsers
            });
        }

        function renderSubscriptionsTable() {
            const container = document.getElementById('subscriptionsTableContainer');
            
            if (filteredSubscriptionsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <h3>暂无订阅数据</h3>
                        <p>还没有用户订阅AI周报</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" onclick="sortSubscriptions('email')">邮箱地址</th>
                                <th class="sortable-header" onclick="sortSubscriptions('preferences')">订阅偏好</th>
                                <th class="sortable-header" onclick="sortSubscriptions('language')">语言</th>
                                <th class="sortable-header" onclick="sortSubscriptions('subscribedAt')">订阅时间</th>
                                <th class="sortable-header" onclick="sortSubscriptions('location')">地理位置</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredSubscriptionsData.map(subscriber => `
                                <tr>
                                    <td>
                                        <div class="email-cell">
                                            <strong>${subscriber.email}</strong>
                                            <small>${subscriber.email.split('@')[1]}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="preferences-cell">
                                            ${(subscriber.preferences || []).map(pref => 
                                                `<span class="preference-tag">${pref}</span>`
                                            ).join('')}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="language-badge ${subscriber.language === 'zh-CN' ? 'zh' : 'en'}">
                                            ${subscriber.language === 'zh-CN' ? '🇨🇳 中文' : '🇺🇸 英文'}
                                        </span>
                                    </td>
                                    <td class="date-cell">${formatSubscriptionDate(subscriber.subscribedAt)}</td>
                                    <td class="location-cell">${subscriber.location || '未知地区'}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-small btn-info" onclick="viewSubscriptionDetails('${subscriber.email}')" title="查看详情">
                                                👁️
                                            </button>
                                            <button class="btn-small btn-danger" onclick="removeSubscription('${subscriber.email}')" title="取消订阅">
                                                🗑️
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="table-info">
                    <span>共 ${filteredSubscriptionsData.length} 个订阅者 (总计 ${subscriptionsData.length} 个)</span>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        // 订阅管理表格排序功能
        let subscriptionsSortField = null;
        let subscriptionsSortDirection = 'asc';

        function sortSubscriptions(field) {
            // 更新排序状态
            if (subscriptionsSortField === field) {
                subscriptionsSortDirection = subscriptionsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                subscriptionsSortField = field;
                subscriptionsSortDirection = 'asc';
            }

            // 执行排序
            filteredSubscriptionsData.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'email':
                        valueA = a.email.toLowerCase();
                        valueB = b.email.toLowerCase();
                        break;
                    case 'preferences':
                        valueA = (a.preferences || []).join('');
                        valueB = (b.preferences || []).join('');
                        break;
                    case 'language':
                        valueA = a.language || '';
                        valueB = b.language || '';
                        break;
                    case 'subscribedAt':
                        valueA = new Date(a.subscribedAt).getTime();
                        valueB = new Date(b.subscribedAt).getTime();
                        break;
                    case 'location':
                        valueA = (a.location || '').toLowerCase();
                        valueB = (b.location || '').toLowerCase();
                        break;
                    default:
                        return 0;
                }

                if (valueA < valueB) return subscriptionsSortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return subscriptionsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // 重新渲染表格
            renderSubscriptionsTable();

            // 更新表头样式
            updateSubscriptionsSortHeaders();
        }

        function updateSubscriptionsSortHeaders() {
            // 清除所有排序样式
            const headers = document.querySelectorAll('#subscription-module .sortable-header');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // 添加当前排序样式
            if (subscriptionsSortField) {
                const fieldMap = {
                    'email': 0,
                    'preferences': 1,
                    'language': 2,
                    'subscribedAt': 3,
                    'location': 4
                };
                
                const headerIndex = fieldMap[subscriptionsSortField];
                if (headerIndex !== undefined) {
                    const header = headers[headerIndex];
                    if (header) {
                        header.classList.add(subscriptionsSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
            }
        }

        function filterSubscriptions() {
            const languageFilter = document.getElementById('subscriptionLanguageFilter').value;
            const searchInput = document.getElementById('subscriptionSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('subscriptionDateFilter').value;
            
            filteredSubscriptionsData = subscriptionsData.filter(subscriber => {
                const matchesLanguage = !languageFilter || subscriber.language === languageFilter;
                const matchesSearch = !searchInput || subscriber.email.toLowerCase().includes(searchInput);
                const matchesDate = !dateFilter || subscriber.subscribedAt?.startsWith(dateFilter);
                
                return matchesLanguage && matchesSearch && matchesDate;
            });
            
            renderSubscriptionsTable();
        }

        function refreshSubscriptions() {
            loadSubscriptionsData();
        }

        function exportSubscriptions() {
            try {
                const csvContent = [
                    ['邮箱地址', '订阅偏好', '语言', '订阅时间', '地理位置', 'User Agent'],
                    ...filteredSubscriptionsData.map(sub => [
                        sub.email,
                        (sub.preferences || []).join('; '),
                        sub.language,
                        sub.subscribedAt,
                        sub.location || '未知地区',
                        sub.userAgent || ''
                    ])
                ].map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `SVTR订阅者数据_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                console.log('订阅数据导出成功');
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败，请重试');
            }
        }

        function viewSubscriptionDetails(email) {
            const subscriber = subscriptionsData.find(sub => sub.email === email);
            if (!subscriber) return;
            
            const detailsHTML = `
                <div class="modal-content">
                    <h3>订阅者详情</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>邮箱地址:</label>
                            <span>${subscriber.email}</span>
                        </div>
                        <div class="detail-item">
                            <label>订阅偏好:</label>
                            <span>${(subscriber.preferences || []).join(', ')}</span>
                        </div>
                        <div class="detail-item">
                            <label>语言设置:</label>
                            <span>${subscriber.language === 'zh-CN' ? '中文' : '英文'}</span>
                        </div>
                        <div class="detail-item">
                            <label>订阅时间:</label>
                            <span>${formatSubscriptionDate(subscriber.subscribedAt)}</span>
                        </div>
                        <div class="detail-item">
                            <label>地理位置:</label>
                            <span>${subscriber.location || '未知地区'}</span>
                        </div>
                        <div class="detail-item">
                            <label>浏览器:</label>
                            <span>${subscriber.userAgent || '未记录'}</span>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('订阅者详情', detailsHTML);
        }

        function removeSubscription(email) {
            if (confirm(`确定要取消 ${email} 的订阅吗？`)) {
                // 这里可以添加取消订阅的API调用
                alert('取消订阅功能正在开发中...');
            }
        }

        function formatSubscriptionDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                return '无效日期';
            }
        }

        // 项目管理相关函数
        async function loadProjectsData() {
            try {
                console.log('加载项目数据...');
                
                // 显示加载状态
                const refreshBtn = document.querySelector('button[onclick="loadProjectsData()"]');
                const originalText = refreshBtn?.textContent;
                if (refreshBtn) {
                    refreshBtn.textContent = '🔄 加载中...';
                    refreshBtn.disabled = true;
                }
                
                // 获取项目统计
                const statsResponse = await fetch('/api/projects?action=stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateProjectStats(stats);
                }
                
                // 获取项目列表
                const listResponse = await fetch('/api/projects?action=list');
                if (listResponse.ok) {
                    const projects = await listResponse.json();
                    projectsData = Array.isArray(projects) ? projects : [];
                    filteredProjectsData = [...projectsData];
                    renderProjectsTable();
                }
                
                // 更新最后更新时间
                const lastUpdateElement = document.getElementById('lastUpdateTime');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = `最后更新: ${new Date().toLocaleString('zh-CN')}`;
                }
                
                console.log(`项目数据加载完成，共 ${projectsData.length} 个项目`);
                
            } catch (error) {
                console.error('加载项目数据失败:', error);
                document.getElementById('projectsTableContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #d32f2f;">
                        <h3>⚠️ 加载失败</h3>
                        <p>无法加载项目数据: ${error.message}</p>
                        <button class="btn-primary" onclick="loadProjectsData()">重新加载</button>
                    </div>
                `;
            } finally {
                // 恢复按钮状态
                const refreshBtn = document.querySelector('button[onclick="loadProjectsData()"]');
                if (refreshBtn && originalText) {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }

        function updateProjectStats(stats) {
            document.getElementById('totalProjectsCount').textContent = stats.totalProjects || 0;
            document.getElementById('activeProjectsCount').textContent = stats.activeProjects || 0;
            document.getElementById('pendingProjectsCount').textContent = stats.pendingProjects || 0;
            
            const totalFunding = stats.totalFunding || 0;
            document.getElementById('totalFundingAmount').textContent = formatCurrency(totalFunding);
        }

        function renderProjectsTable() {
            const container = document.getElementById('projectsTableContainer');
            
            if (filteredProjectsData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">💼</div>
                        <h3>暂无项目数据</h3>
                        <p>点击"创建项目"开始添加第一个项目</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable-header" onclick="sortProjects('name')">项目名称</th>
                            <th class="sortable-header" onclick="sortProjects('founder')">创始人</th>
                            <th class="sortable-header" onclick="sortProjects('category')">类别</th>
                            <th class="sortable-header" onclick="sortProjects('need')">需求</th>
                            <th>附件</th>
                            <th class="sortable-header" onclick="sortProjects('stage')">阶段</th>
                            <th class="sortable-header" onclick="sortProjects('status')">状态</th>
                            <th class="sortable-header" onclick="sortProjects('fundingGoal')">融资目标</th>
                            <th class="sortable-header" onclick="sortProjects('createdAt')">创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredProjectsData.map(project => `
                            <tr>
                                <td>
                                    <strong>${project.name}</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                        ${project.description.substring(0, 50)}...
                                    </div>
                                </td>
                                <td>
                                    <div>${project.founder}</div>
                                    <div style="font-size: 0.8rem; color: #666;">${project.founderEmail}</div>
                                </td>
                                <td>
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                                        ${project.category}
                                    </span>
                                </td>
                                <td>
                                    ${project.needs && project.needs.length > 0 ? 
                                        project.needs.map(need => 
                                            `<span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin: 1px; display: inline-block;">${need}</span>`
                                        ).join('') : 
                                        '<span style="color: #999; font-size: 0.8rem;">无</span>'
                                    }
                                </td>
                                <td>
                                    ${project.files && project.files.length > 0 ? 
                                        `<div>
                                            <span style="color: #4caf50; font-size: 0.8rem; cursor: pointer;" onclick="showProjectFiles('${project.id}')">📎 ${project.files.length} 个文件</span>
                                            <div style="font-size: 0.7rem; color: #666; margin-top: 2px;">
                                                ${project.files.slice(0, 2).map(file => 
                                                    `<div>${file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name}</div>`
                                                ).join('')}
                                                ${project.files.length > 2 ? `<div>+${project.files.length - 2} 个更多...</div>` : ''}
                                            </div>
                                         </div>` : 
                                        '<span style="color: #999; font-size: 0.8rem;">无附件</span>'
                                    }
                                </td>
                                <td>${formatStage(project.stage)}</td>
                                <td>
                                    <span class="status-badge ${getStatusClass(project.status)}">
                                        ${formatStatus(project.status)}
                                    </span>
                                </td>
                                <td>${formatCurrency(project.fundingGoal)}</td>
                                <td>${formatDateTime(project.createdAt)}</td>
                                <td>
                                    <button onclick="viewProjectDetails('${project.id}')" class="btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;">查看</button>
                                    <button onclick="editProject('${project.id}')" class="btn-primary" style="padding: 4px 8px; font-size: 0.8rem;">编辑</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // 项目管理表格排序功能
        let projectsSortField = null;
        let projectsSortDirection = 'asc';

        function sortProjects(field) {
            // 更新排序状态
            if (projectsSortField === field) {
                projectsSortDirection = projectsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                projectsSortField = field;
                projectsSortDirection = 'asc';
            }

            // 执行排序
            filteredProjectsData.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'name':
                        valueA = (a.name || '').toLowerCase();
                        valueB = (b.name || '').toLowerCase();
                        break;
                    case 'founder':
                        valueA = (a.founder || '').toLowerCase();
                        valueB = (b.founder || '').toLowerCase();
                        break;
                    case 'category':
                        valueA = a.category || '';
                        valueB = b.category || '';
                        break;
                    case 'need':
                        valueA = a.need || '';
                        valueB = b.need || '';
                        break;
                    case 'stage':
                        valueA = a.stage || '';
                        valueB = b.stage || '';
                        break;
                    case 'status':
                        valueA = a.status || '';
                        valueB = b.status || '';
                        break;
                    case 'fundingGoal':
                        valueA = parseFloat(a.fundingGoal) || 0;
                        valueB = parseFloat(b.fundingGoal) || 0;
                        break;
                    case 'createdAt':
                        valueA = new Date(a.createdAt).getTime();
                        valueB = new Date(b.createdAt).getTime();
                        break;
                    default:
                        return 0;
                }

                if (valueA < valueB) return projectsSortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return projectsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // 重新渲染表格
            renderProjectsTable();

            // 更新表头样式
            updateProjectsSortHeaders();
        }

        function updateProjectsSortHeaders() {
            // 清除所有排序样式
            const headers = document.querySelectorAll('#projects-module .sortable-header');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // 添加当前排序样式
            if (projectsSortField) {
                const fieldMap = {
                    'name': 0,
                    'founder': 1,
                    'category': 2,
                    'need': 3,
                    'stage': 5,  // 跳过附件列
                    'status': 6,
                    'fundingGoal': 7,
                    'createdAt': 8
                };
                
                const headerIndex = fieldMap[projectsSortField];
                if (headerIndex !== undefined) {
                    const header = headers[headerIndex];
                    if (header) {
                        header.classList.add(projectsSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
            }
        }

        function filterProjects() {
            const statusFilter = document.getElementById('projectStatusFilter').value;
            const categoryFilter = document.getElementById('projectCategoryFilter').value;
            const searchTerm = document.getElementById('projectSearchInput').value.toLowerCase();
            
            filteredProjectsData = projectsData.filter(project => {
                if (statusFilter && project.status !== statusFilter) return false;
                if (categoryFilter && project.category !== categoryFilter) return false;
                if (searchTerm && !project.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
            
            renderProjectsTable();
        }

        function showCreateProjectModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 2000; overflow-y: auto;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="margin: 0; color: #333;">📝 创建新项目</h3>
                    <button onclick="this.closest('[data-modal]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                </div>
                <form id="createProjectForm" onsubmit="return false;">
                    <div class="form-group">
                        <label class="form-label">项目名称 *</label>
                        <input type="text" id="projectName" name="name" class="form-input" required placeholder="请输入项目名称（至少2个字符）">
                        <small class="form-help" style="display: none; color: #666;">项目名称至少需要2个字符</small>
                        <small class="form-error" style="display: none; color: #e74c3c;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">项目需求 *</label>
                        <div class="checkbox-group" style="display: flex; gap: 15px; margin-top: 8px;">
                            <label class="checkbox-item" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="projectNeeds" value="找人" style="margin-right: 8px;">
                                <span>找人</span>
                            </label>
                            <label class="checkbox-item" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="projectNeeds" value="找钱" style="margin-right: 8px;">
                                <span>找钱</span>
                            </label>
                            <label class="checkbox-item" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="projectNeeds" value="找方向" style="margin-right: 8px;">
                                <span>找方向</span>
                            </label>
                            <label class="checkbox-item" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" name="projectNeeds" value="其他" id="needOther" style="margin-right: 8px;">
                                <span>其他</span>
                            </label>
                        </div>
                        <input type="text" id="otherNeed" placeholder="请描述其他需求..." style="display: none; margin-top: 8px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <small class="form-error" style="display: none; color: #e74c3c;">至少选择一个项目需求</small>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">项目类别 *</label>
                            <select id="projectCategory" name="category" class="form-input" required>
                                <option value="">请选择类别</option>
                                <option value="ai">人工智能 (AI)</option>
                                <option value="fintech">金融科技 (Fintech)</option>
                                <option value="healthcare">医疗健康 (Healthcare)</option>
                                <option value="ecommerce">电子商务 (E-commerce)</option>
                                <option value="enterprise">企业服务 (Enterprise)</option>
                                <option value="consumer">消费科技 (Consumer)</option>
                                <option value="other">其他 (Other)</option>
                            </select>
                            <small class="form-error" style="display: none; color: #e74c3c;">请选择有效的项目类别</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">融资阶段 *</label>
                            <select id="projectStage" name="stage" class="form-input" required>
                                <option value="">请选择阶段</option>
                                <option value="idea">创意阶段</option>
                                <option value="seed">种子轮</option>
                                <option value="series-a">A轮</option>
                                <option value="series-b">B轮</option>
                                <option value="series-c">C轮</option>
                                <option value="ipo">IPO</option>
                            </select>
                            <small class="form-error" style="display: none; color: #e74c3c;">请选择有效的融资阶段</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">项目描述 *</label>
                        <textarea id="projectDescription" name="description" class="form-input form-textarea" required placeholder="请详细描述您的项目（至少5个字符）" rows="4"></textarea>
                        <small class="form-help" style="display: none; color: #666;">项目描述至少需要5个字符</small>
                        <small class="form-error" style="display: none; color: #e74c3c;"></small>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">创始人姓名 *</label>
                            <input type="text" id="founderName" name="founder" class="form-input" required placeholder="请输入创始人姓名（至少2个字符）">
                            <small class="form-error" style="display: none; color: #e74c3c;">创始人姓名至少需要2个字符</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">创始人邮箱 *</label>
                            <input type="email" id="founderEmail" name="founderEmail" class="form-input" required placeholder="you@company.com">
                            <small class="form-error" style="display: none; color: #e74c3c;">请提供有效的邮箱地址</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">融资目标 (USD) *</label>
                        <input type="number" id="fundingGoal" name="fundingGoal" class="form-input" min="1" required placeholder="例如：1000000">
                        <small class="form-help" style="color: #666;">请输入融资目标金额（美元）</small>
                        <small class="form-error" style="display: none; color: #e74c3c;">融资目标必须大于0</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">上传附件</label>
                        <div class="file-upload-area" id="fileUploadArea" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                            <input type="file" id="projectFiles" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.png" style="display: none;">
                            <div class="upload-placeholder">
                                <div class="upload-icon" style="font-size: 2rem; margin-bottom: 10px;">📎</div>
                                <div class="upload-text" style="font-weight: 500; margin-bottom: 5px;">点击或拖拽上传附件</div>
                                <div class="upload-hint" style="font-size: 0.9rem; color: #666;">支持 PDF, DOC, PPT, TXT, 图片等格式，最多5个文件</div>
                            </div>
                            <div class="uploaded-files" id="uploadedFiles"></div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button type="button" onclick="this.closest('[data-modal]').remove()" class="btn-secondary" style="margin-right: 10px;">取消</button>
                        <button type="button" onclick="createProject()" class="btn-primary" id="createProjectBtn">创建项目</button>
                    </div>
                </form>
            `;
            
            modal.setAttribute('data-modal', 'true');
            modal.appendChild(modalContent);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
            
            // 初始化表单验证和文件上传功能
            initializeAdminFormValidation();
        }

        // 表单验证和文件上传功能初始化
        function initializeAdminFormValidation() {
            // "其他"选项的显示/隐藏逻辑
            const otherCheckbox = document.getElementById('needOther');
            const otherInput = document.getElementById('otherNeed');
            
            if (otherCheckbox && otherInput) {
                otherCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        otherInput.style.display = 'block';
                        otherInput.focus();
                    } else {
                        otherInput.style.display = 'none';
                        otherInput.value = '';
                    }
                });
            }
            
            // 文件上传功能
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('projectFiles');
            const uploadedFiles = document.getElementById('uploadedFiles');
            
            let selectedFiles = [];
            
            if (fileUploadArea && fileInput) {
                // 点击上传区域触发文件选择
                fileUploadArea.addEventListener('click', () => fileInput.click());
                
                // 拖拽上传
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#FA8C32';
                    fileUploadArea.style.backgroundColor = '#fef9f5';
                });
                
                fileUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#ddd';
                    fileUploadArea.style.backgroundColor = 'transparent';
                });
                
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#ddd';
                    fileUploadArea.style.backgroundColor = 'transparent';
                    
                    const files = Array.from(e.dataTransfer.files);
                    handleFileSelection(files);
                });
                
                // 文件选择
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    handleFileSelection(files);
                });
                
                function handleFileSelection(files) {
                    const allowedTypes = ['.pdf', '.doc', '.docx', '.ppt', '.pptx', '.txt', '.jpg', '.jpeg', '.png'];
                    const maxFiles = 5;
                    const maxFileSize = 10 * 1024 * 1024; // 10MB
                    
                    files.forEach(file => {
                        if (selectedFiles.length >= maxFiles) {
                            alert(`最多只能上传${maxFiles}个文件`);
                            return;
                        }
                        
                        if (file.size > maxFileSize) {
                            alert(`文件 "${file.name}" 超过10MB大小限制`);
                            return;
                        }
                        
                        const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                        if (!allowedTypes.includes(fileExt)) {
                            alert(`文件 "${file.name}" 格式不支持。支持的格式：${allowedTypes.join(', ')}`);
                            return;
                        }
                        
                        selectedFiles.push(file);
                    });
                    
                    updateFilesList();
                }
                
                function updateFilesList() {
                    if (selectedFiles.length === 0) {
                        uploadedFiles.innerHTML = '';
                        return;
                    }
                    
                    const filesHTML = selectedFiles.map((file, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 8px;">
                            <div>
                                <strong>${file.name}</strong>
                                <span style="color: #666; margin-left: 10px;">(${formatFileSize(file.size)})</span>
                            </div>
                            <button type="button" onclick="removeFile(${index})" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">
                                删除
                            </button>
                        </div>
                    `).join('');
                    
                    uploadedFiles.innerHTML = filesHTML;
                }
                
                window.removeFile = function(index) {
                    selectedFiles.splice(index, 1);
                    updateFileSelection();
                    updateFilesList();
                }
                
                function updateFileSelection() {
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    fileInput.files = dt.files;
                }
                
                window.getAdminSelectedFiles = function() {
                    return selectedFiles;
                }
            }
            
            // 实时验证
            setupFieldValidation('projectName', validateName);
            setupFieldValidation('projectDescription', validateDescription);
            setupFieldValidation('founderName', validateFounder);
            setupFieldValidation('founderEmail', validateEmail);
            setupFieldValidation('fundingGoal', validateFundingGoal);
            
            function setupFieldValidation(fieldId, validator) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', () => {
                        const result = validator(field.value.trim());
                        showFieldValidation(field, result);
                    });
                    
                    field.addEventListener('blur', () => {
                        const result = validator(field.value.trim());
                        showFieldValidation(field, result);
                    });
                }
            }
            
            function showFieldValidation(field, result) {
                const formGroup = field.closest('.form-group');
                const helpText = formGroup.querySelector('.form-help');
                const errorText = formGroup.querySelector('.form-error');
                
                field.style.borderColor = result.valid ? '#28a745' : '#e74c3c';
                
                if (helpText) {
                    helpText.style.display = result.valid && result.showHelp ? 'block' : 'none';
                }
                
                if (errorText) {
                    if (result.valid) {
                        errorText.style.display = 'none';
                    } else {
                        errorText.style.display = 'block';
                        errorText.textContent = result.message;
                    }
                }
            }
        }
        
        // 验证函数
        function validateName(value) {
            if (!value || value.length < 2) {
                return { valid: false, message: '项目名称至少需要2个字符' };
            }
            return { valid: true, showHelp: true };
        }
        
        function validateDescription(value) {
            if (!value || value.length < 5) {
                return { valid: false, message: '项目描述至少需要5个字符' };
            }
            return { valid: true, showHelp: true };
        }
        
        function validateFounder(value) {
            if (!value || value.length < 2) {
                return { valid: false, message: '创始人姓名至少需要2个字符' };
            }
            return { valid: true };
        }
        
        function validateEmail(value) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!value || !emailRegex.test(value)) {
                return { valid: false, message: '请提供有效的邮箱地址' };
            }
            return { valid: true };
        }
        
        function validateFundingGoal(value) {
            const num = Number(value);
            if (!value || isNaN(num) || num <= 0) {
                return { valid: false, message: '融资目标必须大于0' };
            }
            return { valid: true };
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function mapCategoryToAPI(category) {
            const categoryMap = {
                'ai': 'AI',
                'fintech': 'Fintech',
                'healthcare': 'Healthcare',
                'ecommerce': 'E-commerce',
                'enterprise': 'Enterprise',
                'consumer': 'Consumer',
                'other': 'Other'
            };
            return categoryMap[category] || 'Other';
        }
        
        function extractNameFromEmail(email) {
            const username = email.split('@')[0];
            return username.replace(/[._]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        async function createProject() {
            const submitBtn = document.getElementById('createProjectBtn');
            const originalText = submitBtn.textContent;
            
            // 显示提交中状态
            submitBtn.textContent = '创建中...';
            submitBtn.disabled = true;
            
            try {
                // 收集项目需求
                const needs = [];
                const needCheckboxes = document.querySelectorAll('input[name="projectNeeds"]:checked');
                needCheckboxes.forEach(checkbox => {
                    if (checkbox.value === '其他') {
                        const otherNeed = document.getElementById('otherNeed').value.trim();
                        if (otherNeed) {
                            needs.push(`其他: ${otherNeed}`);
                        }
                    } else {
                        needs.push(checkbox.value);
                    }
                });
                
                // 检查项目需求
                if (needs.length === 0) {
                    alert('请至少选择一个项目需求');
                    return;
                }
                
                const form = document.getElementById('createProjectForm');
                const formData = new FormData(form);
                
                const projectData = {
                    name: document.getElementById('projectName').value.trim(),
                    description: document.getElementById('projectDescription').value.trim(),
                    category: mapCategoryToAPI(document.getElementById('projectCategory').value),
                    founder: document.getElementById('founderName').value.trim() || extractNameFromEmail(document.getElementById('founderEmail').value),
                    founderEmail: document.getElementById('founderEmail').value.trim(),
                    fundingGoal: Number(document.getElementById('fundingGoal').value),
                    stage: document.getElementById('projectStage').value,
                    tags: [document.getElementById('projectCategory').value],
                    needs: needs,
                    files: window.getAdminSelectedFiles ? window.getAdminSelectedFiles().map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type
                    })) : [],
                    submittedAt: new Date().toISOString()
                };
                
                console.log('准备创建项目数据:', projectData);
                
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('项目创建成功！项目ID: ' + result.data.projectId);
                    document.querySelector('[data-modal]').remove();
                    loadProjectsData(); // 重新加载数据
                } else {
                    let errorMessage = '创建失败: ' + (result.message || '未知错误');
                    
                    if (result.errors && result.errors.length > 0) {
                        errorMessage += '\n\n详细错误：\n' + result.errors.join('\n');
                    }
                    
                    if (result.debug) {
                        errorMessage += '\n\n调试信息：\n' + JSON.stringify(result.debug, null, 2);
                    }
                    
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('项目创建失败:', error);
                alert('创建失败: ' + error.message + '\n请检查网络连接或稍后重试。');
            } finally {
                // 恢复按钮状态
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function viewProjectDetails(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                alert('项目不存在');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 2000; overflow-y: auto;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 15px; 
                max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;
            
            // 项目状态样式映射
            const statusStyles = {
                '申请中': { bg: '#fef3c7', color: '#d97706', icon: '⏳' },
                '已通过': { bg: '#d1fae5', color: '#059669', icon: '✅' },
                '已拒绝': { bg: '#fee2e2', color: '#dc2626', icon: '❌' },
                '进行中': { bg: '#dbeafe', color: '#2563eb', icon: '🚀' },
                '已完成': { bg: '#f3e8ff', color: '#7c3aed', icon: '🎯' }
            };
            
            const status = statusStyles[project.status] || { bg: '#f3f4f6', color: '#6b7280', icon: '📋' };
            
            modalContent.innerHTML = `
                <div style="padding: 0; border-radius: 15px; overflow: hidden;">
                    <!-- 项目头部 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 10px; line-height: 1.2;">${project.name}</h2>
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <span style="background: ${status.bg}; color: ${status.color}; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                        ${status.icon} ${project.status}
                                    </span>
                                    <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500;">
                                        📁 ${project.category}
                                    </span>
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.95rem; opacity: 0.9;">
                                    <span><strong>创始人:</strong> ${project.founder}</span>
                                    <span><strong>申请时间:</strong> ${project.submitTime}</span>
                                    <span><strong>项目ID:</strong> ${project.id}</span>
                                </div>
                            </div>
                            <button onclick="this.closest('[data-modal]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: background 0.3s;">×</button>
                        </div>
                    </div>
                    
                    <!-- 项目内容 -->
                    <div style="padding: 30px;">
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
                            <!-- 左侧详情 -->
                            <div>
                                <div style="margin-bottom: 25px;">
                                    <h3 style="color: #1f2937; font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">📝 项目描述</h3>
                                    <p style="color: #4b5563; line-height: 1.6; font-size: 1rem; background: #f9fafb; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">${project.description || '暂无描述'}</p>
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <h3 style="color: #1f2937; font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">🎯 需求清单</h3>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${(project.needs || []).map(need => `
                                            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 16px; border-radius: 25px; font-size: 0.9rem; font-weight: 500; display: inline-block; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);">${need}</span>
                                        `).join('')}
                                        ${(!project.needs || project.needs.length === 0) ? '<span style="color: #9ca3af; font-style: italic;">暂无需求信息</span>' : ''}
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 style="color: #1f2937; font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">📎 项目附件</h3>
                                    <div id="projectFilesContainer">
                                        ${project.files && project.files.length > 0 ? 
                                            project.files.map((file, index) => `
                                                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; transition: all 0.3s;">
                                                    <div style="display: flex; align-items: center; gap: 12px;">
                                                        <div style="width: 40px; height: 40px; background: #667eea; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.9rem;">
                                                            ${file.name.split('.').pop().toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 2px;">${file.name}</div>
                                                            <div style="font-size: 0.85rem; color: #6b7280;">上传时间: ${file.uploadTime || '未知'}</div>
                                                        </div>
                                                    </div>
                                                    <button onclick="downloadProjectFile('${project.id}', ${index})" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: background 0.3s;">📥 下载</button>
                                                </div>
                                            `).join('') : 
                                            '<div style="text-align: center; color: #9ca3af; padding: 30px; font-style: italic;">📋 暂无上传文件</div>'
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧操作面板 -->
                            <div>
                                <div style="background: #f8fafc; border-radius: 15px; padding: 25px; border: 1px solid #e2e8f0;">
                                    <h3 style="color: #1f2937; font-size: 1.2rem; font-weight: 600; margin-bottom: 20px; text-align: center;">⚙️ 管理操作</h3>
                                    
                                    <div style="space-y: 15px;">
                                        <button onclick="editProject('${project.id}')" style="width: 100%; background: #667eea; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-bottom: 10px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            ✏️ 编辑项目
                                        </button>
                                        
                                        <button onclick="changeProjectStatus('${project.id}')" style="width: 100%; background: #059669; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-bottom: 10px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            🔄 更改状态
                                        </button>
                                        
                                        <button onclick="addProjectComment('${project.id}')" style="width: 100%; background: #7c3aed; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-bottom: 10px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            💬 添加备注
                                        </button>
                                        
                                        <button onclick="exportProjectData('${project.id}')" style="width: 100%; background: #0891b2; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-bottom: 15px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            📊 导出数据
                                        </button>
                                        
                                        <hr style="border: none; height: 1px; background: #e2e8f0; margin: 20px 0;">
                                        
                                        <button onclick="deleteProject('${project.id}')" style="width: 100%; background: #dc2626; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                            🗑️ 删除项目
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 项目统计信息 -->
                                <div style="background: #f0f9ff; border-radius: 15px; padding: 20px; margin-top: 20px; border: 1px solid #bae6fd;">
                                    <h4 style="color: #0c4a6e; font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; text-align: center;">📈 项目统计</h4>
                                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #0369a1;">文件数量:</span>
                                            <strong style="color: #0c4a6e;">${project.files ? project.files.length : 0}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #0369a1;">需求数量:</span>
                                            <strong style="color: #0c4a6e;">${project.needs ? project.needs.length : 0}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #0369a1;">申请天数:</span>
                                            <strong style="color: #0c4a6e;">${calculateDaysSinceSubmit(project.submitTime)}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.setAttribute('data-modal', 'project-details');
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 点击背景关闭模态框
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function editProject(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                alert('项目不存在');
                return;
            }
            
            // 关闭详情模态框
            const detailsModal = document.querySelector('[data-modal="project-details"]');
            if (detailsModal) {
                detailsModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 2000; overflow-y: auto;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 15px; 
                max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 0; border-radius: 15px; overflow: hidden;">
                    <!-- 编辑头部 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="font-size: 1.6rem; font-weight: 700; margin-bottom: 8px;">✏️ 编辑项目</h2>
                                <p style="opacity: 0.9; font-size: 1rem;">项目ID: ${project.id}</p>
                            </div>
                            <button onclick="this.closest('[data-modal]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                    </div>
                    
                    <!-- 编辑表单 -->
                    <div style="padding: 30px;">
                        <form id="editProjectForm" onsubmit="saveProjectChanges(event, '${project.id}')">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">项目名称 *</label>
                                    <input type="text" id="editProjectName" value="${project.name}" required 
                                        style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; outline: none;" 
                                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">创始人 *</label>
                                    <input type="text" id="editProjectFounder" value="${project.founder}" required
                                        style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; outline: none;"
                                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">项目类别 *</label>
                                    <select id="editProjectCategory" required
                                        style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: white; transition: border-color 0.3s; outline: none;"
                                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                                        <option value="">请选择类别</option>
                                        <option value="AI技术" ${project.category === 'AI技术' ? 'selected' : ''}>AI技术</option>
                                        <option value="区块链" ${project.category === '区块链' ? 'selected' : ''}>区块链</option>
                                        <option value="金融科技" ${project.category === '金融科技' ? 'selected' : ''}>金融科技</option>
                                        <option value="企业服务" ${project.category === '企业服务' ? 'selected' : ''}>企业服务</option>
                                        <option value="消费电子" ${project.category === '消费电子' ? 'selected' : ''}>消费电子</option>
                                        <option value="医疗健康" ${project.category === '医疗健康' ? 'selected' : ''}>医疗健康</option>
                                        <option value="教育科技" ${project.category === '教育科技' ? 'selected' : ''}>教育科技</option>
                                        <option value="其他" ${project.category === '其他' ? 'selected' : ''}>其他</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">项目状态 *</label>
                                    <select id="editProjectStatus" required
                                        style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: white; transition: border-color 0.3s; outline: none;"
                                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">
                                        <option value="申请中" ${project.status === '申请中' ? 'selected' : ''}>⏳ 申请中</option>
                                        <option value="已通过" ${project.status === '已通过' ? 'selected' : ''}>✅ 已通过</option>
                                        <option value="已拒绝" ${project.status === '已拒绝' ? 'selected' : ''}>❌ 已拒绝</option>
                                        <option value="进行中" ${project.status === '进行中' ? 'selected' : ''}>🚀 进行中</option>
                                        <option value="已完成" ${project.status === '已完成' ? 'selected' : ''}>🎯 已完成</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">项目描述</label>
                                <textarea id="editProjectDescription" rows="4" placeholder="请详细描述项目内容、目标、优势等..."
                                    style="width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; line-height: 1.5; resize: vertical; transition: border-color 0.3s; outline: none;"
                                    onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'">${project.description || ''}</textarea>
                            </div>
                            
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">需求清单</label>
                                <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                                    <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                                        <input type="text" id="newNeedInput" placeholder="添加新需求..." 
                                            style="flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; outline: none;"
                                            onkeypress="if(event.key==='Enter'){event.preventDefault();addProjectNeed();}">
                                        <button type="button" onclick="addProjectNeed()" 
                                            style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">+ 添加</button>
                                    </div>
                                    <div id="editProjectNeeds" style="display: flex; flex-wrap: wrap; gap: 8px; min-height: 40px;">
                                        ${(project.needs || []).map((need, index) => `
                                            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                                                ${need}
                                                <button type="button" onclick="removeProjectNeed(${index})" style="background: rgba(255,255,255,0.3); border: none; color: white; width: 18px; height: 18px; border-radius: 50%; cursor: pointer; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; line-height: 1;">×</button>
                                            </span>
                                        `).join('')}
                                        ${(!project.needs || project.needs.length === 0) ? '<span style="color: #9ca3af; font-style: italic; padding: 8px 0;">暂无需求，点击上方添加...</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <button type="button" onclick="this.closest('[data-modal]').remove()" 
                                    style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">取消</button>
                                <button type="submit" id="saveProjectBtn"
                                    style="background: #059669; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    💾 保存更改
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            modal.setAttribute('data-modal', 'edit-project');
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 存储原始需求数据以便编辑
            window.editingProjectNeeds = [...(project.needs || [])];
            
            // 点击背景关闭模态框
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 工具函数
        function formatCurrency(amount) {
            if (amount >= 1000000) {
                return '$' + (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return '$' + (amount / 1000).toFixed(1) + 'K';
            }
            return '$' + amount.toLocaleString();
        }

        function formatStage(stage) {
            const stages = {
                'idea': '创意阶段',
                'seed': '种子轮',
                'series-a': 'A轮',
                'series-b': 'B轮',
                'series-c': 'C轮',
                'ipo': 'IPO'
            };
            return stages[stage] || stage;
        }

        function formatStatus(status) {
            const statuses = {
                'active': '活跃',
                'pending': '待审核',
                'completed': '已完成',
                'paused': '暂停',
                'rejected': '已拒绝'
            };
            return statuses[status] || status;
        }

        function getStatusClass(status) {
            const classes = {
                'active': 'status-active',
                'pending': 'status-pending',
                'completed': 'status-active',
                'paused': 'status-pending',
                'rejected': 'status-inactive'
            };
            return classes[status] || 'status-pending';
        }

        function formatDateTime(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                return '无效日期';
            }
        }

        // 用户管理相关函数
        let usersData = [];
        let filteredUsersData = [];

        async function loadUsersData() {
            try {
                console.log('加载用户数据...');
                
                // 获取用户统计
                const statsResponse = await fetch('/api/users?action=stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    console.log('用户统计数据:', stats);
                    updateUserStats(stats);
                }
                
                // 获取用户列表
                const listResponse = await fetch('/api/users?action=list');
                if (listResponse.ok) {
                    const users = await listResponse.json();
                    console.log('用户列表:', users);
                    usersData = Array.isArray(users) ? users : [];
                    filteredUsersData = [...usersData];
                    renderUsersTable();
                }
                
            } catch (error) {
                console.error('加载用户数据失败:', error);
                document.getElementById('usersTableContainer').innerHTML = `
                    <div class="error-message">
                        <div style="color: #dc3545; text-align: center; padding: 20px;">
                            <div>❌ 加载用户数据失败</div>
                            <div style="font-size: 14px; margin-top: 5px;">请检查网络连接后重试</div>
                        </div>
                    </div>
                `;
            }
        }

        function updateUserStats(stats) {
            document.getElementById('totalUsersCount').textContent = stats.totalUsers || 0;
            document.getElementById('activeUsersCount').textContent = stats.activeUsers || 0;
            document.getElementById('todayRegistrations').textContent = stats.todayRegistrations || 0;
            document.getElementById('emailUsersCount').textContent = stats.providerDistribution?.email || 0;
        }

        function renderUsersTable() {
            const container = document.getElementById('usersTableContainer');
            
            if (filteredUsersData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👤</div>
                        <h3>暂无用户数据</h3>
                        <p>还没有用户注册</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sortable-header" onclick="sortUsers('email')">用户信息</th>
                                <th class="sortable-header" onclick="sortUsers('provider')">登录方式</th>
                                <th class="sortable-header" onclick="sortUsers('isSubscriber')">订阅状态</th>
                                <th class="sortable-header" onclick="sortUsers('location')">地理位置</th>
                                <th class="sortable-header" onclick="sortUsers('createdAt')">注册时间</th>
                                <th class="sortable-header" onclick="sortUsers('lastLoginAt')">最后登录</th>
                                <th class="sortable-header" onclick="sortUsers('isActive')">状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredUsersData.map(user => `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="${user.avatar}" alt="头像" style="width: 32px; height: 32px; border-radius: 50%; background: #f0f0f0;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email)}&background=FA8C32&color=fff'">
                                            <div>
                                                <div style="font-weight: 500;">${user.name || '未设置'}</div>
                                                <div style="font-size: 0.85rem; color: #666;">${user.email}</div>
                                                <div style="font-size: 0.75rem; color: #999;">${user.id}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            ${getProviderIcon(user.provider)}
                                            <span>${getProviderName(user.provider)}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="subscription-badge ${user.isSubscriber ? 'subscribed' : 'not-subscribed'}">
                                            ${user.isSubscriber ? '✅ 已订阅' : '❌ 未订阅'}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span class="location-icon">${getLocationIcon(user.location)}</span>
                                            <span class="location-text">${user.location || '未知'}</span>
                                        </div>
                                    </td>
                                    <td class="date-cell">${formatDateTime(user.createdAt)}</td>
                                    <td class="date-cell">${formatDateTime(user.lastLoginAt)}</td>
                                    <td>
                                        <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                                            ${user.isActive ? '活跃' : '禁用'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-small btn-info" onclick="viewUserDetails('${user.id}')" title="查看详情">
                                                👁️
                                            </button>
                                            <button class="btn-small ${user.isActive ? 'btn-danger' : 'status-active'}" 
                                                    onclick="toggleUserStatus('${user.id}', ${!user.isActive})" 
                                                    title="${user.isActive ? '禁用用户' : '激活用户'}">
                                                ${user.isActive ? '🚫' : '✅'}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="table-info">
                    <span>共 ${filteredUsersData.length} 个用户 (总计 ${usersData.length} 个)</span>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        // 用户表格排序功能
        let usersSortField = null;
        let usersSortDirection = 'asc';

        function sortUsers(field) {
            // 更新排序状态
            if (usersSortField === field) {
                usersSortDirection = usersSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                usersSortField = field;
                usersSortDirection = 'asc';
            }

            // 执行排序
            filteredUsersData.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'email':
                        valueA = a.email.toLowerCase();
                        valueB = b.email.toLowerCase();
                        break;
                    case 'provider':
                        valueA = a.provider;
                        valueB = b.provider;
                        break;
                    case 'isSubscriber':
                        valueA = a.isSubscriber ? 1 : 0;
                        valueB = b.isSubscriber ? 1 : 0;
                        break;
                    case 'location':
                        valueA = (a.location || '').toLowerCase();
                        valueB = (b.location || '').toLowerCase();
                        break;
                    case 'createdAt':
                    case 'lastLoginAt':
                        valueA = new Date(a[field]).getTime();
                        valueB = new Date(b[field]).getTime();
                        break;
                    case 'isActive':
                        valueA = a.isActive ? 1 : 0;
                        valueB = b.isActive ? 1 : 0;
                        break;
                    default:
                        return 0;
                }

                if (valueA < valueB) return usersSortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return usersSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // 重新渲染表格
            renderUsersTable();

            // 更新表头样式
            updateUsersSortHeaders();
        }

        function updateUsersSortHeaders() {
            // 清除所有排序样式
            const headers = document.querySelectorAll('#users-module .sortable-header');
            headers.forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });

            // 添加当前排序样式
            if (usersSortField) {
                const fieldMap = {
                    'email': 0,
                    'provider': 1,
                    'isSubscriber': 2,
                    'location': 3,
                    'createdAt': 4,
                    'lastLoginAt': 5,
                    'isActive': 6
                };
                
                const headerIndex = fieldMap[usersSortField];
                if (headerIndex !== undefined) {
                    const header = headers[headerIndex];
                    if (header) {
                        header.classList.add(usersSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                }
            }
        }

        function filterUsers() {
            const providerFilter = document.getElementById('userProviderFilter').value;
            const subscriptionFilter = document.getElementById('userSubscriptionFilter').value;
            const locationFilter = document.getElementById('userLocationFilter').value;
            const statusFilter = document.getElementById('userStatusFilter').value;
            const searchInput = document.getElementById('userSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('userDateFilter').value;
            
            filteredUsersData = usersData.filter(user => {
                const matchesProvider = !providerFilter || user.provider === providerFilter;
                const matchesSubscription = !subscriptionFilter || user.isSubscriber.toString() === subscriptionFilter;
                const matchesLocation = !locationFilter || user.location === locationFilter;
                const matchesStatus = !statusFilter || user.isActive.toString() === statusFilter;
                const matchesSearch = !searchInput || 
                    user.email.toLowerCase().includes(searchInput) ||
                    user.name?.toLowerCase().includes(searchInput) ||
                    user.id.toLowerCase().includes(searchInput);
                const matchesDate = !dateFilter || user.createdAt.startsWith(dateFilter);
                
                return matchesProvider && matchesSubscription && matchesLocation && matchesStatus && matchesSearch && matchesDate;
            });
            
            renderUsersTable();
        }

        function refreshUsers() {
            loadUsersData();
        }

        function exportUsers() {
            try {
                const csvContent = [
                    ['用户ID', '邮箱地址', '用户名', '登录方式', '订阅状态', '地理位置', '注册时间', '最后登录', '状态'],
                    ...filteredUsersData.map(user => [
                        user.id,
                        user.email,
                        user.name || '',
                        user.provider,
                        user.isSubscriber ? '已订阅' : '未订阅',
                        user.location || '未知',
                        user.createdAt,
                        user.lastLoginAt,
                        user.isActive ? '活跃' : '禁用'
                    ])
                ].map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `SVTR用户数据_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                console.log('用户数据导出成功');
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败，请重试');
            }
        }

        function viewUserDetails(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            const detailsHTML = `
                <div style="text-align: left;">
                    <h3 style="margin-bottom: 20px;">用户详情</h3>
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <img src="${user.avatar}" alt="头像" style="width: 60px; height: 60px; border-radius: 50%;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email)}&background=FA8C32&color=fff'">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: 600;">${user.name || '未设置姓名'}</div>
                                <div style="color: #666; margin-top: 5px;">${user.email}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center;">
                            <label style="font-weight: 500;">用户ID:</label>
                            <span style="font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 4px;">${user.id}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center;">
                            <label style="font-weight: 500;">登录方式:</label>
                            <span style="display: flex; align-items: center; gap: 8px;">
                                ${getProviderIcon(user.provider)}
                                ${getProviderName(user.provider)}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center;">
                            <label style="font-weight: 500;">注册时间:</label>
                            <span>${formatDateTime(user.createdAt)}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center;">
                            <label style="font-weight: 500;">最后登录:</label>
                            <span>${formatDateTime(user.lastLoginAt)}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center;">
                            <label style="font-weight: 500;">订阅状态:</label>
                            <span class="subscription-badge ${user.isSubscriber ? 'subscribed' : 'not-subscribed'}">
                                ${user.isSubscriber ? '✅ 已订阅' : '❌ 未订阅'}
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center;">
                            <label style="font-weight: 500;">地理位置:</label>
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <span>${getLocationIcon(user.location)}</span>
                                <span>${user.location || '未知'}</span>
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center;">
                            <label style="font-weight: 500;">账户状态:</label>
                            <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                                ${user.isActive ? '✅ 活跃' : '🚫 禁用'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('用户详情', detailsHTML);
        }

        async function toggleUserStatus(userId, newStatus) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            const action = newStatus ? '激活' : '禁用';
            if (!confirm(`确定要${action}用户 ${user.email} 吗？`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update_status',
                        userId: userId,
                        isActive: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`用户状态已${action}`);
                    loadUsersData(); // 重新加载数据
                } else {
                    alert(`${action}失败：` + (result.message || '未知错误'));
                }
            } catch (error) {
                alert(`${action}失败：` + error.message);
            }
        }

        function getProviderIcon(provider) {
            const icons = {
                'email': '📧',
                'google': '🔍',
                'github': '🐙'
            };
            return icons[provider] || '❓';
        }

        function getProviderName(provider) {
            const names = {
                'email': '邮箱',
                'google': 'Google',
                'github': 'GitHub'
            };
            return names[provider] || provider;
        }

        function getLocationIcon(location) {
            const icons = {
                '中国': '🇨🇳',
                '全球': '🌍',
                '美国': '🇺🇸',
                '本地环境': '💻',
                '平台内部': '🏠',
                '测试环境': '🧪',
                '待定位': '📍',
                '其他地区': '🌐',
                '未知': '❓'
            };
            return icons[location] || '🌐';
        }

        // 简单的模态框函数
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;
            
            modalContent.innerHTML = `
                ${content}
                <div style="text-align: center; margin-top: 25px;">
                    <button onclick="this.closest('[data-modal]').remove()" class="btn-primary">关闭</button>
                </div>
            `;
            
            modal.setAttribute('data-modal', 'true');
            modal.appendChild(modalContent);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // 显示项目文件详情
        function showProjectFiles(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project || !project.files || project.files.length === 0) {
                alert('该项目没有上传任何文件');
                return;
            }

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 2000; overflow-y: auto;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; padding: 30px; border-radius: 15px; 
                max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;
            
            const filesListHTML = project.files.map((file, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #333; margin-bottom: 5px;">
                            📄 ${file.name}
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">
                            <span>类型: ${file.type}</span> | 
                            <span>大小: ${formatFileSize(file.size)}</span>
                            ${file.uploadedAt ? `| <span>上传: ${formatDateTime(file.uploadedAt)}</span>` : ''}
                        </div>
                    </div>
                    <div style="font-size: 1.2rem; color: #ccc;">
                        ${getFileIcon(file.type)}
                    </div>
                </div>
            `).join('');
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: #333;">📎 项目附件</h3>
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>${project.name}</strong>
                    <div style="font-size: 0.9rem; color: #666;">共 ${project.files.length} 个文件</div>
                </div>
                ${filesListHTML}
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn-secondary">关闭</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }

        // 根据文件类型返回图标
        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) return '📕';
            if (fileType.includes('doc')) return '📘';
            if (fileType.includes('image')) return '🖼️';
            if (fileType.includes('text')) return '📄';
            if (fileType.includes('presentation') || fileType.includes('ppt')) return '📊';
            return '📁';
        }
        // 项目管理辅助函数
        
        // 计算申请天数
        function calculateDaysSinceSubmit(submitTime) {
            try {
                const submitDate = new Date(submitTime);
                const currentDate = new Date();
                const diffTime = Math.abs(currentDate - submitDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays + ' 天';
            } catch (error) {
                return '未知';
            }
        }
        
        // 添加项目需求
        function addProjectNeed() {
            const input = document.getElementById('newNeedInput');
            const need = input.value.trim();
            
            if (!need) {
                alert('请输入需求内容');
                return;
            }
            
            if (window.editingProjectNeeds.includes(need)) {
                alert('该需求已存在');
                return;
            }
            
            window.editingProjectNeeds.push(need);
            input.value = '';
            renderProjectNeeds();
        }
        
        // 移除项目需求
        function removeProjectNeed(index) {
            window.editingProjectNeeds.splice(index, 1);
            renderProjectNeeds();
        }
        
        // 渲染项目需求
        function renderProjectNeeds() {
            const container = document.getElementById('editProjectNeeds');
            if (!container) return;
            
            if (window.editingProjectNeeds.length === 0) {
                container.innerHTML = '<span style="color: #9ca3af; font-style: italic; padding: 8px 0;">暂无需求，点击上方添加...</span>';
                return;
            }
            
            container.innerHTML = window.editingProjectNeeds.map((need, index) => `
                <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                    ${need}
                    <button type="button" onclick="removeProjectNeed(${index})" style="background: rgba(255,255,255,0.3); border: none; color: white; width: 18px; height: 18px; border-radius: 50%; cursor: pointer; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; line-height: 1;">×</button>
                </span>
            `).join('');
        }
        
        // 保存项目更改
        async function saveProjectChanges(event, projectId) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('saveProjectBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '💾 保存中...';
            
            try {
                const formData = {
                    id: projectId,
                    name: document.getElementById('editProjectName').value.trim(),
                    founder: document.getElementById('editProjectFounder').value.trim(),
                    category: document.getElementById('editProjectCategory').value,
                    status: document.getElementById('editProjectStatus').value,
                    description: document.getElementById('editProjectDescription').value.trim(),
                    needs: window.editingProjectNeeds || []
                };
                
                // 验证必填字段
                if (!formData.name || !formData.founder || !formData.category || !formData.status) {
                    alert('请填写所有必填字段');
                    return;
                }
                
                // 发送更新请求
                const response = await fetch('/api/projects', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 更新本地数据
                    const projectIndex = projectsData.findIndex(p => p.id === projectId);
                    if (projectIndex !== -1) {
                        projectsData[projectIndex] = { ...projectsData[projectIndex], ...formData };
                    }
                    
                    // 刷新表格
                    filterProjects();
                    
                    // 关闭模态框
                    document.querySelector('[data-modal="edit-project"]').remove();
                    
                    // 显示成功消息
                    showNotification('项目更新成功！', 'success');
                } else {
                    alert('更新失败: ' + (result.message || '未知错误'));
                }
                
            } catch (error) {
                console.error('更新项目失败:', error);
                alert('更新失败: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }
        
        // 更改项目状态
        function changeProjectStatus(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                alert('项目不存在');
                return;
            }
            
            const statusOptions = [
                { value: '申请中', label: '⏳ 申请中', color: '#d97706' },
                { value: '已通过', label: '✅ 已通过', color: '#059669' },
                { value: '已拒绝', label: '❌ 已拒绝', color: '#dc2626' },
                { value: '进行中', label: '🚀 进行中', color: '#2563eb' },
                { value: '已完成', label: '🎯 已完成', color: '#7c3aed' }
            ];
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 15px; padding: 30px;
                max-width: 400px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;
            
            modalContent.innerHTML = `
                <div>
                    <h3 style="margin-bottom: 20px; color: #1f2937; font-size: 1.3rem; font-weight: 600; text-align: center;">🔄 更改项目状态</h3>
                    <p style="margin-bottom: 20px; color: #6b7280; text-align: center;">项目: ${project.name}</p>
                    <p style="margin-bottom: 20px; color: #6b7280; text-align: center;">当前状态: <strong>${project.status}</strong></p>
                    
                    <div style="display: grid; gap: 10px; margin-bottom: 25px;">
                        ${statusOptions.map(option => `
                            <button onclick="updateProjectStatus('${projectId}', '${option.value}')" 
                                style="width: 100%; padding: 12px; border: 2px solid ${option.value === project.status ? option.color : '#e5e7eb'}; 
                                background: ${option.value === project.status ? option.color : 'white'}; 
                                color: ${option.value === project.status ? 'white' : '#374151'}; 
                                border-radius: 8px; cursor: pointer; font-weight: 600; text-align: left; transition: all 0.3s;">
                                ${option.label}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="this.closest('[data-modal]').remove()" 
                            style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">取消</button>
                    </div>
                </div>
            `;
            
            modal.setAttribute('data-modal', 'change-status');
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 更新项目状态
        async function updateProjectStatus(projectId, newStatus) {
            try {
                const response = await fetch('/api/projects', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: projectId, status: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 更新本地数据
                    const project = projectsData.find(p => p.id === projectId);
                    if (project) {
                        project.status = newStatus;
                    }
                    
                    // 刷新显示
                    filterProjects();
                    
                    // 关闭模态框
                    document.querySelector('[data-modal="change-status"]').remove();
                    
                    // 如果详情模态框打开，也关闭并重新打开以刷新状态显示
                    const detailsModal = document.querySelector('[data-modal="project-details"]');
                    if (detailsModal) {
                        detailsModal.remove();
                        setTimeout(() => viewProjectDetails(projectId), 100);
                    }
                    
                    showNotification('项目状态更新成功！', 'success');
                } else {
                    alert('状态更新失败: ' + (result.message || '未知错误'));
                }
                
            } catch (error) {
                console.error('更新状态失败:', error);
                alert('状态更新失败: ' + error.message);
            }
        }
        
        // 添加项目备注
        function addProjectComment(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                alert('项目不存在');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 2000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white; border-radius: 15px; padding: 30px;
                max-width: 500px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;
            
            modalContent.innerHTML = `
                <div>
                    <h3 style="margin-bottom: 20px; color: #1f2937; font-size: 1.3rem; font-weight: 600; text-align: center;">💬 添加项目备注</h3>
                    <p style="margin-bottom: 15px; color: #6b7280;">项目: <strong>${project.name}</strong></p>
                    
                    <textarea id="commentInput" rows="4" placeholder="请输入备注内容..." 
                        style="width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; line-height: 1.5; resize: vertical; outline: none; margin-bottom: 20px;"
                        onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="this.closest('[data-modal]').remove()" 
                            style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">取消</button>
                        <button onclick="saveProjectComment('${projectId}')"
                            style="background: #7c3aed; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">保存备注</button>
                    </div>
                </div>
            `;
            
            modal.setAttribute('data-modal', 'add-comment');
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 保存项目备注
        async function saveProjectComment(projectId) {
            const comment = document.getElementById('commentInput').value.trim();
            if (!comment) {
                alert('请输入备注内容');
                return;
            }
            
            try {
                const response = await fetch('/api/projects/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        projectId: projectId, 
                        comment: comment,
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.querySelector('[data-modal="add-comment"]').remove();
                    showNotification('备注添加成功！', 'success');
                } else {
                    alert('备注保存失败: ' + (result.message || '未知错误'));
                }
                
            } catch (error) {
                console.error('保存备注失败:', error);
                alert('备注保存失败: ' + error.message);
            }
        }
        
        // 导出项目数据
        function exportProjectData(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                alert('项目不存在');
                return;
            }
            
            const exportData = {
                基本信息: {
                    项目名称: project.name,
                    创始人: project.founder,
                    项目类别: project.category,
                    项目状态: project.status,
                    申请时间: project.submitTime,
                    项目ID: project.id
                },
                项目描述: project.description || '暂无描述',
                需求清单: project.needs || [],
                文件信息: (project.files || []).map(file => ({
                    文件名: file.name,
                    上传时间: file.uploadTime || '未知'
                })),
                统计信息: {
                    文件数量: project.files ? project.files.length : 0,
                    需求数量: project.needs ? project.needs.length : 0,
                    申请天数: calculateDaysSinceSubmit(project.submitTime)
                },
                导出时间: new Date().toLocaleString('zh-CN')
            };
            
            // 创建并下载JSON文件
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `项目数据_${project.name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('项目数据导出成功！', 'success');
        }
        
        // 删除项目
        function deleteProject(projectId) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project) {
                alert('项目不存在');
                return;
            }
            
            const confirmed = confirm(`确定要删除项目"${project.name}"吗？\n\n此操作不可恢复，请谨慎操作！`);
            if (!confirmed) return;
            
            // 二次确认
            const doubleConfirm = confirm(`最后确认：真的要删除项目"${project.name}"吗？\n\n项目ID: ${project.id}\n创始人: ${project.founder}`);
            if (!doubleConfirm) return;
            
            deleteProjectConfirmed(projectId);
        }
        
        // 确认删除项目
        async function deleteProjectConfirmed(projectId) {
            try {
                const response = await fetch('/api/projects', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: projectId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 从本地数据中移除
                    projectsData = projectsData.filter(p => p.id !== projectId);
                    filteredProjectsData = filteredProjectsData.filter(p => p.id !== projectId);
                    
                    // 刷新表格
                    renderProjectsTable();
                    
                    // 关闭详情模态框
                    const detailsModal = document.querySelector('[data-modal="project-details"]');
                    if (detailsModal) {
                        detailsModal.remove();
                    }
                    
                    showNotification('项目删除成功！', 'success');
                } else {
                    alert('删除失败: ' + (result.message || '未知错误'));
                }
                
            } catch (error) {
                console.error('删除项目失败:', error);
                alert('删除失败: ' + error.message);
            }
        }
        
        // 下载项目文件
        async function downloadProjectFile(projectId, fileIndex) {
            const project = projectsData.find(p => p.id === projectId);
            if (!project || !project.files || !project.files[fileIndex]) {
                alert('文件不存在');
                return;
            }
            
            const file = project.files[fileIndex];
            console.log('开始下载文件:', { projectId, fileIndex, fileName: file.name });
            
            try {
                // 显示下载中状态
                showNotification('正在准备下载...', 'info');
                
                // 使用正确的API路径
                const downloadUrl = `/api/projects/${projectId}/files/${fileIndex}`;
                console.log('下载URL:', downloadUrl);
                
                const response = await fetch(downloadUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': '*/*',
                    }
                });
                
                console.log('下载响应状态:', response.status, response.statusText);
                
                if (response.ok) {
                    const blob = await response.blob();
                    console.log('文件blob大小:', blob.size, 'bytes', '类型:', blob.type);
                    
                    // 获取文件名（从响应头或使用默认名称）
                    const contentDisposition = response.headers.get('content-disposition');
                    let fileName = file.name || `项目文件_${fileIndex + 1}`;
                    
                    if (contentDisposition) {
                        const fileNameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (fileNameMatch && fileNameMatch[1]) {
                            fileName = fileNameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // 创建下载链接
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    link.style.display = 'none';
                    
                    // 添加到DOM，点击，然后移除
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 清理URL对象
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 1000);
                    
                    showNotification(`文件 "${fileName}" 下载成功！`, 'success');
                    console.log('文件下载完成:', fileName);
                    
                } else {
                    // 尝试解析错误响应
                    let errorMessage = '文件下载失败';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    
                    console.error('下载失败:', errorMessage);
                    showNotification(errorMessage, 'error');
                }
                
            } catch (error) {
                console.error('下载文件失败:', error);
                showNotification('网络错误，文件下载失败', 'error');
            }
        }
        
        // 显示通知消息
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                success: { bg: '#d1fae5', color: '#065f46', icon: '✅' },
                error: { bg: '#fee2e2', color: '#991b1b', icon: '❌' },
                info: { bg: '#dbeafe', color: '#1e40af', icon: 'ℹ️' }
            };
            const style = colors[type] || colors.info;
            
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 3000;
                background: ${style.bg}; color: ${style.color}; padding: 15px 20px;
                border-radius: 8px; border-left: 4px solid ${style.color};
                box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 300px;
                font-weight: 600; display: flex; align-items: center; gap: 10px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `${style.icon} ${message}`;
            document.body.appendChild(notification);
            
            // 3秒后自动消失
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 添加动画样式
        if (!document.getElementById('notificationStyles')) {
            const style = document.createElement('style');
            style.id = 'notificationStyles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // ================== 用户行为跟踪管理功能 ==================
        let userBehaviorData = [];
        let filteredBehaviorData = [];
        let currentLogsTab = 'realtime';
        let realtimeInterval = null;

        // 切换标签页
        function switchLogsTab(tabId) {
            // 更新标签按钮状态
            document.querySelectorAll('.logs-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            // 更新内容面板
            document.querySelectorAll('.logs-tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');

            currentLogsTab = tabId;

            // 加载对应的数据
            switch (tabId) {
                case 'realtime':
                    startRealtimeMonitoring();
                    break;
                case 'sessions':
                    loadSessionsData();
                    break;
                case 'pages':
                    loadPagesAnalysis();
                    break;
                case 'heatmap':
                    loadHeatmapData();
                    break;
            }
        }

        // 开始实时监控
        function startRealtimeMonitoring() {
            // 清除之前的定时器
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
            }

            // 立即加载一次数据
            loadRealtimeActivities();

            // 每10秒刷新一次实时数据
            realtimeInterval = setInterval(() => {
                loadRealtimeActivities();
            }, 10000);
        }

        // 停止实时监控
        function stopRealtimeMonitoring() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
                realtimeInterval = null;
            }
        }

        // 加载实时活动数据
        async function loadRealtimeActivities() {
            try {
                const container = document.getElementById('realtimeActivities');
                
                // 模拟实时数据（实际应用中从API获取）
                const mockRealtimeData = generateMockRealtimeData();
                
                let activitiesHtml = '';
                mockRealtimeData.forEach(activity => {
                    const timeAgo = getTimeAgo(activity.timestamp);
                    const typeIcon = getActivityIcon(activity.type);
                    const typeLabel = getActivityLabel(activity.type);
                    
                    activitiesHtml += `
                        <div class="realtime-activity" style="padding: 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 12px;">
                            <div class="activity-icon" style="font-size: 18px;">${typeIcon}</div>
                            <div class="activity-content" style="flex: 1;">
                                <div class="activity-title" style="font-weight: 500; margin-bottom: 2px;">
                                    ${typeLabel}: ${activity.details}
                                </div>
                                <div class="activity-meta" style="color: #666; font-size: 12px;">
                                    用户: ${activity.userId} • 页面: ${activity.page} • ${timeAgo}
                                </div>
                            </div>
                            <div class="activity-status" style="padding: 2px 8px; background: #e8f5e8; color: #2e7d2e; border-radius: 12px; font-size: 11px;">
                                实时
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = activitiesHtml || '<div class="empty-state" style="text-align: center; padding: 40px; color: #666;"><p>暂无实时活动数据</p></div>';
                
                // 更新在线用户数
                document.getElementById('realtimeCount').textContent = Math.floor(Math.random() * 25) + 5;

            } catch (error) {
                console.error('加载实时活动数据失败:', error);
                document.getElementById('realtimeActivities').innerHTML = 
                    '<div class="error-state" style="text-align: center; padding: 40px; color: #dc3545;"><p>加载实时数据失败</p></div>';
            }
        }

        // 生成模拟实时数据
        function generateMockRealtimeData() {
            const activities = [];
            const now = Date.now();
            const types = ['page_view', 'click', 'form_submit', 'link_click', 'scroll_milestone'];
            const pages = ['/', '/pages/ai100.html', '/pages/investment-camp.html', '/pages/content-community.html'];
            const userIds = ['user_001', 'user_002', 'anonymous_123', 'member_456', 'admin_001'];

            for (let i = 0; i < 10; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const page = pages[Math.floor(Math.random() * pages.length)];
                const userId = userIds[Math.floor(Math.random() * userIds.length)];
                
                activities.push({
                    type: type,
                    userId: userId,
                    page: page,
                    timestamp: now - (Math.random() * 300000), // 最近5分钟内
                    details: getActivityDetails(type, page)
                });
            }

            return activities.sort((a, b) => b.timestamp - a.timestamp);
        }

        // 获取活动详情描述
        function getActivityDetails(type, page) {
            const pageNames = {
                '/': '首页',
                '/pages/ai100.html': 'AI100页面',
                '/pages/investment-camp.html': '投资营页面',
                '/pages/content-community.html': '内容社区页面'
            };

            const pageName = pageNames[page] || page;

            switch (type) {
                case 'page_view':
                    return `访问了${pageName}`;
                case 'click':
                    return `在${pageName}进行了点击操作`;
                case 'form_submit':
                    return `在${pageName}提交了表单`;
                case 'link_click':
                    return `在${pageName}点击了链接`;
                case 'scroll_milestone':
                    return `在${pageName}滚动阅读`;
                default:
                    return `在${pageName}执行了操作`;
            }
        }

        // 获取活动图标
        function getActivityIcon(type) {
            const icons = {
                'page_view': '📄',
                'click': '👆',
                'form_submit': '📝',
                'link_click': '🔗',
                'scroll_milestone': '📏'
            };
            return icons[type] || '⚡';
        }

        // 获取活动标签
        function getActivityLabel(type) {
            const labels = {
                'page_view': '页面访问',
                'click': '点击事件',
                'form_submit': '表单提交',
                'link_click': '链接点击',
                'scroll_milestone': '滚动行为'
            };
            return labels[type] || '其他操作';
        }

        // 获取相对时间
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return '刚刚';
            if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前';
            if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前';
            return Math.floor(diff / 86400000) + '天前';
        }

        // 加载会话数据
        async function loadSessionsData() {
            try {
                const container = document.getElementById('sessionsTable');
                
                // 模拟会话数据
                const mockSessions = generateMockSessionsData();
                
                let sessionsHtml = `
                    <div class="table-container">
                        <table class="data-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">会话ID</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">用户</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">开始时间</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">持续时长</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">页面数</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">点击数</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">参与度</th>
                                    <th style="padding: 12px; border: 1px solid #dee2e6; text-align: left;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                mockSessions.forEach(session => {
                    const duration = formatDuration(session.duration);
                    const engagementColor = session.engagement >= 70 ? '#28a745' : session.engagement >= 40 ? '#ffc107' : '#dc3545';
                    
                    sessionsHtml += `
                        <tr style="border-bottom: 1px solid #dee2e6;">
                            <td style="padding: 12px; border: 1px solid #dee2e6;">${session.sessionId.substring(0, 8)}...</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #007bff; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                        ${session.userId.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div style="font-weight: 500;">${session.userId}</div>
                                        <div style="color: #666; font-size: 12px;">${session.userType}</div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">${new Date(session.startTime).toLocaleString()}</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">${duration}</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">${session.pageViews}</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">${session.clicks}</td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 60px; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${session.engagement}%; height: 100%; background: ${engagementColor};"></div>
                                    </div>
                                    <span style="color: ${engagementColor}; font-weight: 500;">${session.engagement}%</span>
                                </div>
                            </td>
                            <td style="padding: 12px; border: 1px solid #dee2e6;">
                                <button onclick="viewSessionDetails('${session.sessionId}')" class="btn btn-sm btn-outline-primary" style="padding: 4px 8px; font-size: 12px;">
                                    查看详情
                                </button>
                            </td>
                        </tr>
                    `;
                });

                sessionsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;

                container.innerHTML = sessionsHtml;

            } catch (error) {
                console.error('加载会话数据失败:', error);
                document.getElementById('sessionsTable').innerHTML = 
                    '<div class="error-state" style="text-align: center; padding: 40px; color: #dc3545;"><p>加载会话数据失败</p></div>';
            }
        }

        // 生成模拟会话数据
        function generateMockSessionsData() {
            const sessions = [];
            const now = Date.now();
            
            for (let i = 0; i < 20; i++) {
                const startTime = now - (Math.random() * 86400000 * 7); // 最近7天内
                const duration = Math.random() * 1800000 + 60000; // 1-30分钟
                const pageViews = Math.floor(Math.random() * 10) + 1;
                const clicks = Math.floor(Math.random() * 50) + 1;
                const engagement = Math.floor(Math.random() * 100);
                
                sessions.push({
                    sessionId: 'session_' + Date.now() + '_' + i,
                    userId: ['用户' + (i + 1), 'anonymous_' + i, 'member_' + i][Math.floor(Math.random() * 3)],
                    userType: ['注册用户', '匿名用户', '高级会员'][Math.floor(Math.random() * 3)],
                    startTime: startTime,
                    duration: duration,
                    pageViews: pageViews,
                    clicks: clicks,
                    engagement: engagement
                });
            }

            return sessions.sort((a, b) => b.startTime - a.startTime);
        }

        // 格式化持续时长
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // 查看会话详情
        function viewSessionDetails(sessionId) {
            alert(`查看会话详情: ${sessionId}\n\n这里将显示用户在该会话中的详细行为路径和操作记录。`);
        }

        // 加载页面分析数据
        async function loadPagesAnalysis() {
            try {
                const container = document.getElementById('pagesAnalysis');
                
                // 模拟页面分析数据
                const mockPagesData = generateMockPagesData();
                
                let pagesHtml = `
                    <div class="pages-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                `;

                mockPagesData.forEach(page => {
                    const bounceRateColor = page.bounceRate > 60 ? '#dc3545' : page.bounceRate > 40 ? '#ffc107' : '#28a745';
                    
                    pagesHtml += `
                        <div class="page-stat-card" style="background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                            <div class="page-header" style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h5 style="margin: 0; font-weight: 600;">${page.title}</h5>
                                    <p style="margin: 2px 0 0; color: #666; font-size: 12px;">${page.path}</p>
                                </div>
                                <div class="page-views" style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: 600; color: #007bff;">${page.views.toLocaleString()}</div>
                                    <div style="font-size: 12px; color: #666;">浏览量</div>
                                </div>
                            </div>
                            
                            <div class="page-metrics" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="metric">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">平均停留时间</div>
                                    <div style="font-size: 16px; font-weight: 500;">${formatDuration(page.avgTime)}</div>
                                </div>
                                <div class="metric">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">跳出率</div>
                                    <div style="font-size: 16px; font-weight: 500; color: ${bounceRateColor};">${page.bounceRate}%</div>
                                </div>
                                <div class="metric">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">独立访客</div>
                                    <div style="font-size: 16px; font-weight: 500;">${page.uniqueVisitors}</div>
                                </div>
                                <div class="metric">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">转化率</div>
                                    <div style="font-size: 16px; font-weight: 500; color: #28a745;">${page.conversionRate}%</div>
                                </div>
                            </div>
                            
                            <div class="page-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                <button onclick="viewPageDetails('${page.path}')" class="btn btn-sm btn-outline-primary" style="width: 100%; padding: 6px 12px; font-size: 12px;">
                                    查看详细分析
                                </button>
                            </div>
                        </div>
                    `;
                });

                pagesHtml += `</div>`;

                container.innerHTML = pagesHtml;

            } catch (error) {
                console.error('加载页面分析数据失败:', error);
                document.getElementById('pagesAnalysis').innerHTML = 
                    '<div class="error-state" style="text-align: center; padding: 40px; color: #dc3545;"><p>加载页面数据失败</p></div>';
            }
        }

        // 生成模拟页面数据
        function generateMockPagesData() {
            return [
                {
                    path: '/',
                    title: '首页',
                    views: 12580,
                    uniqueVisitors: 8943,
                    avgTime: 185000, // 3分5秒
                    bounceRate: 35,
                    conversionRate: 8.5
                },
                {
                    path: '/pages/ai100.html',
                    title: 'AI100 - 全球AI企业榜单',
                    views: 8432,
                    uniqueVisitors: 6221,
                    avgTime: 340000, // 5分40秒
                    bounceRate: 28,
                    conversionRate: 12.3
                },
                {
                    path: '/pages/investment-camp.html',
                    title: 'SVTR投资营',
                    views: 5671,
                    uniqueVisitors: 4103,
                    avgTime: 260000, // 4分20秒
                    bounceRate: 42,
                    conversionRate: 15.7
                },
                {
                    path: '/pages/content-community.html',
                    title: '内容社区',
                    views: 3254,
                    uniqueVisitors: 2187,
                    avgTime: 420000, // 7分钟
                    bounceRate: 25,
                    conversionRate: 9.8
                }
            ];
        }

        // 查看页面详情
        function viewPageDetails(pagePath) {
            alert(`查看页面详细分析: ${pagePath}\n\n这里将显示该页面的详细访问数据、用户行为流和转化漏斗。`);
        }

        // 加载热力图数据
        function loadHeatmapData() {
            const pageSelect = document.getElementById('heatmapPageSelect');
            const selectedPage = pageSelect.value;
            const container = document.getElementById('heatmapVisualization');
            
            if (!selectedPage) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 15px;">🔥</div>
                        <h4>选择页面查看热力图</h4>
                        <p>选择上方的页面来查看用户点击热力图分析</p>
                    </div>
                `;
                return;
            }

            // 模拟热力图数据
            const mockHeatmapData = generateMockHeatmapData();
            
            let heatmapHtml = `
                <div class="heatmap-container" style="position: relative; background: #f8f9fa; border-radius: 8px; padding: 20px; min-height: 400px;">
                    <div class="heatmap-legend" style="position: absolute; top: 20px; right: 20px; background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px;">点击强度</div>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 10px;">低</span>
                            <div style="width: 80px; height: 8px; background: linear-gradient(to right, #4CAF50, #FFEB3B, #FF9800, #F44336); border-radius: 4px;"></div>
                            <span style="font-size: 10px;">高</span>
                        </div>
                    </div>
                    
                    <div class="heatmap-title" style="margin-bottom: 20px;">
                        <h5 style="margin: 0;">${pageSelect.options[pageSelect.selectedIndex].text} - 点击热力图</h5>
                        <p style="margin: 4px 0 0; color: #666; font-size: 12px;">基于最近7天的用户点击数据生成</p>
                    </div>
                    
                    <div class="heatmap-visualization" style="position: relative; background: white; border-radius: 6px; padding: 20px; min-height: 300px;">
            `;

            // 添加模拟热点
            mockHeatmapData.forEach(point => {
                const intensity = Math.min(point.clicks / 100, 1); // 归一化强度
                const color = getHeatmapColor(intensity);
                const size = Math.max(20 + intensity * 40, 20);
                
                heatmapHtml += `
                    <div class="heatmap-point" style="
                        position: absolute;
                        left: ${point.x}px;
                        top: ${point.y}px;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        border-radius: 50%;
                        opacity: 0.7;
                        transform: translate(-50%, -50%);
                        cursor: pointer;
                    " title="点击次数: ${point.clicks}" onclick="showHeatmapDetail(${point.x}, ${point.y}, ${point.clicks})"></div>
                `;
            });

            heatmapHtml += `
                        <div class="heatmap-placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: #999; border: 2px dashed #ddd; border-radius: 6px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">📊</div>
                            <div style="font-size: 16px; font-weight: 500; margin-bottom: 4px;">${pageSelect.options[pageSelect.selectedIndex].text}</div>
                            <div style="font-size: 12px;">页面结构和热点分布图</div>
                        </div>
                    </div>
                    
                    <div class="heatmap-stats" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div class="stat-item" style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #007bff;">${mockHeatmapData.reduce((sum, p) => sum + p.clicks, 0)}</div>
                            <div style="font-size: 12px; color: #666;">总点击数</div>
                        </div>
                        <div class="stat-item" style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #28a745;">${mockHeatmapData.length}</div>
                            <div style="font-size: 12px; color: #666;">热点区域</div>
                        </div>
                        <div class="stat-item" style="background: white; padding: 12px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #ffc107;">${Math.max(...mockHeatmapData.map(p => p.clicks))}</div>
                            <div style="font-size: 12px; color: #666;">最高点击</div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = heatmapHtml;
        }

        // 生成模拟热力图数据
        function generateMockHeatmapData() {
            const points = [];
            for (let i = 0; i < 15; i++) {
                points.push({
                    x: Math.random() * 600 + 50,
                    y: Math.random() * 400 + 50,
                    clicks: Math.floor(Math.random() * 500) + 10
                });
            }
            return points;
        }

        // 获取热力图颜色
        function getHeatmapColor(intensity) {
            const colors = [
                'rgba(76, 175, 80, 0.6)',   // 绿色 - 低
                'rgba(255, 235, 59, 0.6)',  // 黄色 - 中低
                'rgba(255, 152, 0, 0.6)',   // 橙色 - 中高
                'rgba(244, 67, 54, 0.6)'    // 红色 - 高
            ];
            
            const index = Math.floor(intensity * (colors.length - 1));
            return colors[Math.min(index, colors.length - 1)];
        }

        // 显示热力图详情
        function showHeatmapDetail(x, y, clicks) {
            alert(`热点详情:\n坐标: (${x}, ${y})\n点击次数: ${clicks}\n\n这里可以显示该热点区域的详细分析数据。`);
        }

        // 过滤用户行为日志
        function filterUserBehaviorLogs() {
            const userTypeFilter = document.getElementById('userTypeFilter').value;
            const behaviorTypeFilter = document.getElementById('behaviorTypeFilter').value;
            const timeRangeFilter = document.getElementById('timeRangeFilter').value;
            const userSearchInput = document.getElementById('userSearchInput').value.toLowerCase();
            
            // 处理自定义时间范围显示
            const customTimeRange = document.getElementById('customTimeRange');
            if (timeRangeFilter === 'custom') {
                customTimeRange.style.display = 'grid';
            } else {
                customTimeRange.style.display = 'none';
            }
            
            // 这里应该根据过滤条件重新加载数据
            console.log('过滤条件:', {
                userType: userTypeFilter,
                behaviorType: behaviorTypeFilter,
                timeRange: timeRangeFilter,
                searchTerm: userSearchInput
            });
            
            // 重新加载当前标签页的数据
            switch (currentLogsTab) {
                case 'realtime':
                    loadRealtimeActivities();
                    break;
                case 'sessions':
                    loadSessionsData();
                    break;
                case 'pages':
                    loadPagesAnalysis();
                    break;
            }
        }

        // 刷新用户行为数据
        function refreshUserBehaviorData() {
            // 显示加载状态
            const containers = ['realtimeActivities', 'sessionsTable', 'pagesAnalysis', 'heatmapVisualization'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="loading-state" style="text-align: center; padding: 40px; color: #666;">
                            <div class="loading-spinner" style="margin: 0 auto 15px; width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p>正在刷新数据...</p>
                        </div>
                    `;
                }
            });

            // 更新统计概览
            setTimeout(() => {
                document.getElementById('todayActiveUsers').textContent = Math.floor(Math.random() * 500) + 200;
                document.getElementById('todayPageViews').textContent = (Math.floor(Math.random() * 5000) + 2000).toLocaleString();
                document.getElementById('avgSessionTime').textContent = Math.floor(Math.random() * 5) + 3 + ':' + (Math.floor(Math.random() * 60)).toString().padStart(2, '0');
                document.getElementById('engagementRate').textContent = Math.floor(Math.random() * 30) + 60 + '%';

                // 重新加载当前标签页数据
                switch (currentLogsTab) {
                    case 'realtime':
                        loadRealtimeActivities();
                        break;
                    case 'sessions':
                        loadSessionsData();
                        break;
                    case 'pages':
                        loadPagesAnalysis();
                        break;
                    case 'heatmap':
                        loadHeatmapData();
                        break;
                }
            }, 1500);
        }

        // 导出用户行为数据
        function exportUserBehaviorData() {
            const today = new Date().toISOString().split('T')[0];
            const filename = `SVTR用户行为报告_${today}.csv`;
            
            // 模拟导出数据
            const csvContent = `
用户行为分析报告,${today}
,
统计概览,
今日活跃用户,${document.getElementById('todayActiveUsers').textContent}
今日页面浏览,${document.getElementById('todayPageViews').textContent}
平均停留时间,${document.getElementById('avgSessionTime').textContent}
用户参与度,${document.getElementById('engagementRate').textContent}
,
页面分析,
页面,浏览量,独立访客,平均停留时间,跳出率,转化率
首页,12580,8943,3:05,35%,8.5%
AI100页面,8432,6221,5:40,28%,12.3%
投资营页面,5671,4103,4:20,42%,15.7%
内容社区页面,3254,2187,7:00,25%,9.8%
            `.trim();

            // 创建并下载文件
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // 显示成功消息
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                padding: 12px 20px; border-radius: 6px; z-index: 10000; animation: slideIn 0.3s ease;
            `;
            toast.textContent = `📊 用户行为报告已导出: ${filename}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 监听模块切换，在切换到操作日志模块时初始化数据
        const originalShowModule = showModule;
        showModule = function(moduleId) {
            originalShowModule(moduleId);
            
            if (moduleId === 'logs') {
                // 初始化操作日志模块
                setTimeout(() => {
                    refreshUserBehaviorData();
                    startRealtimeMonitoring();
                }, 500);
            } else if (currentModule === 'logs' && moduleId !== 'logs') {
                // 离开操作日志模块时停止实时监控
                stopRealtimeMonitoring();
            }
        };
        
    </script>
</body>
</html>