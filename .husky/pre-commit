#!/bin/sh
# Pre-commit hook - æ­£åˆ™è¡¨è¾¾å¼nullå®‰å…¨æ£€æŸ¥
# åˆ›å»ºæ—¥æœŸ: 2025-10-06
# ç›®çš„: é˜²æ­¢ä¸å®‰å…¨çš„match()è°ƒç”¨è¿›å…¥ä»£ç åº“

. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” æ‰§è¡Œpre-commitæ£€æŸ¥..."

# 1. æ£€æŸ¥JavaScriptæ–‡ä»¶ä¸­çš„ä¸å®‰å…¨matchè°ƒç”¨
echo "ğŸ“ æ£€æŸ¥æ­£åˆ™è¡¨è¾¾å¼nullå®‰å…¨..."

FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts)x?$')

if [ -n "$FILES" ]; then
  # æŸ¥æ‰¾å¯èƒ½ä¸å®‰å…¨çš„matchè°ƒç”¨ (ç›´æ¥è®¿é—®match[n]è€Œä¸æ£€æŸ¥null)
  UNSAFE_MATCHES=$(echo "$FILES" | xargs grep -n '\.match(' | grep -v 'if.*match' | grep -v '?\.match' | grep 'match\[')

  if [ -n "$UNSAFE_MATCHES" ]; then
    echo "âŒ å‘ç°å¯èƒ½ä¸å®‰å…¨çš„æ­£åˆ™è¡¨è¾¾å¼matchè°ƒç”¨:"
    echo "$UNSAFE_MATCHES"
    echo ""
    echo "ğŸ’¡ ä¿®å¤å»ºè®®:"
    echo "  é€‰é¡¹1 - ä½¿ç”¨ifæ£€æŸ¥:"
    echo "    const match = str.match(/pattern/);"
    echo "    if (!match || !match[1]) return defaultValue;"
    echo "    const value = match[1];"
    echo ""
    echo "  é€‰é¡¹2 - ä½¿ç”¨Optional Chaining:"
    echo "    const value = str.match(/pattern/)?.[1] ?? defaultValue;"
    echo ""
    echo "ğŸ“– è¯¦è§: docs/post-mortem/2025-10-06-extractstage-null-safety.md"
    exit 1
  fi

  echo "âœ… æ­£åˆ™è¡¨è¾¾å¼nullå®‰å…¨æ£€æŸ¥é€šè¿‡"
fi

# 2. è¿è¡ŒESLint
echo "ğŸ”§ è¿è¡ŒESLint..."
npm run lint --silent

if [ $? -ne 0 ]; then
  echo "âŒ ESLintæ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
  exit 1
fi

echo "âœ… ESLintæ£€æŸ¥é€šè¿‡"

# 3. è¿è¡Œå•å…ƒæµ‹è¯• (å¦‚æœå­˜åœ¨)
if [ -d "tests/unit" ]; then
  echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
  npm run test:unit --silent

  if [ $? -ne 0 ]; then
    echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
    exit 1
  fi

  echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
fi

echo "ğŸ‰ æ‰€æœ‰pre-commitæ£€æŸ¥é€šè¿‡!"
